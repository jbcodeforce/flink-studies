<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://jeromeboyer.net/flink-studies/coding/datastream/ rel=canonical><link href=../table-api/ rel=prev><link href=../udf_sql/ rel=next><link rel=icon href=../../images/logo-blue.drawio.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.2"><title>DataStreams API - Apache and Confluent Flink Studies</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#datastreams-programming-guidances-and-examples class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Apache and Confluent Flink Studies" class="md-header__button md-logo" aria-label="Apache and Confluent Flink Studies" data-md-component=logo> <img src=../../images/flink-header-logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Apache and Confluent Flink Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> DataStreams API </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/flink-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Foundations </a> </li> <li class=md-tabs__item> <a href=../../cookbook/ class=md-tabs__link> Cookbook </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../flink-sql-clients/ class=md-tabs__link> Flink_App_Coding </a> </li> <li class=md-tabs__item> <a href=../../methodology/data_as_a_product/ class=md-tabs__link> Methodology </a> </li> <li class=md-tabs__item> <a href=../../techno/ccloud-flink/ class=md-tabs__link> Related_Technologies </a> </li> <li class=md-tabs__item> <a href=https://jbcodeforce.github.io/eda-studies class=md-tabs__link> EDA </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Apache and Confluent Flink Studies" class="md-nav__button md-logo" aria-label="Apache and Confluent Flink Studies" data-md-component=logo> <img src=../../images/flink-header-logo.svg alt=logo> </a> Apache and Confluent Flink Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/flink-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Foundations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Foundations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/ class=md-nav__link> <span class=md-ellipsis> Flink Key Concepts </span> </a> </li> <li class=md-nav__item> <a href=../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/flink-sql/ class=md-nav__link> <span class=md-ellipsis> Flink SQL concepts </span> </a> </li> <li class=md-nav__item> <a href=../../labs/ class=md-nav__link> <span class=md-ellipsis> Code&Demos </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/agentic_flink/ class=md-nav__link> <span class=md-ellipsis> Agentic applications </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Cookbook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cookbook/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/considerations/ class=md-nav__link> <span class=md-ellipsis> Considerations </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/cluster_mgt/ class=md-nav__link> <span class=md-ellipsis> Cluster management </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/job_lifecycle/ class=md-nav__link> <span class=md-ellipsis> Job Lifecycle </span> </a> </li> <li class=md-nav__item> <a href=../k8s-deploy/ class=md-nav__link> <span class=md-ellipsis> FKO & CMF Deployment </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/terraform/ class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Terraform </span> </a> </li> <li class=md-nav__item> <a href=../../techno/fk-k8s-monitor/ class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Flink_App_Coding </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Flink_App_Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex> <span class=md-ellipsis> Flink SQL coding </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Flink SQL coding </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../flink-sql-clients/ class=md-nav__link> <span class=md-ellipsis> SQL Clients </span> </a> </li> <li class=md-nav__item> <a href=../flink-sql-1/ class=md-nav__link> <span class=md-ellipsis> Create Table (SQL) </span> </a> </li> <li class=md-nav__item> <a href=../flink-sql-2/ class=md-nav__link> <span class=md-ellipsis> SQL DML </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2 checked> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex> <span class=md-ellipsis> Java - Python </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=true> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Java - Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../table-api/ class=md-nav__link> <span class=md-ellipsis> Table API </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> DataStreams API </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> DataStreams API </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#key-concepts class=md-nav__link> <span class=md-ellipsis> Key Concepts </span> </a> </li> <li class=md-nav__item> <a href=#create-a-java-project-with-maven class=md-nav__link> <span class=md-ellipsis> Create a Java project with maven </span> </a> <nav class=md-nav aria-label="Create a Java project with maven"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#submit-job-to-flink class=md-nav__link> <span class=md-ellipsis> Submit job to Flink </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#best-practices class=md-nav__link> <span class=md-ellipsis> Best Practices </span> </a> </li> <li class=md-nav__item> <a href=#datastream-deeper-dive class=md-nav__link> <span class=md-ellipsis> Datastream deeper dive </span> </a> </li> <li class=md-nav__item> <a href=#unit-testing class=md-nav__link> <span class=md-ellipsis> Unit Testing </span> </a> </li> <li class=md-nav__item> <a href=#data-set-basic-apps class=md-nav__link> <span class=md-ellipsis> Data set basic apps </span> </a> <nav class=md-nav aria-label="Data set basic apps"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#inner-join class=md-nav__link> <span class=md-ellipsis> Inner join </span> </a> </li> <li class=md-nav__item> <a href=#left-outer-join class=md-nav__link> <span class=md-ellipsis> Left outer join </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#data-stream-examples class=md-nav__link> <span class=md-ellipsis> Data Stream examples </span> </a> <nav class=md-nav aria-label="Data Stream examples"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#compute-average-profit-per-product class=md-nav__link> <span class=md-ellipsis> Compute average profit per product </span> </a> </li> <li class=md-nav__item> <a href=#aggregates class=md-nav__link> <span class=md-ellipsis> Aggregates </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#taxi-rides-examples class=md-nav__link> <span class=md-ellipsis> Taxi rides examples </span> </a> </li> <li class=md-nav__item> <a href=#fraud-detection class=md-nav__link> <span class=md-ellipsis> Fraud detection </span> </a> </li> <li class=md-nav__item> <a href=#interesting-articles class=md-nav__link> <span class=md-ellipsis> Interesting articles </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../udf_sql/ class=md-nav__link> <span class=md-ellipsis> UDFs & PTFs </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> Deployment </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Deployment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/shift_left_utils/ class=md-nav__link> <span class=md-ellipsis> Manage CC Flink projects </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> More advanced topics </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> More advanced topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../stateful-func/ class=md-nav__link> <span class=md-ellipsis> Stateful function </span> </a> </li> <li class=md-nav__item> <a href=../cep/ class=md-nav__link> <span class=md-ellipsis> Complex Event Processing </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/data_as_a_product/ class=md-nav__link> <span class=md-ellipsis> Data as a product </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-studies/methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/shift_left_utils/ class=md-nav__link> <span class=md-ellipsis> Migrate to real-time processing tools </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/coe/ class=md-nav__link> <span class=md-ellipsis> Center of Excellence </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/flink_project_demos/c360/spark_project/ class=md-nav__link> <span class=md-ellipsis> A C360 data product demo </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Related_Technologies </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Related_Technologies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../techno/ccloud-flink/ class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Flink </span> </a> </li> <li class=md-nav__item> <a href=../../techno/cp-flink/ class=md-nav__link> <span class=md-ellipsis> Confluent Platform for Flink </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/kafka/ class=md-nav__link> <span class=md-ellipsis> Kafka Integration </span> </a> </li> <li class=md-nav__item> <a href=../../techno/cc-tableflow/ class=md-nav__link> <span class=md-ellipsis> Confluent TableFlow </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/techno/data/#data-related-technologies class=md-nav__link> <span class=md-ellipsis> Apache Iceberg </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/kafka-studies class=md-nav__link> <span class=md-ellipsis> Kafka-studies </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-studies class=md-nav__link> <span class=md-ellipsis> EDA </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#key-concepts class=md-nav__link> <span class=md-ellipsis> Key Concepts </span> </a> </li> <li class=md-nav__item> <a href=#create-a-java-project-with-maven class=md-nav__link> <span class=md-ellipsis> Create a Java project with maven </span> </a> <nav class=md-nav aria-label="Create a Java project with maven"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#submit-job-to-flink class=md-nav__link> <span class=md-ellipsis> Submit job to Flink </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#best-practices class=md-nav__link> <span class=md-ellipsis> Best Practices </span> </a> </li> <li class=md-nav__item> <a href=#datastream-deeper-dive class=md-nav__link> <span class=md-ellipsis> Datastream deeper dive </span> </a> </li> <li class=md-nav__item> <a href=#unit-testing class=md-nav__link> <span class=md-ellipsis> Unit Testing </span> </a> </li> <li class=md-nav__item> <a href=#data-set-basic-apps class=md-nav__link> <span class=md-ellipsis> Data set basic apps </span> </a> <nav class=md-nav aria-label="Data set basic apps"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#inner-join class=md-nav__link> <span class=md-ellipsis> Inner join </span> </a> </li> <li class=md-nav__item> <a href=#left-outer-join class=md-nav__link> <span class=md-ellipsis> Left outer join </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#data-stream-examples class=md-nav__link> <span class=md-ellipsis> Data Stream examples </span> </a> <nav class=md-nav aria-label="Data Stream examples"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#compute-average-profit-per-product class=md-nav__link> <span class=md-ellipsis> Compute average profit per product </span> </a> </li> <li class=md-nav__item> <a href=#aggregates class=md-nav__link> <span class=md-ellipsis> Aggregates </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#taxi-rides-examples class=md-nav__link> <span class=md-ellipsis> Taxi rides examples </span> </a> </li> <li class=md-nav__item> <a href=#fraud-detection class=md-nav__link> <span class=md-ellipsis> Fraud detection </span> </a> </li> <li class=md-nav__item> <a href=#interesting-articles class=md-nav__link> <span class=md-ellipsis> Interesting articles </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=datastreams-programming-guidances-and-examples>DataStreams Programming guidances and examples<a class=headerlink href=#datastreams-programming-guidances-and-examples title="Permanent link">&para;</a></h1> <p>This chapter is a summary on how to use DataStream API, laborate from Apache Flink documentation, and other existing examples for Flink DataStream.</p> <h2 id=key-concepts>Key Concepts<a class=headerlink href=#key-concepts title="Permanent link">&para;</a></h2> <ul> <li>A DataStream program is a regular Java program packaged in a JAR file. Each Java Flink app is a <a href=https://ci.apache.org/projects/flink/flink-docs-release-1.20/dev/datastream_api.html#anatomy-of-a-flink-program>Java main function which defines the data flow to execute on one or more data streams</a>.</li> <li>In application mode, the <code>main()</code> function runs in the Job manager which constructs a directed acyclic graph and executes the graph operators within task managers.</li> <li>In session mode, a cli submits the jar file to a Flink JobManager which does the same processing.</li> <li>All programs get access to a Flink environment. <div class="language-java highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.flink.streaming.api.environment.StreamExecutionEnvironment</span><span class=p>;</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=p>...</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kd>final</span><span class=w> </span><span class=n>StreamExecutionEnvironment</span><span class=w> </span><span class=n>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StreamExecutionEnvironment</span><span class=p>.</span><span class=na>getExecutionEnvironment</span><span class=p>();</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=n>env</span><span class=p>.</span><span class=na>setParallelism</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=c1>// define the topology...</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=n>env</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=s>&quot;program name for UI ref&quot;</span><span class=p>);</span>
</span></code></pre></div></li> <li>The datastream API is an abstraction to define topology of operators to be executed on the stream of events/records.</li> <li>Use Datastream when strong control and customisation is needed. </li> <li>Programs are organized as a set of user functions. A function can be implemented as class, anonymous class, or lambda.</li> </ul> <details class="- info"> <summary>Classical Code structure</summary> <p>The code structure follows the following standard steps:</p> <ol> <li>Obtain a Flink execution environment</li> <li> <p>Define the data pipeline graph (as a separate method to simplify unit testing)</p> <ol> <li>Load/create the initial data from the stream</li> <li>Specify transformations on the data</li> <li>Specify where to put the results of the computations</li> </ol> </li> <li> <p>Trigger the program execution</p> </li> </ol> </details> <ul> <li>It is easy to go from DataStream to TableAPI. TableAPI is simpler to use for joins and windows logic implementation. <div class="language-Java highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.flink.table.api.Table</span><span class=p>;</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.flink.table.api.TableDescriptor</span><span class=p>;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.flink.table.api.bridge.java.StreamTableEnvironment</span><span class=p>;</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=p>...</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=kd>final</span><span class=w> </span><span class=n>StreamExecutionEnvironment</span><span class=w> </span><span class=n>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StreamExecutionEnvironment</span><span class=p>.</span><span class=na>getExecutionEnvironment</span><span class=p>();</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=n>StreamTableEnvironment</span><span class=w> </span><span class=n>tableEnv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StreamTableEnvironment</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>env</span><span class=p>);</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=c1>// Stream -&gt; Table</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=n>DataStream</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>inStream1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=n>Table</span><span class=w> </span><span class=n>appendOnlyTable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tableEnv</span><span class=p>.</span><span class=na>fromDataStream</span><span class=p>(</span><span class=n>inStream1</span><span class=p>)</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=c1>// Table -&gt; Stream</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>appendOnlyStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tableEnv</span><span class=p>.</span><span class=na>toDataStream</span><span class=p>(</span><span class=n>insertOnlyTable</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=na>class</span><span class=p>)</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=c1>// using Row type</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>Row</span><span class=o>&gt;</span><span class=w> </span><span class=n>changelogStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tableEnv</span><span class=p>.</span><span class=na>toChangelogStream</span><span class=p>(</span><span class=n>anyTable</span><span class=p>)</span>
</span></code></pre></div></li> </ul> <h2 id=create-a-java-project-with-maven>Create a Java project with maven<a class=headerlink href=#create-a-java-project-with-maven title="Permanent link">&para;</a></h2> <p><a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/dev/configuration/overview/ >See the Apache Flink product documentation</a> which can be summarized as:</p> <ol> <li>Be sure to have maven <code>mvn</code> cli and JAVA_HOME setup</li> <li> <p>Create a project template, named quickstart, using the Flink quickstart shell and specifying the Flink version (e.g. 1.20.2)</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>curl<span class=w> </span>https://flink.apache.org/q/quickstart.sh<span class=w> </span><span class=p>|</span><span class=w> </span>bash<span class=w> </span>-s<span class=w> </span><span class=m>1</span>.20.2
</span></code></pre></div> </li> <li> <p>Add the following <a href=https://mvnrepository.com/artifact/org.apache.flink>maven dependencies</a> into the <code>pom.xml</code>:</p> <div class="language-xml highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=cm>&lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-java --&gt;</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=nt>&lt;dependency&gt;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=nt>&lt;groupId&gt;</span>org.apache.flink<span class=nt>&lt;/groupId&gt;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>    </span><span class=nt>&lt;artifactId&gt;</span>flink-java<span class=nt>&lt;/artifactId&gt;</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span><span class=nt>&lt;version&gt;</span>${flink-version}<span class=nt>&lt;/version&gt;</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=nt>&lt;/dependency&gt;</span>
</span></code></pre></div> </li> <li> <p>When using Kafka, add Flink kafka connector dependency in pom.xml</p> <div class="language-xml highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=w>  </span><span class=nt>&lt;dependency&gt;</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>      </span><span class=nt>&lt;groupId&gt;</span>org.apache.flink<span class=nt>&lt;/groupId&gt;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>      </span><span class=nt>&lt;artifactId&gt;</span>flink-connector-kafka<span class=nt>&lt;/artifactId&gt;</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>      </span><span class=nt>&lt;version&gt;</span>1.20.2<span class=nt>&lt;/version&gt;</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>  </span><span class=nt>&lt;/dependency&gt;</span>
</span></code></pre></div> </li> <li> <p>Create a Java Class with a main function and the following code structure (See <a href>01-word-count example</a>):</p> <ul> <li>get Flink execution context</li> <li>defined process flow to apply to the data stream</li> <li>start the execution</li> </ul> <div class="language-java highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1>// Get execution context</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>  </span><span class=n>ExecutionEnvironment</span><span class=w> </span><span class=n>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ExecutionEnvironment</span><span class=p>.</span><span class=na>getExecutionEnvironment</span><span class=p>();</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>  </span><span class=c1>// use file as input so use program arguments to get file name</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>  </span><span class=n>ParameterTool</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ParameterTool</span><span class=p>.</span><span class=na>fromArgs</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>  </span><span class=n>env</span><span class=p>.</span><span class=na>getConfig</span><span class=p>().</span><span class=na>setGlobalJobParameters</span><span class=p>(</span><span class=n>params</span><span class=p>);</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>  </span><span class=n>defineWorkflow</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>  </span><span class=n>env</span><span class=p>.</span><span class=na>execute</span><span class=p>();</span>
</span></code></pre></div> <p>The code above uses the <a href=https://ci.apache.org/projects/flink/flink-docs-stable/api/java/org/apache/flink/api/java/utils/ParameterTool.html>ParameterTool class</a> to process the program arguments. So most of the basic examples use <code>--input filename</code> and <code>--output filename</code> as java arguments. So <code>params</code> will have those arguments in a Map. </p> </li> <li> <p>Define event structure as POJO, as a separate Java Bean in the <code>event</code> folder.</p> </li> <li>Implement the process logic and the event mapping, filtering logic... We will see more examples later.</li> <li>Package with <code>mvn package</code>. Create a UBER jar if using external system, for reading from a filesystem, Flink has the predefined connectors. The <code>maven-shade-plugin</code> maven plugin creates such UBER jar.</li> <li>Access to a Flink compute pool, locally using local installation, docker, Kubernetes or Confluent Cloud for Flink. Use the <code>flink cli</code> to submit the job for a local cluster, use FlinkDeployment(KFF) or FlinkApplication (CMF) <div class="language-sh highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>flink<span class=w> </span>run<span class=w> </span>-c<span class=w> </span>j9r.flink.MyJob<span class=w> </span>myapp.jar
</span></code></pre></div></li> </ol> <p>With the open source version, we have access to a lot of different connectors, for example to load data from csv file. This is convenient to do local testing or batch processing.</p> <details class="- info"> <summary>Create a Quarkus Flink java app</summary> <ul> <li>Create a Quarkus app: <code>quarkus create app -DprojectGroupId=jbcodeforce -DprojectArtifactId=my-flink</code>. See code examples under <code>flink-java/my-flink</code> folder and <code>jbcodeforce.p1</code> package.</li> <li>Do the same steps as above for the main class.</li> <li>Be sure to set quarkus uber-jar generation (<code>quarkus.package.type=uber-jar</code>) in the <code>application.properties</code> to get all the dependencies in a unique jar: Flink needs all dependencies in the classpath.</li> </ul> </details> <h3 id=submit-job-to-flink>Submit job to Flink<a class=headerlink href=#submit-job-to-flink title="Permanent link">&para;</a></h3> <p>When the Flink cluster runs with a Job Manager, it is possible to submit the application via the <code>flink</code> cli.</p> <h4 id=using-a-jobmanager-running-as-docker-image>Using a JobManager running as docker image<a class=headerlink href=#using-a-jobmanager-running-as-docker-image title="Permanent link">&para;</a></h4> <p>The jar file is mounted to the image to <code>/home/my-flink/target/</code>.</p> <div class="language-shell highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1># One way with mounted files to task manager and job manager containers.</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=nv>CNAME</span><span class=o>=</span><span class=s2>&quot;jbcodeforce.p1.WordCountMain&quot;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=nv>JMC</span><span class=o>=</span><span class=k>$(</span>docker<span class=w> </span>ps<span class=w> </span>--filter<span class=w> </span><span class=nv>name</span><span class=o>=</span>jobmanager<span class=w> </span>--format<span class=o>={{</span>.ID<span class=o>}}</span><span class=k>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-ti<span class=w> </span><span class=nv>$JMC</span><span class=w> </span>flink<span class=w> </span>run<span class=w> </span>-d<span class=w> </span>-c<span class=w> </span><span class=nv>$CNAME</span><span class=w> </span>/home/my-flink/target/my-flink-1.0.0-runner.jar<span class=w> </span>--input<span class=w> </span>file:///home/my-flink/data/wc.txt<span class=w> </span>--output<span class=w> </span>file:///home/my-flink/data/out.csv<span class=w> </span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=c1># inside the jobmanager</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>flink<span class=w> </span>run<span class=w> </span>-d<span class=w> </span>-c<span class=w> </span>jbcodeforce.p1.WordCountMain<span class=w> </span>/home/my-flink/target/my-flink-
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=m>1</span>.0.0-runner.jar<span class=w> </span>--input<span class=w> </span>file:///home/my-flink/data/wc.txt<span class=w> </span>--output<span class=w> </span>file:///home/my-flink/data/out.csv
</span></code></pre></div> <h4 id=using-flinkdeployment-and-k8s-operator>Using FlinkDeployment and K8S Operator<a class=headerlink href=#using-flinkdeployment-and-k8s-operator title="Permanent link">&para;</a></h4> <ul> <li>Create FlinkDeployment manifest with the JobSpec</li> <li>Deploy with Kubectl <div class="language-sh highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>app_deploy.yaml<span class=w> </span>-n<span class=w> </span>flink-oss
</span></code></pre></div></li> </ul> <h2 id=best-practices>Best Practices<a class=headerlink href=#best-practices title="Permanent link">&para;</a></h2> <ul> <li>Isolate the business logic outside of the main, and use Flink unit test environment to validate the topology logic.</li> <li>In production, run the main() method, to use the real sources and sinks</li> <li>Clearly assess the type of tests to implement: unit test to validate individual operator. For integration tests, use bounded sources with controlled records, and sinks to collectors.</li> <li>Use MiniClusterExtension for testing.</li> </ul> <h2 id=datastream-deeper-dive>Datastream deeper dive<a class=headerlink href=#datastream-deeper-dive title="Permanent link">&para;</a></h2> <ul> <li><a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/overview/ >Datastream open source documentation</a> with <a href=https://nightlies.apache.org/flink/flink-docs-master/api/java/ >the API</a>.</li> <li><a href=https://github.com/confluentinc/flink-cookbook>Confluent Flink Cookbook</a>, is a set of recipes around Flink using DataStream, TableAPI. Once cloned, load one of the folder as a java project in IDE, build and run unit tests. This repository includes tools to run a mini Flink cluster in Java directly.</li> <li><a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream-v2/overview/ >DataStream v2</a></li> </ul> <h2 id=unit-testing>Unit Testing<a class=headerlink href=#unit-testing title="Permanent link">&para;</a></h2> <hr> <p>To rework</p> <h2 id=data-set-basic-apps>Data set basic apps<a class=headerlink href=#data-set-basic-apps title="Permanent link">&para;</a></h2> <div class="admonition - error"> <p class=admonition-title>Attention Scala and DataSet aPi do not exist anymore</p> <p>Deprecated from Flink 1.18.</p> </div> <p>The examples directly in the <a href=https://github.com/jbcodeforce/flink-studies/blob/master/flink-java/my-flink/src/main/java/jbcodeforce/p1>my-flink project under the jbcodeforce.p1 package</a>:</p> <ul> <li><a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/p1/PersonFiltering.java>PersonFiltering.java</a> filter a persons datastream using person's age to create a new "adult" output data stream. This example uses test data from a list of person and uses a filtering class which implements the filter method. This code can execute in VSCode or any IDE</li> <li><a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/p1/InnerJoin.java>InnerJoin</a> Proceed two files and do an inner join by using the same key on both files. See next section for details.</li> <li><a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/p1/LeftOuterJoin.java>LeftOuterJoin</a> results will include matching records from both tuples and non matching from left (so person) (<code>personSet.leftOuterJoin(locationSet)</code>).</li> <li><a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/p1/RightOuterJoin.java>RightOuterJoin</a> matching records present in both data sets and non matching from the right.</li> <li><a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/p1/FullOuterJoin.java>Full outer join</a> when matching and non matching are present. See <a href=https://github.com/jbcodeforce/flink-studies/tree/master/my-flink/data/fulljoinout.csv>fulljoinout.csv output file</a>.</li> <li><a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/p1/WordCountMain.java>Traditional word count from a text</a> uses a filter function to keep line starting by a pattern (letter 'N'), then it uses a tokenizer function to build a tuple for each word with a count of 1. The last step of the flow is to groupBy word and sum the element. Not obvious.</li> </ul> <h3 id=inner-join>Inner join<a class=headerlink href=#inner-join title="Permanent link">&para;</a></h3> <p>Need to read from two files and prepare them as tuples. Then process each record of the first tuple with the second one using field 0 on both tuples as join key. The <code>with()</code> build the new tuple with combined values. <code>with()</code> need a join function to implement the joining logic and attributes selection.</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=w> </span><span class=n>DataSet</span><span class=o>&lt;</span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=n>String</span><span class=p>,</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>joinedSet</span><span class=w> </span><span class=o>=</span><span class=w> </span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>      </span><span class=n>personSet</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>locationSet</span><span class=p>)</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>      </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>// indice of the field to be used to do join from first tuple</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>      </span><span class=p>.</span><span class=na>equalTo</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w>  </span><span class=c1>// to match the field in idx 0 of the second tuple</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>      </span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JoinFunction</span><span class=o>&lt;</span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>                              </span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>                              </span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>          </span><span class=kd>public</span><span class=w> </span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>join</span><span class=p>(</span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>person</span><span class=p>,</span><span class=w>  </span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>location</span><span class=p>)</span><span class=w>  </span><span class=p>{</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>              </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>(</span><span class=n>person</span><span class=p>.</span><span class=na>f0</span><span class=p>,</span><span class=w>   </span><span class=n>person</span><span class=p>.</span><span class=na>f1</span><span class=p>,</span><span class=w>  </span><span class=n>location</span><span class=p>.</span><span class=na>f1</span><span class=p>);</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>          </span><span class=p>}</span><span class=w>              </span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>      </span><span class=p>});</span>
</span></code></pre></div> <p>Exec within the <code>JobManager</code> container.</p> <div class="language-shell highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>flink<span class=w> </span>run<span class=w> </span>-d<span class=w> </span>-c<span class=w> </span>jbcodeforce.p1.InnerJoin<span class=w> </span>/home/my-flink/target/my-flink-1.0.0-SNAPSHOT.jar<span class=w> </span>--persons<span class=w> </span>file:///home/my-flink/data/persons.txt<span class=w> </span>--locations<span class=w> </span>file:///home/my-flink/data/locations.txt<span class=w> </span>--output<span class=w> </span>file:///home/my-flink/data/joinout.csv<span class=w> </span>
</span></code></pre></div> <h3 id=left-outer-join>Left outer join<a class=headerlink href=#left-outer-join title="Permanent link">&para;</a></h3> <p>The construct is the same as above, except the results will include matching records from both tuples and non matching records coming from the left part of the join:</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=w> </span><span class=n>DataSet</span><span class=o>&lt;</span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=n>String</span><span class=p>,</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>joinedSet</span><span class=w> </span><span class=o>=</span><span class=w> </span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>            </span><span class=n>personSet</span><span class=p>.</span><span class=na>leftOuterJoin</span><span class=p>(</span><span class=n>locationSet</span><span class=p>)</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>            </span><span class=p>....</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>join</span><span class=p>(</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>                        </span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>person</span><span class=p>,</span><span class=w>  </span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>                        </span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>location</span><span class=p>)</span><span class=w>  </span><span class=p>{</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>location</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>              </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>(</span><span class=n>person</span><span class=p>.</span><span class=na>f0</span><span class=p>,</span><span class=w> </span><span class=n>person</span><span class=p>.</span><span class=na>f1</span><span class=p>,</span><span class=w> </span><span class=s>&quot;NULL&quot;</span><span class=p>);</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>          </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>(</span><span class=n>person</span><span class=p>.</span><span class=na>f0</span><span class=p>,</span><span class=w>   </span><span class=n>person</span><span class=p>.</span><span class=na>f1</span><span class=p>,</span><span class=w>  </span><span class=n>location</span><span class=p>.</span><span class=na>f1</span><span class=p>);</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>      </span><span class=p>}</span><span class=w>  </span>
</span></code></pre></div> <h2 id=data-stream-examples>Data Stream examples<a class=headerlink href=#data-stream-examples title="Permanent link">&para;</a></h2> <p><strong>Data stream</strong> API is used to get real time data. It can come from file with readFile with watching folder for new file to be read, or use <code>socketTextStream</code> or any streaming source (addSource) like Twitter, Kafka...</p> <p>The output can also be a stream (as sink): writeAsText(),.. writeToSocket, addSink...</p> <p>See example in <code>my-flink</code> project source <a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/datastream/WordCountSocketStreaming.java>WordCountSocketStream</a>, and to test it, use the <code>nc -l 9999</code> tool to open a socket on port 9999 and send text message.</p> <p>When using docker we need to open a socket in the same network as the Flink task manager, the command looks like:</p> <div class="language-shell highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>docker<span class=w> </span>run<span class=w> </span>-t<span class=w> </span>--rm<span class=w> </span>--network<span class=w>  </span>flink-studies_default<span class=w> </span>--name<span class=w> </span>ncs<span class=w> </span>-h<span class=w> </span>ncshost<span class=w> </span>subfuzion/netcat<span class=w> </span>-l<span class=w> </span><span class=m>9999</span>
</span></code></pre></div> <h3 id=compute-average-profit-per-product>Compute average profit per product<a class=headerlink href=#compute-average-profit-per-product title="Permanent link">&para;</a></h3> <p>The data set <a href=https://github.com/jbcodeforce/flink-studies/tree/master/my-flink/data/avg.txt>avg.txt</a> represents transactions for a given product with its sale profit. The goal is to compute the average profit per product per month. </p> <p>The solution use Map - Reduce functions.</p> <ul> <li>Input sample:</li> </ul> <div class="language-text highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>01-06-2018,June,Category5,Bat,12
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>01-06-2108,June,Category4,Perfume,10
</span></code></pre></div> <ul> <li>Output:</li> </ul> <p>In the class <a href=https://github.com/jbcodeforce/flink-studies/blob/master/my-flink/src/main/java/jbcodeforce/datastream/ProfitAverageMR.java>datastream.ProfitAverageMR</a>, the DataStream loads the input file as specified in <code>--input</code> argument and then splits record to get columns as tuple attributes.</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=w> </span><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>saleStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=p>.</span><span class=na>readTextFile</span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&quot;input&quot;</span><span class=p>));</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=w> </span><span class=c1>// month, product, category, profit, count</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w> </span><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>Tuple5</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>mappedSale</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>saleStream</span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Splitter</span><span class=p>());</span><span class=w> </span>
</span></code></pre></div> <p>The <code>Splitter</code> class implements a MapFunction which splits the csv string and select the attributes needed to generate the tuple.</p> <p>A first reduce operation is used on the sale tuple where the key is a month (output from GetMonthAsKey) to accumulating profit and the number of record:</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>Tuple5</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>reduced</span><span class=w> </span><span class=o>=</span><span class=w> </span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>  </span><span class=n>mappedSale</span><span class=p>.</span><span class=na>keyBy</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>GetMonthAsKey</span><span class=p>())</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>  </span><span class=p>.</span><span class=na>reduce</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AccumulateProfitAndRecordCount</span><span class=p>());</span><span class=w> </span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Double</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>profitPerMonth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reduced</span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MapOnMonth</span><span class=p>());</span>
</span></code></pre></div> <p>here is the main reduce function: the field f3 is the profit, and f4 the number of sale.</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>AccumulateProfitAndRecordCount</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ReduceFunction</span><span class=o>&lt;</span><span class=n>Tuple5</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1L</span><span class=p>;</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Tuple5</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>reduce</span><span class=p>(</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>            </span><span class=n>Tuple5</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>current</span><span class=p>,</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>            </span><span class=n>Tuple5</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>previous</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Tuple5</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>f0</span><span class=p>,</span><span class=n>current</span><span class=p>.</span><span class=na>f1</span><span class=p>,</span><span class=n>current</span><span class=p>.</span><span class=na>f2</span><span class=p>,</span><span class=n>current</span><span class=p>.</span><span class=na>f3</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>previous</span><span class=p>.</span><span class=na>f3</span><span class=p>,</span><span class=w> </span><span class=n>current</span><span class=p>.</span><span class=na>f4</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>previous</span><span class=p>.</span><span class=na>f4</span><span class=p>);</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=p>}</span>
</span></code></pre></div> <p>To run the example once the cluster is started use:</p> <div class="language-shell highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=w> </span>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-ti<span class=w> </span><span class=nv>$JMC</span><span class=w> </span>flink<span class=w> </span>run<span class=w> </span>-d<span class=w> </span>-c<span class=w> </span>jbcodeforce.datastream.ProfitAverageMR<span class=w> </span>/home/my-flink/target/my-flink-1.0.0-runner.jar<span class=w> </span>--input<span class=w> </span>file:///home/my-flink/data/avg.txt<span class=w> </span>
</span></code></pre></div> <h3 id=aggregates>Aggregates<a class=headerlink href=#aggregates title="Permanent link">&para;</a></h3> <p>See all the operators examples in <a href=https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/ >this note</a>.</p> <p>Examples of aggregate API to compute min, max... using field at index 3</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=n>mapped</span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=w> </span><span class=n>Tuple4</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>record</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>f0</span><span class=w> </span><span class=p>).</span><span class=na>sum</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=na>writeAsText</span><span class=p>(</span><span class=s>&quot;/home/my-flink/data/out1&quot;</span><span class=p>);</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=n>mapped</span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=w> </span><span class=n>Tuple4</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>record</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>f0</span><span class=w> </span><span class=p>).</span><span class=na>min</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=na>writeAsText</span><span class=p>(</span><span class=s>&quot;/home/my-flink/data/out2&quot;</span><span class=p>);</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=n>mapped</span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=w> </span><span class=n>Tuple4</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>record</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>f0</span><span class=p>)</span><span class=w> </span><span class=p>.</span><span class=na>minBy</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=na>writeAsText</span><span class=p>(</span><span class=s>&quot;/home/my-flink/data/out3&quot;</span><span class=p>);</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=n>mapped</span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=w> </span><span class=n>Tuple4</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>record</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>f0</span><span class=w> </span><span class=p>).</span><span class=na>max</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=na>writeAsText</span><span class=p>(</span><span class=s>&quot;/home/my-flink/data/out4&quot;</span><span class=p>);</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=n>mapped</span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=w> </span><span class=n>Tuple4</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>record</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>f0</span><span class=w> </span><span class=p>).</span><span class=na>maxBy</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=na>writeAsText</span><span class=p>(</span><span class=s>&quot;/home/my-flink/data/out5&quot;</span><span class=p>);</span>
</span></code></pre></div> <h2 id=taxi-rides-examples>Taxi rides examples<a class=headerlink href=#taxi-rides-examples title="Permanent link">&para;</a></h2> <p>This is a more complex solution with a lot of good inspirations for utilities class and way to work on Java Beans.</p> <p>See <a href=https://github.com/apache/flink-training/tree/release-1.15>the flink-training github</a> to access to the source code.</p> <ul> <li><a href=https://github.com/apache/flink-training/tree/release-1.15/ride-cleansing>Lab 1- filter non NY taxi rides</a>, the process flow uses the <code>DataStream::filter</code> method. The NYCFilter is a class-filter-function.</li> </ul> <div class="language-Java highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>TaxiRide</span><span class=o>&gt;</span><span class=w> </span><span class=n>filteredRides</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rides</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>    </span><span class=c1>// keep only those rides and both start and end in NYC</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>    </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>NYCFilter</span><span class=p>());</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=c1>// ...</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>NYCFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>FilterFunction</span><span class=o>&lt;</span><span class=n>TaxiRide</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>TaxiRide</span><span class=w> </span><span class=n>taxiRide</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>GeoUtils</span><span class=p>.</span><span class=na>isInNYC</span><span class=p>(</span><span class=n>taxiRide</span><span class=p>.</span><span class=na>startLon</span><span class=p>,</span><span class=w> </span><span class=n>taxiRide</span><span class=p>.</span><span class=na>startLat</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=w>                </span><span class=n>GeoUtils</span><span class=p>.</span><span class=na>isInNYC</span><span class=p>(</span><span class=n>taxiRide</span><span class=p>.</span><span class=na>endLon</span><span class=p>,</span><span class=w> </span><span class=n>taxiRide</span><span class=p>.</span><span class=na>endLat</span><span class=p>);</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=p>}</span>
</span></code></pre></div> <p>This exercise uses a lot of utility classes for data and tests which hide the complexity of the data preparation (see the common folder within the training repository).</p> <ul> <li><a href=https://github.com/apache/flink-training/tree/release-1.15/rides-and-fares>Process ride and fare data streams for stateful enrichment</a>. The result should be a DataStream<tuple2\&lt;taxiride, taxifare>>, with one record for each distinct rideId. Each tuple should pair the TaxiRide START event for some rideId with its matching TaxiFare. There is no control over the order of arrival of the ride and fare records for each rideId.</li> </ul> <div class="language-java highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>TaxiRide</span><span class=o>&gt;</span><span class=w> </span><span class=n>rides</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=w>        </span><span class=p>.</span><span class=na>addSource</span><span class=p>(</span><span class=n>rideSourceOrTest</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TaxiRideGenerator</span><span class=p>()))</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>((</span><span class=n>TaxiRide</span><span class=w> </span><span class=n>ride</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>ride</span><span class=p>.</span><span class=na>isStart</span><span class=p>)</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=w>        </span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=n>TaxiRide</span><span class=w> </span><span class=n>ride</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>ride</span><span class=p>.</span><span class=na>rideId</span><span class=p>);</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>TaxiFare</span><span class=o>&gt;</span><span class=w> </span><span class=n>fares</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=w>        </span><span class=p>.</span><span class=na>addSource</span><span class=p>(</span><span class=n>fareSourceOrTest</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TaxiFareGenerator</span><span class=p>()))</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=w>        </span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=n>TaxiFare</span><span class=w> </span><span class=n>fare</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>fare</span><span class=p>.</span><span class=na>rideId</span><span class=p>);</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=c1>// Set a UID on the stateful flatmap operator so we can read its state using the State Processor API.</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>Tuple2</span><span class=o>&lt;</span><span class=n>TaxiRide</span><span class=p>,</span><span class=w> </span><span class=n>TaxiFare</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>enrichedRides</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rides</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=w>        </span><span class=p>.</span><span class=na>connect</span><span class=p>(</span><span class=n>fares</span><span class=p>)</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=w>        </span><span class=p>.</span><span class=na>flatMap</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>EnrichmentFunction</span><span class=p>())</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=w>        </span><span class=p>.</span><span class=na>uid</span><span class=p>(</span><span class=s>&quot;enrichment&quot;</span><span class=p>);</span>
</span></code></pre></div> <p>The join and stateful implementation are done in the EnrichmentFunction as a <code>RichCoFlatMap</code>. A CoFlatMapFunction implements a flat-map transformation over two connected streams. The same instance of the transformation function is used to transform both of the connected streams. That way, the stream transformations can share state.</p> <p><a href=https://github.com/apache/flink-training/blob/ea4a66e97dd211bd8f8b8e415e3e427c30e4746b/rides-and-fares/src/solution/java/org/apache/flink/training/solutions/ridesandfares/RidesAndFaresSolution.java#L86-L116>RidesAndFaresSolution.java</a></p> <p><code>ValueState&lt;TaxiRide&gt; rideState</code> is a partitioned single-value state.</p> <p><code>flatMap1(TaxiRide ride, Collector&lt;Tuple2&lt;TaxiRide, TaxiFare&gt;&gt; out)</code> method is called for each element in the first of the connected streams. So here on a ride event, if there is a matching fare already computed then generate the output tuple, if not update keep the ride to be used for the fare event processing.</p> <p><code>flatMap2(TaxiFare fare, Collector&lt;Tuple2&lt;TaxiRide, TaxiFare&gt;&gt; out)</code> method is called on the second connected streams. When a fare event arrives, if there is a ride with the same key, join, if not keep the fare for future ride event.</p> <p>So one of the trick is in the ValueState class.</p> <ul> <li><a href=https://github.com/apache/flink-training/tree/master/hourly-tips>Hourly tips</a> is a <a href=https://ci.apache.org/projects/flink/flink-docs-release-1.11/learn-flink/streaming_analytics.html>time windowed analytics</a> to identify, for each hour, the driver earning the most tips. The approach is to use hour-long windows that compute the total tips for each driver during the hour, and then from that stream of window results, find the driver with the maximum tip total for each hour.</li> </ul> <p>The first data stream below applies a window on a keyed stream. Process is one of the function to use on the window. (reduce and aggregate are the others). </p> <div class="language-java highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=w>    </span><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Float</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>hourlyTips</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fares</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=w>            </span><span class=p>.</span><span class=na>keyBy</span><span class=p>((</span><span class=n>TaxiFare</span><span class=w> </span><span class=n>fare</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>fare</span><span class=p>.</span><span class=na>driverId</span><span class=p>)</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=w>            </span><span class=p>.</span><span class=na>window</span><span class=p>(</span><span class=n>TumblingEventTimeWindows</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>Time</span><span class=p>.</span><span class=na>hours</span><span class=p>(</span><span class=mi>1</span><span class=p>)))</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=w>            </span><span class=p>.</span><span class=na>process</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AddTips</span><span class=p>());</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=w>    </span><span class=n>DataStream</span><span class=o>&lt;</span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Float</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>hourlyMax</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hourlyTips</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>            </span><span class=p>.</span><span class=na>windowAll</span><span class=p>(</span><span class=n>TumblingEventTimeWindows</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>Time</span><span class=p>.</span><span class=na>hours</span><span class=p>(</span><span class=mi>1</span><span class=p>)))</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=w>            </span><span class=p>.</span><span class=na>maxBy</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></code></pre></div> <p>A process window has an iterable on the collection of events in the window to work with:</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>AddTips</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ProcessWindowFunction</span><span class=o>&lt;</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=w>            </span><span class=n>TaxiFare</span><span class=p>,</span><span class=w> </span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Float</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>TimeWindow</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>Iterable</span><span class=o>&lt;</span><span class=n>TaxiFare</span><span class=o>&gt;</span><span class=w> </span><span class=n>fares</span><span class=p>,</span><span class=w> </span><span class=n>Collector</span><span class=o>&lt;</span><span class=n>Tuple3</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>Float</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>out</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>sumOfTips</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0F</span><span class=p>;</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>TaxiFare</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>fares</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=w>            </span><span class=n>sumOfTips</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>tip</span><span class=p>;</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Tuple3</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>window</span><span class=p>().</span><span class=na>getEnd</span><span class=p>(),</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>sumOfTips</span><span class=p>));</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=p>}</span>
</span></code></pre></div> <p>Time windowing has limitations:</p> <ul> <li>can not correctly process historic data</li> <li>can not correctly handle out-of-order data</li> <li> <p>results will be non-deterministic</p> </li> <li> <p><a href=https://github.com/apache/flink-training/tree/release-1.15/long-ride-alerts>Long ride alert</a> is an example of <a href=https://ci.apache.org/projects/flink/flink-docs-release-1.15/learn-flink/event_driven.html>Event driven application</a> where alerts are created if a taxi ride started two hours ago is still ongoing. It uses event timestamp and <a href=https://ci.apache.org/projects/flink/flink-docs-release-1.15/learn-flink/streaming_analytics.html#watermarks>watermarks</a>.</p> </li> </ul> <p>The key is in the <a href=https://github.com/apache/flink-training/blob/ea4a66e97dd211bd8f8b8e415e3e427c30e4746b/long-ride-alerts/src/solution/java/org/apache/flink/training/solutions/longrides/LongRidesSolution.java#L66-L108>MatchFunction process function</a> implementation in which START or END events are kept in a value state, but a timer is set on the context, so the method may get a timer trigger with a processing event that will trigger the onTimer() callback method.</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=n>context</span><span class=p>.</span><span class=na>timerService</span><span class=p>().</span><span class=na>registerEventTimeTimer</span><span class=p>(</span><span class=n>getTimerTime</span><span class=p>(</span><span class=n>ride</span><span class=p>));</span>
</span></code></pre></div> <p>It generates to the output stream / sink only records from this onTimer.</p> <h2 id=fraud-detection>Fraud detection<a class=headerlink href=#fraud-detection title="Permanent link">&para;</a></h2> <p>This example is based on traditional card transaction fraud detection evaluation. The logic may need to support:</p> <ul> <li>verify card is not already reported as lost or stolen</li> <li>verify the customer is not already alerted (avoid over alerting)</li> <li>multiple transactions in short time period</li> <li>duplicate transactions from a specific merchant type</li> <li>online transaction and in-person transaction followed in short time period</li> <li>transaction location too far to be feasible in the time period</li> </ul> <p>For lost cards and customer alerted the lists are sent to each node processing the flow so the lookup / join is local and based on the card_id and customer_id. In an EDA implementation the sources will come from Kafka Topics. </p> <p>To support the search for transaction.card_number being lost or not, we use the concepts of broadcast state and stream. The <a href=https://ci.apache.org/projects/flink/flink-docs-stable/api/java/org/apache/flink/api/common/state/BroadcastState.html>BroadcastState</a> the same elements are sent to all instances of an operator.</p> <h2 id=interesting-articles>Interesting articles<a class=headerlink href=#interesting-articles title="Permanent link">&para;</a></h2> <ul> <li><a href=https://medium.com/datareply/event-driven-file-ingestion-using-flink-source-api-cfe45e43f88b>Event Driven File Ingestion using Flink Source API</a></li> </ul> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../table-api/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Table API"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Table API </div> </div> </a> <a href=../udf_sql/ class="md-footer__link md-footer__link--next" aria-label="Next: UDFs & PTFs"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> UDFs & PTFs </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2018 - 2026 Jerome Boyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jbcodeforce target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/jeromeboyer target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["content.code.annotation", "content.code.copy", "content.tooltips", "content.tabs.link", "search.suggest", "search.highlight", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>