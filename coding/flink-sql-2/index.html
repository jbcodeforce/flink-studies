<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://jeromeboyer.net/flink-studies/coding/flink-sql-2/ rel=canonical><link href=../flink-sql-1/ rel=prev><link href=../table-api/ rel=next><link rel=icon href=../../images/logo-blue.drawio.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.2"><title>SQL DML - Apache and Confluent Flink Studies</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#flink-sql-dml class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Apache and Confluent Flink Studies" class="md-header__button md-logo" aria-label="Apache and Confluent Flink Studies" data-md-component=logo> <img src=../../images/flink-header-logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Apache and Confluent Flink Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> SQL DML </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/flink-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Foundations </a> </li> <li class=md-tabs__item> <a href=../../cookbook/ class=md-tabs__link> Cookbook </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../flink-sql-clients/ class=md-tabs__link> Flink_App_Coding </a> </li> <li class=md-tabs__item> <a href=../../methodology/data_as_a_product/ class=md-tabs__link> Methodology </a> </li> <li class=md-tabs__item> <a href=../../techno/ccloud-flink/ class=md-tabs__link> Related_Technologies </a> </li> <li class=md-tabs__item> <a href=https://jbcodeforce.github.io/eda-studies class=md-tabs__link> EDA </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Apache and Confluent Flink Studies" class="md-nav__button md-logo" aria-label="Apache and Confluent Flink Studies" data-md-component=logo> <img src=../../images/flink-header-logo.svg alt=logo> </a> Apache and Confluent Flink Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/flink-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Foundations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Foundations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/ class=md-nav__link> <span class=md-ellipsis> Flink Key Concepts </span> </a> </li> <li class=md-nav__item> <a href=../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/flink-sql/ class=md-nav__link> <span class=md-ellipsis> Flink SQL concepts </span> </a> </li> <li class=md-nav__item> <a href=../../labs/ class=md-nav__link> <span class=md-ellipsis> Code&Demos </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/agentic_flink/ class=md-nav__link> <span class=md-ellipsis> Agentic applications </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Cookbook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cookbook/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/considerations/ class=md-nav__link> <span class=md-ellipsis> Considerations </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/cluster_mgt/ class=md-nav__link> <span class=md-ellipsis> Cluster management </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/job_lifecycle/ class=md-nav__link> <span class=md-ellipsis> Job Lifecycle </span> </a> </li> <li class=md-nav__item> <a href=../k8s-deploy/ class=md-nav__link> <span class=md-ellipsis> FKO & CMF Deployment </span> </a> </li> <li class=md-nav__item> <a href=../../cookbook/terraform/ class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Terraform </span> </a> </li> <li class=md-nav__item> <a href=../../techno/fk-k8s-monitor/ class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Flink_App_Coding </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Flink_App_Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1 checked> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex> <span class=md-ellipsis> Flink SQL coding </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=true> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Flink SQL coding </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../flink-sql-clients/ class=md-nav__link> <span class=md-ellipsis> SQL Clients </span> </a> </li> <li class=md-nav__item> <a href=../flink-sql-1/ class=md-nav__link> <span class=md-ellipsis> Create Table (SQL) </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> SQL DML </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> SQL DML </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#sources-of-information class=md-nav__link> <span class=md-ellipsis> Sources Of Information </span> </a> </li> <li class=md-nav__item> <a href=#common-patterns class=md-nav__link> <span class=md-ellipsis> Common Patterns </span> </a> <nav class=md-nav aria-label="Common Patterns"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filtering class=md-nav__link> <span class=md-ellipsis> Filtering </span> </a> </li> <li class=md-nav__item> <a href=#deduplication class=md-nav__link> <span class=md-ellipsis> Deduplication </span> </a> </li> <li class=md-nav__item> <a href=#transformation class=md-nav__link> <span class=md-ellipsis> Transformation </span> </a> </li> <li class=md-nav__item> <a href=#statement-set class=md-nav__link> <span class=md-ellipsis> Statement Set </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stateful-aggregations class=md-nav__link> <span class=md-ellipsis> Stateful aggregations </span> </a> <nav class=md-nav aria-label="Stateful aggregations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#group-by class=md-nav__link> <span class=md-ellipsis> Group BY </span> </a> </li> <li class=md-nav__item> <a href=#distinct class=md-nav__link> <span class=md-ellipsis> Distinct </span> </a> </li> <li class=md-nav__item> <a href=#array_agg class=md-nav__link> <span class=md-ellipsis> ARRAY_AGG </span> </a> </li> <li class=md-nav__item> <a href=#over class=md-nav__link> <span class=md-ellipsis> OVER </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#joins class=md-nav__link> <span class=md-ellipsis> Joins </span> </a> <nav class=md-nav aria-label=Joins> <ul class=md-nav__list> <li class=md-nav__item> <a href=#temporal-join class=md-nav__link> <span class=md-ellipsis> Temporal Join </span> </a> </li> <li class=md-nav__item> <a href=#interval-join class=md-nav__link> <span class=md-ellipsis> Interval Join </span> </a> </li> <li class=md-nav__item> <a href=#lateral-joins class=md-nav__link> <span class=md-ellipsis> Lateral Joins </span> </a> </li> <li class=md-nav__item> <a href=#multi-way-joins class=md-nav__link> <span class=md-ellipsis> Multi way joins </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> <li class=md-nav__item> <a href=#faqs class=md-nav__link> <span class=md-ellipsis> FAQs </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#windowing-table-value-functions class=md-nav__link> <span class=md-ellipsis> Windowing / Table Value Functions </span> </a> </li> <li class=md-nav__item> <a href=#sinkupsertmaterializer class=md-nav__link> <span class=md-ellipsis> SinkUpsertMaterializer </span> </a> </li> <li class=md-nav__item> <a href=#row-pattern-recognition class=md-nav__link> <span class=md-ellipsis> Row pattern recognition </span> </a> </li> <li class=md-nav__item> <a href=#confluent-cloud-specifics class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Specifics </span> </a> </li> <li class=md-nav__item> <a href=#analyzing-statements class=md-nav__link> <span class=md-ellipsis> Analyzing Statements </span> </a> <nav class=md-nav aria-label="Analyzing Statements"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#understand-the-physical-execution-plan-for-a-sql-query class=md-nav__link> <span class=md-ellipsis> Understand the physical execution plan for a SQL query </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting-sql-statement-running-slow class=md-nav__link> <span class=md-ellipsis> Troubleshooting SQL statement running slow </span> </a> </li> <li class=md-nav__item> <a href=#confluent-flink-query-profiler class=md-nav__link> <span class=md-ellipsis> Confluent Flink Query Profiler </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex> <span class=md-ellipsis> Java - Python </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Java - Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../table-api/ class=md-nav__link> <span class=md-ellipsis> Table API </span> </a> </li> <li class=md-nav__item> <a href=../datastream/ class=md-nav__link> <span class=md-ellipsis> DataStreams API </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../udf_sql/ class=md-nav__link> <span class=md-ellipsis> UDFs & PTFs </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> Deployment </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Deployment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/shift_left_utils/ class=md-nav__link> <span class=md-ellipsis> Manage CC Flink projects </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> More advanced topics </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> More advanced topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../stateful-func/ class=md-nav__link> <span class=md-ellipsis> Stateful function </span> </a> </li> <li class=md-nav__item> <a href=../cep/ class=md-nav__link> <span class=md-ellipsis> Complex Event Processing </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/data_as_a_product/ class=md-nav__link> <span class=md-ellipsis> Data as a product </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-studies/methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/shift_left_utils/ class=md-nav__link> <span class=md-ellipsis> Migrate to real-time processing tools </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/coe/ class=md-nav__link> <span class=md-ellipsis> Center of Excellence </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/flink_project_demos/c360/spark_project/ class=md-nav__link> <span class=md-ellipsis> A C360 data product demo </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Related_Technologies </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Related_Technologies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../techno/ccloud-flink/ class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Flink </span> </a> </li> <li class=md-nav__item> <a href=../../techno/cp-flink/ class=md-nav__link> <span class=md-ellipsis> Confluent Platform for Flink </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/kafka/ class=md-nav__link> <span class=md-ellipsis> Kafka Integration </span> </a> </li> <li class=md-nav__item> <a href=../../techno/cc-tableflow/ class=md-nav__link> <span class=md-ellipsis> Confluent TableFlow </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/techno/data/#data-related-technologies class=md-nav__link> <span class=md-ellipsis> Apache Iceberg </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/kafka-studies class=md-nav__link> <span class=md-ellipsis> Kafka-studies </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-studies class=md-nav__link> <span class=md-ellipsis> EDA </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#sources-of-information class=md-nav__link> <span class=md-ellipsis> Sources Of Information </span> </a> </li> <li class=md-nav__item> <a href=#common-patterns class=md-nav__link> <span class=md-ellipsis> Common Patterns </span> </a> <nav class=md-nav aria-label="Common Patterns"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filtering class=md-nav__link> <span class=md-ellipsis> Filtering </span> </a> </li> <li class=md-nav__item> <a href=#deduplication class=md-nav__link> <span class=md-ellipsis> Deduplication </span> </a> </li> <li class=md-nav__item> <a href=#transformation class=md-nav__link> <span class=md-ellipsis> Transformation </span> </a> </li> <li class=md-nav__item> <a href=#statement-set class=md-nav__link> <span class=md-ellipsis> Statement Set </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stateful-aggregations class=md-nav__link> <span class=md-ellipsis> Stateful aggregations </span> </a> <nav class=md-nav aria-label="Stateful aggregations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#group-by class=md-nav__link> <span class=md-ellipsis> Group BY </span> </a> </li> <li class=md-nav__item> <a href=#distinct class=md-nav__link> <span class=md-ellipsis> Distinct </span> </a> </li> <li class=md-nav__item> <a href=#array_agg class=md-nav__link> <span class=md-ellipsis> ARRAY_AGG </span> </a> </li> <li class=md-nav__item> <a href=#over class=md-nav__link> <span class=md-ellipsis> OVER </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#joins class=md-nav__link> <span class=md-ellipsis> Joins </span> </a> <nav class=md-nav aria-label=Joins> <ul class=md-nav__list> <li class=md-nav__item> <a href=#temporal-join class=md-nav__link> <span class=md-ellipsis> Temporal Join </span> </a> </li> <li class=md-nav__item> <a href=#interval-join class=md-nav__link> <span class=md-ellipsis> Interval Join </span> </a> </li> <li class=md-nav__item> <a href=#lateral-joins class=md-nav__link> <span class=md-ellipsis> Lateral Joins </span> </a> </li> <li class=md-nav__item> <a href=#multi-way-joins class=md-nav__link> <span class=md-ellipsis> Multi way joins </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> <li class=md-nav__item> <a href=#faqs class=md-nav__link> <span class=md-ellipsis> FAQs </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#windowing-table-value-functions class=md-nav__link> <span class=md-ellipsis> Windowing / Table Value Functions </span> </a> </li> <li class=md-nav__item> <a href=#sinkupsertmaterializer class=md-nav__link> <span class=md-ellipsis> SinkUpsertMaterializer </span> </a> </li> <li class=md-nav__item> <a href=#row-pattern-recognition class=md-nav__link> <span class=md-ellipsis> Row pattern recognition </span> </a> </li> <li class=md-nav__item> <a href=#confluent-cloud-specifics class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Specifics </span> </a> </li> <li class=md-nav__item> <a href=#analyzing-statements class=md-nav__link> <span class=md-ellipsis> Analyzing Statements </span> </a> <nav class=md-nav aria-label="Analyzing Statements"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#understand-the-physical-execution-plan-for-a-sql-query class=md-nav__link> <span class=md-ellipsis> Understand the physical execution plan for a SQL query </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting-sql-statement-running-slow class=md-nav__link> <span class=md-ellipsis> Troubleshooting SQL statement running slow </span> </a> </li> <li class=md-nav__item> <a href=#confluent-flink-query-profiler class=md-nav__link> <span class=md-ellipsis> Confluent Flink Query Profiler </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=flink-sql-dml>Flink SQL DML<a class=headerlink href=#flink-sql-dml title="Permanent link">&para;</a></h1> <details class="- info"> <summary>Updates</summary> <p>Created 10/24, Updated 12/20/24 Revised 12/06/24</p> </details> <p>This chapter offers continue on the best practices for implementing Flink SQL solutions, for Data Manipulation Language queries. DML is used to define statements which modify the data and donâ€™t change the metadata.</p> <h2 id=sources-of-information>Sources Of Information<a class=headerlink href=#sources-of-information title="Permanent link">&para;</a></h2> <ul> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/overview.html#flink-sql-queries>Confluent SQL documentation for DML samples</a> </li> <li><a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/insert/ >Apache Flink SQL</a></li> <li><a href=https://developer.confluent.io/tutorials/ >Confluent Developer Flink tutorials</a></li> <li><a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/dev/table/functions/systemfunctions/ >The Flink built-in system functions.</a></li> </ul> <h2 id=common-patterns>Common Patterns<a class=headerlink href=#common-patterns title="Permanent link">&para;</a></h2> <p>This is important to recall that a select applies to a stream of record so the results will change at each new record. A query as below will show the last top 10 orders, and when a new record arrives this list is updated. </p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span></code></pre></div> <details class=question open=open> <summary>What are the different SQL execution modes? (OSS)</summary> <p>Using previous table it is possible to count the elements in the table using:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>select</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=k>count</span><span class=o>`</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>pageviews</span><span class=p>;</span>
</span></code></pre></div> <p>and we get different behaviors depending of the execution mode:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;execution.runtime-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;batch&#39;</span><span class=p>;</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=o>#</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>one</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;execution.runtime-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;streaming&#39;</span><span class=p>;</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;sql-client.execution.result-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;table&#39;</span><span class=p>;</span>
</span></code></pre></div> <p>In changelog mode, the SQL Client doesn't just update the count in place, but instead displays each message in the stream of updates it's receiving from the Flink SQL runtime.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;sql-client.execution.result-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;changelog&#39;</span><span class=p>;</span>
</span></code></pre></div> <p><img alt src=../images/changelog-exec-mode.png></p> </details> <p><a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/05-changelog>See this lab in changelog mode</a> and <a href=../../concepts/flink-sql/#changelog-mode>this section in SQL concepts chapter</a>.</p> <h3 id=filtering>Filtering<a class=headerlink href=#filtering title="Permanent link">&para;</a></h3> <ul> <li><a href=https://developer.confluent.io/confluent-tutorials/filtering/flinksql/ >Start by looking at this Confluent tutorial</a> or <a href>The Apache Flink doc section</a></li> <li>SELECT ... FROM ... WHERE ... consists of column projections or filters and are stateless. Except if the output table has a a <code>retract</code> changelog while input is <code>upsert</code>, the sink will have a <code>changelog materializer</code> (see <a href=#sinkupsertmaterializer>section below.</a>)</li> <li>SELECT DISTINCT to remove duplicate rows. Which leads to keep state for each row.</li> </ul> <details class=question open=open> <summary>How to filter out records?</summary> <p>using the <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/select/ >WHERE clause</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>flight_events</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cancelled&#39;</span><span class=p>;</span>
</span></code></pre></div> <p>Count the number of events related to a cancelled flight (need to use one of the selected field as grouping key):</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>select</span><span class=w> </span><span class=n>fight_id</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cancelled_fl</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>FlightEvents</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cancelled&#39;</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>flight_id</span><span class=p>;</span>
</span></code></pre></div> <p>Recall that this results produces a dynamic table.</p> </details> <details class=question open=open> <summary>HAVING to filter after aggregation</summary> <p>The <code>HAVING</code> clause is used to filter results after the aggregation (i.e., like <code>GROUP BY</code>). It is similar to the <code>WHERE</code> clause, but while <code>WHERE</code> filters rows before aggregation, <code>HAVING</code> filters rows after aggregation. <div class="language-sql highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>product_page</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=n>click_id</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>num_of_times_viewed</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span><span class=w> </span><span class=n>user_id</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>num_of_users</span><span class=p>,</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=k>AVG</span><span class=p>(</span><span class=n>view_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avg_view_time</span><span class=p>,</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=k>MAX</span><span class=p>(</span><span class=n>view_time</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>max_view_time</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=k>FROM</span><span class=w> </span><span class=n>clicks</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>url</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=k>HAVING</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>click_id</span><span class=p>)</span><span class=w>  </span><span class=o>&gt;</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span></code></pre></div></p> </details> <details class=question open=open> <summary>How to combine records from multiple tables (UNION)?</summary> <p>When the two tables has the same number of columns of the same type, then we can combine them:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>T1</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>T2</span><span class=p>;</span>
</span></code></pre></div> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/set-logic.html#flink-sql-set-logic-union>See product documentation on Union</a>. Remember that UNION will apply distinct, and avoid duplicate, while UNION ALL will generate duplicates. </p> </details> <details class=question open=open> <summary>How to filter row that has column content not matching a regular expression?</summary> <p>Use <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/string-functions.html#flink-sql-regexp-function>REGEX</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>WITH</span><span class=w> </span><span class=n>filtered_data</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>REGEXP</span><span class=p>(</span><span class=n>user_agent</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;.*Opera/.*&#39;</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>        </span><span class=k>THEN</span><span class=w> </span><span class=k>TRUE</span><span class=w>  </span><span class=c1>-- Keep this row</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=k>FALSE</span><span class=w> </span><span class=c1>-- Filter out rows that match &quot;Opera/&quot;</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>    </span><span class=k>END</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>keep_row</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=k>FROM</span><span class=w> </span><span class=n>examples</span><span class=p>.</span><span class=n>marketplace</span><span class=p>.</span><span class=n>clicks</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=p>)</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=k>FROM</span><span class=w> </span><span class=n>filtered_data</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=k>WHERE</span><span class=w> </span><span class=n>keep_row</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>TRUE</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=info open=open> <summary>Navigate a hierarchical structure in a table</summary> <p>The unique table has node and ancestors representation. Suppose the graph represents a Procedure at the highest level, then an Operation, then a Phase and a Phase Step at the level 4. In the Procedures table we can have rows like:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>id, parent_ids, depth, information
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>&#39;id_1&#39;, [], 0 , &#39;procedure 1&#39;
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>&#39;id_2&#39;, [&#39;id_1&#39;], 1 , &#39;operation 1&#39;
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>&#39;id_3&#39;, [&#39;id_1&#39;,&#39;id_2&#39;], 2 , &#39;phase 1&#39;
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>&#39;id_4&#39;, [&#39;id_1&#39;,&#39;id_2&#39;,&#39;id_3&#39;], 3 , &#39;phase_step 1&#39;
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>&#39;id_5&#39;, [&#39;id_1&#39;,&#39;id_2&#39;,&#39;id_3&#39;], 3 , &#39;phase_step 2&#39;
</span></code></pre></div> <p>Suppose we want to extract the matching procedure_id, operation_id, phase_id, phase_step_id like <div class="language-text highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>id, procedure_id, operation_id, phase_id, phase_step_id, information
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>&#39;id_1&#39;, &#39;id_1&#39;, NULL, NULL, NULL, &#39;procedure 1&#39;
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>&#39;id_2&#39;, &#39;id_1&#39;, &#39;id_2&#39;, NULL, NULL, &#39;operation 1&#39;
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>&#39;id_3&#39;, &#39;id_1&#39;, &#39;id_2&#39;, &#39;id_3&#39;, NULL, &#39;phase 1&#39;
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>&#39;id_4&#39;, &#39;id_1&#39;, &#39;id_2&#39;, &#39;id_3&#39;, &#39;id_4&#39;, &#39;phase_step 1&#39;
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>&#39;id_5&#39;, &#39;id_1&#39;, &#39;id_2&#39;, &#39;id_3&#39;, &#39;id_5&#39;, &#39;phase_step 2&#39;
</span></code></pre></div></p> <p>if the depth is 3, then the response should have all ids populated, if 0 only the top level is returned.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>with</span><span class=w> </span><span class=o>`</span><span class=n>procedures</span><span class=o>`</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=s1>&#39;procedure 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_2&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=s1>&#39;operation 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_3&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>,</span><span class=s1>&#39;id_2&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phase 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_4&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>,</span><span class=s1>&#39;id_2&#39;</span><span class=p>,</span><span class=s1>&#39;id_3&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phase_step 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_5&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>,</span><span class=s1>&#39;id_2&#39;</span><span class=p>,</span><span class=s1>&#39;id_3&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phase_step 2&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=k>select</span><span class=w> </span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>    </span><span class=n>id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>    </span><span class=n>parent_id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>phase_step_id</span><span class=p>,</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>phase_id</span><span class=p>,</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>operation_id</span><span class=p>,</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>procedure_id</span><span class=p>,</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>    </span><span class=n>info</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>procedures</span><span class=o>`</span><span class=w> </span><span class=k>cross</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=n>parentIds</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>ids</span><span class=p>(</span><span class=n>parent_id</span><span class=p>)</span>
</span></code></pre></div> </details> <h3 id=deduplication>Deduplication<a class=headerlink href=#deduplication title="Permanent link">&para;</a></h3> <p>Deduplication will occur on <code>upsert</code> table with primary key: the last records per <code>$rowtime</code> or other timestamp will be kept. When the source table is in <code>append</code> mode, the approach is to use the <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/#aggregate-functions>ROW_NUMBER()</a> combined with <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/over-agg/ >OVER()</a>:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>unique_clicks</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>ip_address</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=n>FROM_UNIXTIME</span><span class=p>(</span><span class=n>click_ts_raw</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>click_timestamp</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=w>        </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ip_address</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=n>FROM_UNIXTIME</span><span class=p>(</span><span class=n>click_ts_raw</span><span class=p>))</span><span class=w> </span><span class=k>ASC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>rownum</span><span class=w> </span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>clicks</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>        </span><span class=p>)</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>rownum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span></code></pre></div> <ul> <li>The query is designed to identify and persist only the earliest record. Once the record is written to the table_deduped any subsequent events pertaining to the same <code>ip_address</code> are effectively discarded by the <code>WHERE rownum = 1</code> filter.</li> <li>ROW_NUMBER() Assigns an unique, sequential number to each row. It is part of the Top-N queries pattern.</li> <li>Use OVER aggregation to compute agg value for every input window clause and a filter condition to express a Top-N query. Combined with PARTITION BY clause, Flink supports a per group Top-N. </li> <li>The internal CTE add a row_num for each </li> <li>The subsequent <code>WHERE rownum = 1</code> clause filters the results to retain only the very first event observed for each unique <code>ip_address</code> based on its timestamp.</li> <li>The created table is an append table. There is no mechanism within this query to generate update or delete operations for records that have already been processed. Even if the underlying <code>clicks</code> table has a primary key defined, the transformation applied here dictates that the <code>unique_clicks</code> table will only ever grow by appending new, unique <code>ip_address</code> entries.</li> <li>If the sorting was DESC when a new record arrive a retraction/update record is emitted. </li> <li>If after deduplication, the upsert sink needs to have the same key as the partition keys used. </li> </ul> <p><a href=https://docs.confluent.io/cloud/current/flink/how-to-guides/deduplicate-rows.html#flink-sql-deduplicate-topic-action>See this example</a> in the Confluent product documentation which demonstrates there is no duplicate in the query result with <code>select * from dedup_table;</code> returns 8 messages. Same in the Kafka topic there are 8 messages . </p> <p>But it does not demonstrate the last message is kept. The <a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/00-basic-sql#deduplication-example>deduplication sample</a> demonstrates that an upsert table is already removing duplicates, and keep the last record per key. </p> <ul> <li>Confluent Cloud has limitations: the order by can only be timestamp in ASC mode.</li> <li>Example of deduplication on OSS Flink where order can apply to any column type. <div class="language-sql highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>        </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>        </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>            </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>emp_id</span><span class=w> </span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>            </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>emp_id</span><span class=w> </span><span class=k>DESC</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>row_num</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=p>)</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>row_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span>
</span></code></pre></div></li> </ul> <h3 id=transformation>Transformation<a class=headerlink href=#transformation title="Permanent link">&para;</a></h3> <p>Some <strong>important resources:</strong></p> <ul> <li><a href=https://docs.confluent.io/cloud/current/flink/how-to-guides/transform-topic.html#transform-a-topic-with-af-long>Transform a Topic with Confluent Cloud for Apache Flink - product doc</a> to demonstrate topic transformation from the Data Portal -&gt; Actions -&gt; Transform Topic, which creates a CTAS Flink SQL statment and automatically deploys it to the configured computepool. This is very efficient to do avro to json, field rename, and primary key reallocation.</li> </ul> <details class=question open=open> <summary>How to transform a field representing epoch to a timestamp?</summary> <p>epoch is a BIGINT.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=w> </span><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=n>FROM_UNIXTIME</span><span class=p>(</span><span class=n>click_ts_epoch</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>click_ts</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to change a date string to a timestamp?</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=s1>&#39;2024-11-20 12:34:568Z&#39;</span><span class=p>),</span>
</span></code></pre></div> <div class="language-sql highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=n>to_timestamp</span><span class=p>(</span><span class=n>transaction_date</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>tx_date</span><span class=p>,</span><span class=w> </span><span class=c1>-- bigint</span>
</span></code></pre></div> <p>See all the <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/datetime-functions.html>date and time functions</a>.</p> </details> <details class=question open=open> <summary>How to compare a date field with current system time?</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=k>WHEN</span><span class=w> </span><span class=n>TIMESTAMPDIFF</span><span class=p>(</span><span class=k>day</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=n>event_launch_date</span><span class=p>,</span><span class=w> </span><span class=n>now</span><span class=p>())</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>120</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=p>...</span>
</span></code></pre></div> <p>If the target table is set with a <code>changelog mode = upsert</code>, the use of the now() function is problematic because the exact execution time is not deterministic for each row. So the above statement works only for <code>append</code> mode.</p> </details> <details class=question open=open> <summary>How to extract the number of DAY, from a date field and now?</summary> <p>The only diff is on timestamp. So need to first to cast the DATE column to a ts, and then use CURRENT_DATE and the DAY dimension. <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/#temporal-functions>See the supported dimensions (SECOND, MINUTE, HOUR, DAY, MONTH, or YEAR)</a> <div class="language-sql highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=w> </span><span class=n>TIMESTAMPDIFF</span><span class=p>(</span><span class=k>DAY</span><span class=p>,</span><span class=w> </span><span class=k>CAST</span><span class=p>(</span><span class=n>created_date</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>)),</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>days_since_launch</span><span class=p>,</span>
</span></code></pre></div></p> </details> <details class=question open=open> <summary>How to access element of an array of rows?</summary> <p>The table has a column that is an array of rows. <div class="language-sql highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>my_table</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>    </span><span class=n>key_col</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>    </span><span class=n>nested_data</span><span class=w> </span><span class=nb>ARRAY</span><span class=o>&lt;</span><span class=k>ROW</span><span class=o>&lt;</span><span class=n>id</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=n>STRING</span><span class=o>&gt;&gt;</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=p>)</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(...)</span>
</span></code></pre></div></p> <p>To create one record per row within the array, so exploding the array, use CROSS JOIN UNNEST: <div class="language-sql highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=w> </span><span class=k>SELECT</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>key_col</span><span class=p>,</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=w>    </span><span class=n>unnested_row</span><span class=p>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=w>    </span><span class=n>unnested_row</span><span class=p>.</span><span class=n>name</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=k>FROM</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=w>    </span><span class=n>my_table</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>t</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>UNNEST</span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=n>nested_data</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>unnested_row</span><span class=p>;</span>
</span></code></pre></div></p> <p>Each row in the nested_data array will be a row in the output table with the matching key_col. </p> </details> <details class=question open=open> <summary>How to access json data from a string column being a json object?</summary> <p>Use json_query function in the select.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=w> </span><span class=n>json_query</span><span class=p>(</span><span class=n>task</span><span class=p>.</span><span class=n>object_state</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$.dueDate&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>due_date</span><span class=p>,</span>
</span></code></pre></div> <p>Use <code>json_value()</code> instead if the column content is a dict or json {}.</p> </details> <details class=question open=open> <summary>How to transform a json array column (named data) into an array to then generate n rows?</summary> <p>Returning an array from a json string: <div class="language-sql highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=n>json_query</span><span class=p>(</span><span class=o>`</span><span class=k>data</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$&#39;</span><span class=w> </span><span class=n>RETURNING</span><span class=w> </span><span class=nb>ARRAY</span><span class=o>&lt;</span><span class=n>STRING</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>anewcolumn</span>
</span></code></pre></div></p> <p>To create as many rows as there are elements in the nested array: <div class="language-sql highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>existing_column</span><span class=p>,</span><span class=w> </span><span class=n>anewcolumn</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=k>table_name</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=k>cross</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=k>unnest</span><span class=w> </span><span class=p>(</span><span class=n>json_query</span><span class=p>(</span><span class=o>`</span><span class=k>data</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$&#39;</span><span class=w> </span><span class=n>RETURNING</span><span class=w> </span><span class=nb>ARRAY</span><span class=o>&lt;</span><span class=n>STRING</span><span class=o>&gt;</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>anewcolumn</span><span class=p>)</span>
</span></code></pre></div></p> <p>UNNEST returns a new row for each element in the array <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/joins/#array-multiset-and-map-expansion>See multiset expansion doc</a></p> </details> <details class=question open=open> <summary>How to implement the equivalent of SQL explode?</summary> <p>SQL EXPLODE creates a row for each element in the array or map, and ignore null or empty values in array. <div class="language-sql highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>explode</span><span class=p>(</span><span class=n>col1</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=nb>array</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>20</span><span class=p>)),</span><span class=w> </span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></code></pre></div></p> <p>SQL has also EXPLODE_OUTER, which returns all values in array including null or empty.</p> <p>To translate this to Flink SQL we can use MAP_ENTRIES and MAP_FROM_ARRAYS. MAP_ENTRIES returns an array of all entries in the given map. While MAP_FROM_ARRAYS returns a map created from an arrays of keys and values. <div class="language-sql highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=k>select</span><span class=w> </span><span class=n>map_entries</span><span class=p>(</span><span class=n>map_from_arrays</span><span class=p>())</span>
</span></code></pre></div></p> </details> <details class=question open=open> <summary>How to use conditional functions?</summary> <p><a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/#conditional-functions>Flink has built-in conditional functions</a> (See also <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/conditional-functions.html>Confluent support</a>) and specially the CASE WHEN:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>    </span><span class=o>*</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>stocks</span><span class=o>`</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>    </span><span class=k>WHERE</span><span class=w>  </span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;high&#39;</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=o>&lt;=</span><span class=mi>200</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>150</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;medium&#39;</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=s1>&#39;low&#39;</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>    </span><span class=k>END</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to mask a field?</summary> <p>Create a new table from the existing one, and then use REGEXP_REPLACE to mask an existing attribute</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>users_msk</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=n>users</span><span class=p>;</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users_msk</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=p>...,</span><span class=w> </span><span class=n>REGEXP_REPLACE</span><span class=p>(</span><span class=n>credit_card</span><span class=p>,</span><span class=s1>&#39;(\w)&#39;</span><span class=p>,</span><span class=s1>&#39;*&#39;</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>credit_card</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=p>;</span>
</span></code></pre></div> </details> <h3 id=statement-set>Statement Set<a class=headerlink href=#statement-set title="Permanent link">&para;</a></h3> <p>The benefit of bundling statements in a single set is to reduce the repeated read from the source for each Insert. A single read from the source is executed and shared with all downstream INSERTS.</p> <p>Do not use <code>Statement Set</code> when the source are different for all statements within the Statement Sets. Take into account that within the statement set if one statement fails, then all queries fail. The state is shared by all the statements within Statement set, so one stateful query can impact all other statements.</p> <details class=question open=open> <summary>How to manage late message to be sent to a DLQ using Statement Set?</summary> <p>First, create a DLQ table like <code>late_orders</code> based on the order table:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=w>    </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>late_orders</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=w>    </span><span class=k>with</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=w>        </span><span class=s1>&#39;connector&#39;</span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&#39;</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=w>    </span><span class=p>)</span><span class=w> </span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=w>    </span><span class=k>LIKE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>(</span><span class=k>EXCLUDING</span><span class=w> </span><span class=k>OPTIONS</span><span class=p>)</span>
</span></code></pre></div> <p>Groups the main stream processing and the late arrival processing in a statement set:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=k>EXECUTE</span><span class=w> </span><span class=k>STATEMENT</span><span class=w> </span><span class=k>SET</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=k>BEGIN</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=w>    </span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>late_orders</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>CURRENT_WATERMARK</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>);</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=w>    </span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>order_counts</span><span class=w> </span><span class=c1>-- the sink table</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>window_time</span><span class=p>,</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span><span class=n>TUMBLE</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>MINUTE</span><span class=p>))</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=w>        </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=n>window_time</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=k>END</span>
</span></code></pre></div> </details> <h2 id=stateful-aggregations>Stateful aggregations<a class=headerlink href=#stateful-aggregations title="Permanent link">&para;</a></h2> <p>An aggregate function computes a single result from multiple input rows.</p> <h3 id=group-by>Group BY<a class=headerlink href=#group-by title="Permanent link">&para;</a></h3> <p>Classical SQL grouping of records, but with Streaming the state may grow infinitely. The size will depend of the # of groups and the amount of data to keep per group. <code>group by</code> generates upsert events as it manages key-value and repartitions data.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=k>EXPLAIN</span><span class=w> </span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=w>  </span><span class=n>account_number</span><span class=p>,</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=w>  </span><span class=n>transaction_type</span><span class=p>,</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=w>  </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>transactions</span><span class=o>`</span><span class=w> </span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>  </span><span class=k>where</span><span class=w> </span><span class=n>transaction_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;withdrawal&#39;</span><span class=w> </span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>  </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>account_number</span><span class=p>,</span><span class=w>  </span><span class=n>transaction_type</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=k>HAVING</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>5000</span>
</span></code></pre></div> <p>The physical plan looks like <div class="language-text highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>== Physical Plan ==
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>StreamSink [6]
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>  +- StreamCalc [5]
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>    +- StreamGroupAggregate [4]
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>      +- StreamExchange [3]
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>        +- StreamCalc [2]
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>          +- StreamTableSourceScan [1]
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a>== Physical Details ==
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a>[1] StreamTableSourceScan
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a>Table: `j9r-env`.`j9r-kafka`.`transactions`
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a>Primary key: (txn_id)
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a>Changelog mode: append
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a>Upsert key: (txn_id)
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a>State size: low
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a>Startup mode: earliest-offset
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a>Key format: avro-registry
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a>Key registry schemas: (:.:transactions/100220)
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a>Value format: avro-registry
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a>Value registry schemas: (:.:transactions/100219)
</span><span id=__span-31-23><a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a>
</span><span id=__span-31-24><a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a>[4] StreamGroupAggregate
</span><span id=__span-31-25><a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a>Changelog mode: retract
</span><span id=__span-31-26><a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a>Upsert key: (account_number,transaction_type)
</span><span id=__span-31-27><a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a>State size: medium
</span><span id=__span-31-28><a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a>State TTL: never
</span><span id=__span-31-29><a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a>
</span><span id=__span-31-30><a id=__codelineno-31-30 name=__codelineno-31-30 href=#__codelineno-31-30></a>[5] StreamCalc
</span><span id=__span-31-31><a id=__codelineno-31-31 name=__codelineno-31-31 href=#__codelineno-31-31></a>Changelog mode: retract
</span><span id=__span-31-32><a id=__codelineno-31-32 name=__codelineno-31-32 href=#__codelineno-31-32></a>Upsert key: (account_number,transaction_type)
</span><span id=__span-31-33><a id=__codelineno-31-33 name=__codelineno-31-33 href=#__codelineno-31-33></a>
</span><span id=__span-31-34><a id=__codelineno-31-34 name=__codelineno-31-34 href=#__codelineno-31-34></a>[6] StreamSink
</span><span id=__span-31-35><a id=__codelineno-31-35 name=__codelineno-31-35 href=#__codelineno-31-35></a>Table: Foreground
</span><span id=__span-31-36><a id=__codelineno-31-36 name=__codelineno-31-36 href=#__codelineno-31-36></a>Changelog mode: retract
</span><span id=__span-31-37><a id=__codelineno-31-37 name=__codelineno-31-37 href=#__codelineno-31-37></a>Upsert key: (account_number,transaction_type)
</span><span id=__span-31-38><a id=__codelineno-31-38 name=__codelineno-31-38 href=#__codelineno-31-38></a>State size: low
</span></code></pre></div></p> <h3 id=distinct>Distinct<a class=headerlink href=#distinct title="Permanent link">&para;</a></h3> <p>Remove duplicate before doing the aggregation:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=n>ARRAY_AGG</span><span class=p>(</span><span class=k>DISTINCT</span><span class=w> </span><span class=n>user_name</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>persons</span>
</span></code></pre></div> <h3 id=array_agg>ARRAY_AGG<a class=headerlink href=#array_agg title="Permanent link">&para;</a></h3> <p>Array aggregation refers to the process of combining multiple data elements into a single array structure. The goal is to regroup multiple data points together. Array aggregation plays a pivotal role in data processing due to its ability to manage and analyze vast amounts of information effectively</p> <p>This <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/#aggregate-functions>Flink ARRAY_AGG, aggregate function</a> is a common function used in a lot of record transformation implementations. The function returns an array with elements coming from multiple rows from the input table. </p> <p>Let start by a simple array indexing (the index is between 1 to n_element). Below, the <code>values array</code> creates test data into a memory table aliased a <code>T</code> with a column named <code>array_field</code>:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>array_field</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>((</span><span class=k>VALUES</span><span class=w> </span><span class=nb>ARRAY</span><span class=p>[</span><span class=mi>5</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=p>]))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=p>(</span><span class=n>array_field</span><span class=p>)</span>
</span></code></pre></div> <p>The following SQL, is creating a view with an <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/#aggregate-functions>array of aggregates</a>, which in this case, is concatenating the urls for each user_id over a 1 minute tumble window.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>visited_pages_per_minute</span><span class=w> </span><span class=k>AS</span><span class=w> </span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=w>    </span><span class=n>window_time</span><span class=p>,</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=w>    </span><span class=n>user_id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=w>    </span><span class=n>ARRAY_AGG</span><span class=p>(</span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>urls</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span><span class=n>TUMBLE</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=p>.</span><span class=n>marketplace</span><span class=p>.</span><span class=n>clicks</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>MINUTE</span><span class=p>))</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=n>window_time</span><span class=p>,</span><span class=w> </span><span class=n>user_id</span><span class=p>;</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=c1>-- once the view is created</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>visited_pages_per_minute</span><span class=p>;</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=c1>-- it is possible to expand an array into multiple rows using cross join unnest</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=k>SELECT</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>window_time</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=n>u</span><span class=p>.</span><span class=n>url</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>visited_pages_per_minute</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>v</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>UNNEST</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>urls</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>u</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></code></pre></div> <p>One thing important is that new clicks for the same user_id with new url, will create a new output record with the aggregated array. See <a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/03-nested-row/cc-array-agg>cc-array-agg study</a>.</p> <p>To optimize the processing it is recommended to deduplicate and/or filter records before computing the aggregation, and using Flink View is a good example:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=k>create</span><span class=w> </span><span class=k>view</span><span class=w> </span><span class=n>suites_versioned</span><span class=w> </span><span class=k>as</span><span class=w> </span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=k>select</span><span class=w>  </span><span class=n>suite_id</span><span class=p>,</span><span class=w> </span><span class=n>suite_name</span><span class=p>,</span><span class=w> </span><span class=n>asset_id</span><span class=p>,</span><span class=w> </span><span class=n>asset_name</span><span class=p>,</span><span class=w> </span><span class=n>asset_price_min</span><span class=p>,</span><span class=w> </span><span class=n>asset_price_max</span><span class=p>,</span><span class=w> </span><span class=n>ts_ltz</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=k>from</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>       </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>suite_id</span><span class=p>,</span><span class=w> </span><span class=n>asset_id</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ts_ltz</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>rn</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=w>        </span><span class=k>from</span><span class=w> </span><span class=n>suites</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>rn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span></code></pre></div> <p>Then the array aggregation:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=k>select</span><span class=w> </span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=w>    </span><span class=n>suite_id</span><span class=p>,</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=w>    </span><span class=n>ARRAY_AGG</span><span class=p>(</span><span class=k>ROW</span><span class=w> </span><span class=p>(</span><span class=n>asset_id</span><span class=p>,</span><span class=w> </span><span class=n>asset_name</span><span class=p>,</span><span class=w>  </span><span class=k>ROW</span><span class=p>(</span><span class=n>asset_price_min</span><span class=p>,</span><span class=w> </span><span class=n>asset_price_max</span><span class=p>)))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>asset_data</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=w>    </span><span class=k>max</span><span class=p>(</span><span class=n>ts_ltz</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>ts_ltz</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=k>from</span><span class=w> </span><span class=n>suites_versioned</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>suite_id</span><span class=p>;</span>
</span></code></pre></div> <p>As seen in example above the type within the array can be a row and sub-row. <a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/03-nested-row/cc-array-agg/cc_array_agg_on_row.sql>See SQL examples</a></p> <h3 id=over>OVER<a class=headerlink href=#over title="Permanent link">&para;</a></h3> <p><a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/dev/table/sql/queries/over-agg/ >OVER aggregations</a> computes an aggregated value for every input row <strong>over a range</strong> of ordered rows. It does not reduce the number of resulting rows, as GROUP BY does, but produces one result for every input row. </p> <p>OVER specifies the <strong>time window</strong> over which the aggregation is performed. A classical example is to get a moving sum or average: the number of orders in the last 10 seconds: </p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=w>    </span><span class=n>order_id</span><span class=p>,</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=w>    </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>,</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_price_ten_secs</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_orders_ten_secs</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=n>WINDOW</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=w>    </span><span class=n>RANGE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>SECONDS</span><span class=w> </span><span class=n>PRECEDING</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>CURRENT</span><span class=w> </span><span class=k>ROW</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=p>)</span>
</span></code></pre></div> <p>The source topic needs to be append mode as over window operaton does not supporting retraction/update semantic.</p> <p>The changelog mode, of the output of OVER is <code>append</code>. This is helpful when we need to act on each input row, but consider some time interval. </p> <p>To get the order exceeding some limits for the first time and then when the computed aggregates go below other limits. <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/aggregate-functions.html#lag>LAG</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1>-- compute the total price and # of orders for a period of 10s for each customer</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=k>WITH</span><span class=w> </span><span class=n>orders_ten_secs</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w> </span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=w>    </span><span class=n>order_id</span><span class=p>,</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>    </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>,</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_price_ten_secs</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_orders_ten_secs</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=n>WINDOW</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=w>    </span><span class=n>RANGE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>SECONDS</span><span class=w> </span><span class=n>PRECEDING</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>CURRENT</span><span class=w> </span><span class=k>ROW</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=p>),</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=c1>-- get previous orders and current order per customer</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=n>orders_ten_secs_with_lag</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=w>    </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=w>    </span><span class=n>LAG</span><span class=p>(</span><span class=n>total_price_ten_secs</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_price_ten_secs_lag</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=w>    </span><span class=n>LAG</span><span class=p>(</span><span class=n>total_orders_ten_secs</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_orders_ten_secs_lag</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=k>FROM</span><span class=w> </span><span class=n>orders_ten_secs</span>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=n>WINDOW</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span>
</span><span id=__span-38-26><a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-38-27><a id=__codelineno-38-27 name=__codelineno-38-27 href=#__codelineno-38-27></a><span class=c1>-- Filter orders when the order price and number of orders were above some limits for previous or current order aggregates</span>
</span><span id=__span-38-28><a id=__codelineno-38-28 name=__codelineno-38-28 href=#__codelineno-38-28></a><span class=p>)</span>
</span><span id=__span-38-29><a id=__codelineno-38-29 name=__codelineno-38-29 href=#__codelineno-38-29></a><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;BLOCK&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>action</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>updated_at</span><span class=w> </span>
</span><span id=__span-38-30><a id=__codelineno-38-30 name=__codelineno-38-30 href=#__codelineno-38-30></a><span class=k>FROM</span><span class=w> </span><span class=n>orders_ten_secs_with_lag</span><span class=w> </span>
</span><span id=__span-38-31><a id=__codelineno-38-31 name=__codelineno-38-31 href=#__codelineno-38-31></a><span class=k>WHERE</span><span class=w> </span>
</span><span id=__span-38-32><a id=__codelineno-38-32 name=__codelineno-38-32 href=#__codelineno-38-32></a><span class=w>    </span><span class=p>(</span><span class=n>total_price_ten_secs</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>300</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_price_ten_secs_lag</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>300</span><span class=p>)</span><span class=w> </span><span class=k>OR</span>
</span><span id=__span-38-33><a id=__codelineno-38-33 name=__codelineno-38-33 href=#__codelineno-38-33></a><span class=w>    </span><span class=p>(</span><span class=n>total_orders_ten_secs</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_orders_ten_secs_lag</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-38-34><a id=__codelineno-38-34 name=__codelineno-38-34 href=#__codelineno-38-34></a><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w> </span>
</span><span id=__span-38-35><a id=__codelineno-38-35 name=__codelineno-38-35 href=#__codelineno-38-35></a><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;UNBLOCK&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>action</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>updated_at</span><span class=w> </span>
</span><span id=__span-38-36><a id=__codelineno-38-36 name=__codelineno-38-36 href=#__codelineno-38-36></a><span class=k>FROM</span><span class=w> </span><span class=n>orders_ten_secs_with_lag</span><span class=w> </span>
</span><span id=__span-38-37><a id=__codelineno-38-37 name=__codelineno-38-37 href=#__codelineno-38-37></a><span class=k>WHERE</span><span class=w> </span>
</span><span id=__span-38-38><a id=__codelineno-38-38 name=__codelineno-38-38 href=#__codelineno-38-38></a><span class=w>    </span><span class=p>(</span><span class=n>total_price_ten_secs</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>300</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_price_ten_secs_lag</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>300</span><span class=p>)</span><span class=w> </span><span class=k>OR</span>
</span><span id=__span-38-39><a id=__codelineno-38-39 name=__codelineno-38-39 href=#__codelineno-38-39></a><span class=w>    </span><span class=p>(</span><span class=n>total_orders_ten_secs</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_orders_ten_secs_lag</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>5</span><span class=p>);</span>
</span></code></pre></div> <details class=question open=open> <summary>When and how to use custom watermark?</summary> <p>Developer should use their own <a href=https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#watermark-clause>watermark strategy</a> when there are not a lot of records per topic/partition, there is a need for a large watermark delay, and need to use another timestamp. The default watermark strategy in SOUCE_WATERMARK(), a watermark defined by the source. The common strategy used is the <code>maximim-out-of-orderness</code> to allow messages arriving later to be part of the window, to ensure more accurate results, as a tradeoff of latency. It can be defined using:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>&lt;</span><span class=k>table_name</span><span class=o>&gt;</span><span class=w> </span><span class=k>MODIFY</span><span class=w> </span><span class=n>WATERMARK</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;20&#39;</span><span class=w> </span><span class=n>SECONDS</span>
</span></code></pre></div> <p>The minimum out-of-orderness is 50ms and can be set up to 7 days. See <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/datetime-functions.html#flink-sql-source-watermark-function>Confluent documentation.</a> </p> </details> <h2 id=joins>Joins<a class=headerlink href=#joins title="Permanent link">&para;</a></h2> <p>When doing a join in a database, the result reflects the state of the join at the time we execute the query. In streaming, as both side of a join receive new rows, both side of joins need to continuously change. This is a <strong>continuous query on dynamic tables</strong>, where the engine needs to keep a lot of state: each row of each table. </p> <p>This is the common join we do between two tables: </p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>order_type</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>opening_value</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>transactions</span><span class=w> </span><span class=n>t</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>stocks</span><span class=w> </span><span class=n>s</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=k>ON</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>stockid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>id</span>
</span></code></pre></div> <p>On the left side, the fact table, has high velocity of changes, but the events are immutables, while on the right side, the dimension, the new records arrive slowly.</p> <p>When doing a join, Flink needs to fully materialize both the right and left of the join tables in state, which may cost a lot of memory, because if a row in the left-hand table (LHT), also named the <strong>probe side</strong>, is updated, the operator needs to emit an updated match for all matching rows in the right-hand table (RHT) or <strong>build side</strong>. The cardinality of right side will be mostly bounded at a given point of time, but the left side may vary a lot. A join emits matching rows to downstream operator.</p> <p>The key points to keep in mind are:</p> <ul> <li>Regular joins typically produce a full cross-product of all matching records. However, in streaming scenarios, this behavior is often undesirable, for example if you want to enrich an event with additional information.</li> <li>The order of joins is important, try to get the first join done on table with the lowest update frequency.</li> <li>Cross join makes the query fails</li> <li>When the RHS is an upsert table, the result will be upsert too. Which means a result will be re-emitted if the RHS change. To avoid that we need to take the reference data, RHS, in effect at time of the event on LHS. The result is becoming <strong>time-versioned</strong>.</li> </ul> <h3 id=temporal-join>Temporal Join<a class=headerlink href=#temporal-join title="Permanent link">&para;</a></h3> <p>A <a href=https://docs.confluent.io/cloud/current/flink/reference/queries/joins.html#temporal-joins>temporal join</a> joins one table with another table that is updated over time. This join is made possible by linking both tables using a time attribute, which allows the join to consider the historical changes in the table. </p> <div class=codehilite><pre><span></span><code><span class=err>```</span><span class=nx>sql</span>
<span class=nx>insert</span><span class=w> </span><span class=nx>into</span><span class=w> </span><span class=nx>enriched_transactions</span>
<span class=nx>SELECT</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>amount</span><span class=p>,</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>order_type</span><span class=p>,</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>opening_value</span><span class=w> </span><span class=nx>FROM</span><span class=w> </span><span class=nx>transactions</span><span class=w> </span><span class=nx>t</span>
<span class=nx>LEFT</span><span class=w> </span><span class=nx>JOIN</span><span class=w> </span><span class=nx>stocks</span><span class=w> </span><span class=nx>s</span><span class=w> </span><span class=nx>FOR</span><span class=w> </span><span class=nx>SYSTEM_TIME</span><span class=w> </span><span class=nx>AS</span><span class=w> </span><span class=nx>OF</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>purchase_ts</span>
<span class=nx>ON</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>stockid</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>id</span>
<span class=err>```</span>
</code></pre></div> <ul> <li>The above query is a Temporal join. Temporal joins help to reduce the state size, as we need to keep only recent records on both side. The time will be linked to the watermark progress. If the opening_value of the stock change over time, it will not trigger update to the previously generated enriched transactions. </li> <li> <p>Temporal JOINs must include all of the PRIMARY KEY columns of the versioned (right-side) table: the ON conditions need to include exactly the same primary key columns: <code>sql create table dim_rule_config( tenant_id STRING NOT NULL, rule_id BIGINT NOT NULL, rule_name STRING NOT NULL, parameter_id BIGINT NOT NULL, paremeter_value BIGINT, primary key (tenant_id, rule_id, parameter_id) not enforced ) # joining in a separate DML ... from extended_sensors s left join dim_rule_config for system as of s.event_ts as rule ON s.tenant_id = rule.tenant_id AND s.rule_id = rule.rule_id AND s.parameter_id = rule.parameter_id</code></p> <p>The extended_sensors is a CTE to add specific constant columns, as the ON conditions need to apply to columns on on the LHS. So to be able to search for specific rule id and parameter id, the approach is to create a CTE: <div class="language-sql highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=k>with</span><span class=w> </span><span class=n>extended_sensors</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=w>    </span><span class=k>select</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=w>    </span><span class=p>...</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=n>sensors</span><span class=w> </span><span class=n>attributes</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=w>    </span><span class=mi>10</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>rule_id</span><span class=p>,</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=w>    </span><span class=mi>1</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parameter_id</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>sensors</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=p>)</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=p>...</span><span class=w> </span>
</span></code></pre></div></p> <p><a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/04-joins/rule_match_on_sensors/README.md>See also this code sample for an example of rule based control</a> with temporal joins and contant columns.</p> </li> <li> <p>When the LHS of the temporal join is upsert then the sink table needs to be retract. While if it is an append changelog then the sink should be append too.</p> </li> <li>INNER JOIN is a cartesian product.</li> <li>OUTER joins like left, right or full, may generate records with empty columns for non-matching row.</li> </ul> <h3 id=interval-join>Interval Join<a class=headerlink href=#interval-join title="Permanent link">&para;</a></h3> <ul> <li> <p>Interval joins are particularly useful when working with unbounded data streams. Here is an example for orders and payments, where <div class="language-sql highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>valid_orders</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=w>    </span><span class=n>order_id</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=w>    </span><span class=n>customer_id</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=w>    </span><span class=n>product_id</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=w>    </span><span class=n>order_time</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=w>    </span><span class=n>payment_time</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=w>    </span><span class=n>amount</span><span class=w> </span><span class=nb>DECIMAL</span><span class=p>,</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=w>    </span><span class=n>WATERMARK</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>order_time</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>order_time</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;5&#39;</span><span class=w> </span><span class=k>SECOND</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>unique_orders</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>product_id</span><span class=p>,</span><span class=w> </span><span class=n>unique_orders</span><span class=p>.</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>order_time</span><span class=p>,</span><span class=w> </span><span class=n>payment_time</span><span class=p>,</span><span class=w> </span><span class=n>amount</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=k>FROM</span><span class=w> </span><span class=n>unique_orders</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=w>    </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>payments</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>unique_orders</span><span class=p>.</span><span class=n>order_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>payments</span><span class=p>.</span><span class=n>order_id</span>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>unique_orders</span><span class=p>.</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>payment_time</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>MINUTES</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>payment_time</span><span class=p>;</span>
</span></code></pre></div></p> </li> <li> <p>INTERVAL JOIN requires at least one equi-join predicate and a join condition that bounds the time on both sides. <div class="language-sql highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>order_type</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>opening_value</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>transactions</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>stocks</span><span class=w> </span><span class=n>s</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=k>WHERE</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>stockid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;6&#39;</span><span class=w> </span><span class=n>HOURS</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>ts</span>
</span></code></pre></div></p> </li> </ul> <h3 id=lateral-joins>Lateral Joins<a class=headerlink href=#lateral-joins title="Permanent link">&para;</a></h3> <p>LATERAL TABLE clause is used to invoke a Table-Valued Function (TVF) or a <a href=../udf_sql/ >User-Defined Table Function</a> (UDTF) for every row of a base (outer) table. The Lateral Join evaluates a subquery or a function for each row of the first table, and the result of that evaluation is then joined back to the original row. The UDTF/TVF on the right side of the join can reference columns from the table on the left side.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=k>SELECT</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=w>    </span><span class=n>tf</span><span class=p>.</span><span class=o>*</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=k>FROM</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=w>    </span><span class=n>input_table</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>t</span><span class=p>,</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=w>    </span><span class=k>LATERAL</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span><span class=n>udtf_function</span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=n>column_a</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>column_b</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>tf</span><span class=p>(</span><span class=n>output_column_1</span><span class=p>,</span><span class=w> </span><span class=n>output_column_2</span><span class=p>)</span>
</span></code></pre></div> <p>We can combine the LATERAL TABLE with different join types to control which rows are preserved</p> <table> <thead> <tr> <th>Joins</th> <th>Behavior</th> </tr> </thead> <tbody> <tr> <td>CROSS JOIN LATERAL TABLE(...)</td> <td>If the UDTF returns zero rows for a given input row, the original row from the outer table is discarded.</td> </tr> <tr> <td>LEFT JOIN LATERAL</td> <td>Returns all rows from the outer table, even if the UDTF produces zero rows.</td> </tr> </tbody> </table> <p>The Lateral Table allows to dynamically transform stream records in a row-by-row fashion, which is often difficult with standard joins.</p> <h3 id=multi-way-joins>Multi way joins<a class=headerlink href=#multi-way-joins title="Permanent link">&para;</a></h3> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/joins.html#enabling-multi-way-joins>See Confluent Flink SQL documentation</a> for multi-way joins as part of optimizing the flink state. Need to add annotations: <div class="language-sql highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=k>SELECT</span><span class=w> </span><span class=cm>/*+ MULTI_JOIN(o, c, a) */</span><span class=w> </span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=k>JOIN</span><span class=w> </span><span class=n>customers</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>customer_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>id</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=k>JOIN</span><span class=w> </span><span class=n>addresses</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>customer_id</span><span class=p>;</span>
</span></code></pre></div></p> <h3 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h3> <p>Here is a list of important tutorials on Joins:</p> <ul> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/joins.html>Confluent Cloud: video on joins</a> with details on fow joins work.</li> <li><a href=https://developer.confluent.io/tutorials/join-a-stream-to-a-stream/flinksql.html>Confluent -developer: How to join streams</a>. The matching content is in <a href=https://github.com/jbcodeforce/flink-studies/tree/master/flink-sql/04-joins>flink-sql/04-joins folder</a> for Confluent Cloud or Platform for Flink. This folder also includes more SQL exercises.</li> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/joins.html#temporal-joins>Confluent temporal join documentation.</a></li> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/window-join.html>Window Join Queries in Confluent Cloud for Apache Flink</a></li> <li><a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/09-temporal-joins>Temporal Join Study in this repo.</a></li> </ul> <h3 id=faqs>FAQs<a class=headerlink href=#faqs title="Permanent link">&para;</a></h3> <details class=info open=open> <summary>Inner knowledge on temporal join</summary> <p>Event-time temporal joins are used to join two or more tables based on a <strong>common</strong> event time (in one of the record table or the kafka record: <code>$rowtime</code> system column). With an event-time attribute, the operator can retrieve the value of a key as it was at some point in the past. The right-side, versioned table, stores all versions, identified by time, since the last watermark.</p> <p>The temporal Flink sql looks like:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=k>SELECT</span><span class=w> </span><span class=p>[</span><span class=n>column_list</span><span class=p>]</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=k>FROM</span><span class=w> </span><span class=n>table1</span><span class=w> </span><span class=p>[</span><span class=k>AS</span><span class=w> </span><span class=o>&lt;</span><span class=n>alias1</span><span class=o>&gt;</span><span class=p>]</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=p>[</span><span class=k>LEFT</span><span class=p>]</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>table2</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>SYSTEM_TIME</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>OF</span><span class=w> </span><span class=n>table1</span><span class=p>.</span><span class=err>{</span><span class=w> </span><span class=n>rowtime</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=p>[</span><span class=k>AS</span><span class=w> </span><span class=o>&lt;</span><span class=n>alias2</span><span class=o>&gt;</span><span class=p>]</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=k>ON</span><span class=w> </span><span class=n>table1</span><span class=p>.</span><span class=k>column</span><span class=o>-</span><span class=n>name1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table2</span><span class=p>.</span><span class=k>column</span><span class=o>-</span><span class=n>name1</span>
</span></code></pre></div> <p>When enriching a particular <code>table1</code>, an event-time temporal join waits until the watermark on the table2 stream reaches the timestamp of that <code>table1</code> row, because only then, it is reasonable to be confident that the result of the join is being produced with complete knowledge of the relevant <code>table2</code> data. This table2 records can be old as the watermark on that table being late.</p> </details> <details class=info open=open> <summary>How to join two tables on a key within a time window using event column as timestamp and store results in a target table?</summary> <p>Full example:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=c1>-- use separate statements to create the tables</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>Transactions</span><span class=w> </span><span class=p>(</span><span class=n>ts</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span><span class=w> </span><span class=n>tid</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=nb>INT</span><span class=p>);</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>Payments</span><span class=w> </span><span class=p>(</span><span class=n>ts</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span><span class=w> </span><span class=n>tid</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>STRING</span><span class=p>);</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>Matched</span><span class=w> </span><span class=p>(</span><span class=n>tid</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>STRING</span><span class=p>);</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=k>execute</span><span class=w> </span><span class=k>statement</span><span class=w> </span><span class=k>set</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=k>begin</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>Transactions</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>now</span><span class=p>(),</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=mi>20</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>11</span><span class=p>,</span><span class=mi>25</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>12</span><span class=p>,</span><span class=mi>34</span><span class=p>);</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>Payments</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>now</span><span class=p>(),</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;debit&#39;</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>11</span><span class=p>,</span><span class=s1>&#39;debit&#39;</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>12</span><span class=p>,</span><span class=s1>&#39;credit&#39;</span><span class=p>);</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>Matched</span><span class=w> </span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>tid</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>P</span><span class=p>.</span><span class=k>type</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>Transactions</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>Payments</span><span class=w> </span><span class=n>P</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>tid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>P</span><span class=p>.</span><span class=n>tid</span><span class=w> </span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=w>    </span><span class=k>where</span><span class=w> </span><span class=n>P</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=k>between</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=n>minutes</span><span class=p>;</span>
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a><span class=k>end</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>how primary key selection impacts joins?</summary> <p>Primary keys on source tables do not impact joins as the joins can be done on any column of the left and right tables. The important keys are the one on the sink table and they need to match the last join columns.</p> </details> <details class=info open=open> <summary>Understand Left side velocity and update strategy</summary> <p>If the left table has a high velocity and there is no new event for the defined primary key, then it is important to set a TTL on the left side that is short so the state will stay under control. Use the aliases set on the tables and set the retention time. <div class="language-sql highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=k>select</span><span class=w> </span><span class=cm>/* STATE_TTL(&#39;tx&#39;=&#39;120s&#39;, &#39;c&#39;=&#39;4d&#39;) */</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=w>    </span><span class=n>tx_id</span><span class=p>,</span><span class=w> </span><span class=n>account_id</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>merchant_id</span><span class=p>,</span><span class=w> </span><span class=n>tx_type</span><span class=w> </span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=k>from</span><span class=w> </span><span class=k>transaction</span><span class=w> </span><span class=n>tx</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>account</span><span class=w> </span><span class=k>c</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=k>on</span><span class=w> </span><span class=n>tx</span><span class=p>.</span><span class=n>account_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>id</span>
</span></code></pre></div></p> <p><strong>Remark</strong>: Running an EXPLAIN on the above statement give the TTL.</p> </details> <details class=warning open=open> <summary>Join on 1x1 relationship</summary> <p>In current Flink SQL it is not possible to <em>efficiently</em> join elements from two tables when we know the relation is 1 to 1: one transaction to one account, one shipment to one order. As soon as there is a match, normally we want to emit the result and clear the state. This is possible to do so with the DataStream API, not SQL.</p> </details> <h2 id=windowing-table-value-functions>Windowing / Table Value Functions<a class=headerlink href=#windowing-table-value-functions title="Permanent link">&para;</a></h2> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/window-tvf.html>Windowing Table-Valued Functions</a> groups the Tumble, Hop, Cumulate, and Session Windows. Windows split the stream into â€œbucketsâ€ of finite size, over which we can implement logic. The return value adds three additional columns named â€œwindow_startâ€, â€œwindow_endâ€, â€œwindow_timeâ€ to indicate the assigned window.</p> <ul> <li>The TUMBLE function assigns each element to a window of specified window size. Tumbling windows have a fixed size and do not overlap.</li> </ul> <details class=question open=open> <summary>Count the number of different product type per 10 minutes (TUMBLE window)</summary> <p><a href=https://docs.confluent.io/cloud/current/flink/how-to-guides/aggregate-tumbling-window.html>Aggregate a Stream in a Tumbling Window documentation.</a>. The following query counts the number of different product types arriving from the event stream by interval of 10 minutes.</p> <p><div class="language-sql highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>product_type</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>product_type</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>num_ptype</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=w>        </span><span class=n>TUMBLE</span><span class=p>(</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=w>            </span><span class=k>TABLE</span><span class=w> </span><span class=n>events</span><span class=p>,</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=w>            </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=w>            </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>MINUTES</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=w>        </span><span class=p>)</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=p>;</span>
</span></code></pre></div> <em>DESCRIPTOR</em> indicates which time attributes column should be mapped to tumbling windows (here the kafka record ingestion timestamp). </p> <p>When the internal time has expired the results will be published. This puts an upper bound on how much state Flink needs to keep to handle a query, which in this case is related to the number of different product type. </p> <p>It is possible to use another timestamp from the input table. For example the <code>transaction_ts TIMESTAMP(3),</code> then we need to declare a watermark on this ts:</p> <p><code>WATERMARK FOR transaction_ts AS transaction_ts - INTERVAL '5' SECOND,</code> so it can be used in the descriptor function.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>app_orders</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=k>select</span><span class=w> </span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=w>    </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=w>    </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=k>sum</span><span class=p>(</span><span class=n>order_amount</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=k>from</span><span class=w> </span><span class=k>table</span><span class=p>(</span><span class=n>tumble</span><span class=p>(</span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>daily_spend</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=n>transaction_ts</span><span class=p>),</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;24&#39;</span><span class=w> </span><span class=n>hours</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=n>customer_id</span><span class=w> </span>
</span></code></pre></div> </details> <details class=question open=open> <summary>Aggregation over a window</summary> <p>Windows over approach is to end with the current row, and stretches backwards through the history of the stream for a specific interval, either measured in time, or by some number of rows. For example counting the umber of flight_schedule events of the same key over the last 100 events:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=k>select</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=w>    </span><span class=n>flight_id</span><span class=p>,</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=w>    </span><span class=n>evt_type</span><span class=p>,</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=w>    </span><span class=k>count</span><span class=p>(</span><span class=n>evt_type</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>number_evt</span><span class=p>,</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=k>from</span><span class=w> </span><span class=n>flight_events</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=n>window</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>as</span><span class=p>(</span><span class=w> </span><span class=n>partition</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>flight_id</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>between</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=n>preceding</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=k>current</span><span class=w> </span><span class=k>row</span><span class=p>);</span>
</span></code></pre></div> <p>The results are updated for every input row. The partition is by flight_id. Order by $rowtime is necessary.</p> </details> <details class=question open=open> <summary>Find the number of elements in x minutes intervals advanced by 5 minutes? (HOP)</summary> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/window-tvf.html>Confluent documentation on window integration.</a>. For <strong>HOP</strong> wuindow, there is the slide parameter to control how frequently a hopping window is started:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=w>        </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=w>        </span><span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span><span class=w> </span><span class=n>order_id</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>num_orders</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=w>        </span><span class=n>HOP</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=n>shoe_orders</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;5&#39;</span><span class=w> </span><span class=n>MINUTES</span><span class=p>,</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>MINUTES</span><span class=p>))</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to compute the accumulate price over time in a day (CUMULATE)</summary> <p>Needs to use the cumulate window, which adds up records to the window until max size, but emits results at each window steps. The is image summarizes well the behavior: <img alt src=https://docs.confluent.io/cloud/current/_images/flink-cumulating-windows.png></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=k>sum</span><span class=o>`</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=w>        </span><span class=n>CUMULATE</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=err>$</span><span class=n>rowtime</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30&#39;</span><span class=w> </span><span class=n>SECONDES</span><span class=p>,</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w> </span><span class=n>MINUTES</span><span class=p>))</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>;</span>
</span></code></pre></div> </details> <h2 id=sinkupsertmaterializer>SinkUpsertMaterializer<a class=headerlink href=#sinkupsertmaterializer title="Permanent link">&para;</a></h2> <p>When operating in upsert mode and processing two update events, a potential issue arises. If input operators for two tables in upsert mode are followed by a join and then a sink operator, update events might arrive at the sink out of order. If the downstream operator's implementation doesn't account for this out-of-order delivery, it can lead to incorrect results.</p> <p>Flink typically determines the ordering of update history based on the primary key (or upsert keys) through a global analysis in the Flink planner. However, a mismatch can occur between the upsert keys of the join output and the primary key of the sink table. The <code>SinkUpsertMaterializer</code> operator addresses this mapping discrepancy.</p> <p>This operator maintains a complete list of RowData in its state to correctly process any deletion events originating from the source table. However, this approach can lead to a significant state size, resulting in increased state access I/O overhead and reduced job throughput. Also the output value for each primary key is always the last (tail) element in the maintained list. It is generally advisable to avoid using <code>SinkUpsertMaterializer</code> whenever possible. </p> <p>Consider a scenario where 1 million records need to be processed across a small set of 1,000 keys. In this case, <code>SinkUpsertMaterializer</code> would need to store a potentially long list, averaging approximately 1,000 records per key. </p> <p>To mitigate the usage of <code>SinkUpsertMaterializer</code>:</p> <ul> <li>Ensure that the partition keys used for deduplication, group aggregation, etc., are identical to the sink table's primary keys.</li> <li><code>SinkUpsertMaterializer</code> is unnecessary if retractions are generated using the same key as the sink table's primary key. If a large number of records are processed but most are subsequently retracted, SinkUpsertMaterializer can significantly reduce its state size.</li> <li>Utilize Time-To-Live (TTL) to limit the state size based on time.</li> <li>A higher number of distinct values per primary key directly increases the state size of the SinkUpsertMaterializer.</li> </ul> <h2 id=row-pattern-recognition>Row pattern recognition<a class=headerlink href=#row-pattern-recognition title="Permanent link">&para;</a></h2> <details class=question open=open> <summary>Find the longest period of time for which the average price of a stock did not go below a value</summary> <p>Create a Datagen to publish StockTicker to a Kafka topic. <a href=https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/dev/table/sql/queries/match_recognize/ >See product documentation on CEP pattern with SQL</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>StockTicker</span><span class=p>(</span><span class=n>symbol</span><span class=w> </span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=n>tax</span><span class=w> </span><span class=nb>int</span><span class=p>)</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;connector&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;kafka&#39;</span><span class=p>,...)</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>From</span><span class=w> </span><span class=n>StockTicker</span><span class=w> </span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=n>MATCH_RECOGNIZE</span><span class=w> </span><span class=p>(</span><span class=w> </span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=w>    </span><span class=n>partition</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>symbol</span><span class=w> </span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=w>    </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>rowtime</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=w>    </span><span class=n>measures</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=w>        </span><span class=k>FIRST</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>rowtime</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>start_tstamp</span><span class=p>,</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=w>        </span><span class=k>LAST</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>rowtime</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>last_tstamp</span><span class=p>,</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=w>        </span><span class=k>AVG</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avgPrice</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=w>    </span><span class=n>ONE</span><span class=w> </span><span class=k>ROW</span><span class=w> </span><span class=n>PER</span><span class=w> </span><span class=k>MATCH</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=w>    </span><span class=k>AFTER</span><span class=w> </span><span class=k>MATCH</span><span class=w> </span><span class=n>SKIP</span><span class=w> </span><span class=n>PAST</span><span class=w> </span><span class=k>LAST</span><span class=w> </span><span class=k>ROW</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=w>    </span><span class=n>PATTERN</span><span class=w> </span><span class=p>(</span><span class=n>A</span><span class=o>+</span><span class=w> </span><span class=n>B</span><span class=p>)</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=w>    </span><span class=n>DEFINE</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=w>        </span><span class=n>A</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>15</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=p>);</span>
</span></code></pre></div> <p>MATCH_RECOGNIZE helps to logically partition and order the data that is used with the PARTITION BY and ORDER BY clauses, then defines patterns of rows to seek using the PATTERN clause. The logical components of the row pattern variables are specified in the DEFINE clause. B is defined implicitly as not being A.</p> </details> <h2 id=confluent-cloud-specifics>Confluent Cloud Specifics<a class=headerlink href=#confluent-cloud-specifics title="Permanent link">&para;</a></h2> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/overview.html>See Flink Confluent Cloud queries documentation.</a></p> <p>Each topic is automatically mapped to a table with some metadata fields added, like the watermark in the form of <code>$rowtime</code> field, which is mapped to the Kafka record timestamp. To see it, run <code>describe extended table_name;</code> With watermarking. arriving event records will be ingested roughly in order with respect to the <code>$rowtime</code> time attribute field.</p> <details class=question open=open> <summary>Mapping from Kafka record timestamp and table $rowtime</summary> <p>The Kafka record timestamp is automatically mapped to the <code>$rowtime</code> attribute, which is a read only field. Using this field we can order the record by arrival time:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=k>select</span><span class=w> </span><span class=s1>&#39;flight_id&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;aircraft_id&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;status&#39;</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=k>from</span><span class=w> </span><span class=n>Aircrafts</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to run Confluent Cloud for Flink?</summary> <p>See <a href=../../techno/ccloud-flink/ >the note</a>, but can be summarized as: 1/ create a stream processing compute pool in the same environment and region as the Kafka cluster, 2/ use Console or CLI (flink shell) to interact with topics.</p> <p><img alt src=../../techno/diagrams/ccloud-flink.drawio.png></p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a>confluent<span class=w> </span>flink<span class=w> </span>quickstart<span class=w> </span>--name<span class=w> </span>my-flink-sql<span class=w> </span>--max-cfu<span class=w> </span><span class=m>10</span><span class=w> </span>--region<span class=w> </span>us-west-2<span class=w> </span>--cloud<span class=w> </span>aws
</span></code></pre></div> </details> <details class=question open=open> <summary>Running Confluent Cloud Kafka with local Flink</summary> <p>The goal is to demonstrate how to get a cluster created in an existing Confluent Cloud environment and then send message via FlinkFaker using local table to Kafka topic:</p> <p><img alt src=../diagrams/flaker-to-kafka.drawio.png></p> <p>The <a href=https://github.com/jbcodeforce/flink-studies/tree/master/flink-sql/01-confluent-kafka-local-flink>scripts and readme</a> .</p> </details> <details class=question open=open> <summary>Reading from a topic specific offsets</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=w>    </span><span class=s1>&#39;scan.startup.mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;specific-offsets&#39;</span><span class=p>,</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=w>    </span><span class=s1>&#39;scan.startup.specific-offsets&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;partition:0,offset:25; partition:1,offset:10&#39;</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=p>);</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=c1>-- Returns from offsets 26 and 11</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>table_name</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>create a long running SQL with cli</summary> <p>Get or create a service account.</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a>confluent<span class=w> </span>iam<span class=w> </span>service-account<span class=w> </span>create<span class=w> </span>my-service-account<span class=w> </span>--description<span class=w> </span><span class=s2>&quot;new description&quot;</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a>confluent<span class=w> </span>iam<span class=w> </span>service-account<span class=w> </span>list
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a>confluent<span class=w> </span>iam<span class=w> </span>service-account<span class=w> </span>describe<span class=w> </span>&lt;id_of_the_sa&gt;
</span></code></pre></div> <div class="language-sh highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a>confluent<span class=w> </span>flink<span class=w> </span>statement<span class=w> </span>create<span class=w> </span>my-statement<span class=w> </span>--sql<span class=w> </span><span class=s2>&quot;SELECT * FROM my-topic;&quot;</span><span class=w> </span>--compute-pool<span class=w> </span>&lt;compute_pool_id&gt;<span class=w> </span>--service-account<span class=w> </span>sa-123456<span class=w> </span>--database<span class=w> </span>my-cluster
</span></code></pre></div> </details> <h2 id=analyzing-statements>Analyzing Statements<a class=headerlink href=#analyzing-statements title="Permanent link">&para;</a></h2> <details class=question open=open> <summary>Assess the current flink statement running in Confluent Cloud</summary> <p>To assess which jobs are still running, which jobs failed, and which stopped, we can use the user interface, go to the Flink console &gt; . Or the <code>confluent</code> CLI:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a>confluent<span class=w> </span>environment<span class=w> </span>list
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a>confluent<span class=w> </span>flink<span class=w> </span>compute-pool<span class=w> </span>list
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a>confluent<span class=w> </span>flink<span class=w> </span>statement<span class=w> </span>list<span class=w> </span>--cloud<span class=w> </span>aws<span class=w> </span>--region<span class=w> </span>us-west-2<span class=w> </span>--environment<span class=w> </span>&lt;your<span class=w> </span>env-id&gt;<span class=w> </span>--compute-pool<span class=w> </span>&lt;your<span class=w> </span>pool<span class=w> </span>id&gt;
</span></code></pre></div> </details> <h3 id=understand-the-physical-execution-plan-for-a-sql-query>Understand the physical execution plan for a SQL query<a class=headerlink href=#understand-the-physical-execution-plan-for-a-sql-query title="Permanent link">&para;</a></h3> <p>See the <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/explain/ >explain keyword</a> or <a href=https://docs.confluent.io/cloud/current/flink/reference/statements/explain.html>Confluent Flink documentation</a> for the output explanations.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=k>explain</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=p>...</span>
</span></code></pre></div> <p>Indentation indicates data flow, with each operator passing results to its parent. </p> <p>Review the state size, the changelog mode, the upsert key... Operators change changelog modes when different update patterns are needed, such as when moving from streaming reads to aggregations.</p> <p>Pay special attention to data skew when designing your queries. If a particular key value appears much more frequently than others, it can lead to uneven processing where a single parallel instance becomes overwhelmed handling that keyâ€™s data. Consider strategies like adding additional dimensions to your keys or pre-aggregating hot keys to distribute the workload more evenly. Whenever possible, configure the primary key to be identical to the upsert key.</p> <h3 id=troubleshooting-sql-statement-running-slow>Troubleshooting SQL statement running slow<a class=headerlink href=#troubleshooting-sql-statement-running-slow title="Permanent link">&para;</a></h3> <details class=info open=open> <summary>How to search for hot key?</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=w>    </span><span class=n>id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=w>    </span><span class=n>tenant_id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=w>    </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>record_count</span><span class=p>,</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=k>FROM</span><span class=w> </span><span class=k>table_name</span><span class=w> </span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>tenant_id</span>
</span></code></pre></div> <p>A more advanced statistical query ( TO BE TESTED) <div class="language-sql highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=k>WITH</span><span class=w> </span><span class=n>key_stats</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=w>        </span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=w>        </span><span class=n>tenant_id</span><span class=p>,</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=w>        </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>record_count</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>src_aqem_tag_tag</span><span class=w> </span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>tenant_id</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=p>),</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=n>distribution_stats</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-65-11><a id=__codelineno-65-11 name=__codelineno-65-11 href=#__codelineno-65-11></a><span class=w>        </span><span class=k>AVG</span><span class=p>(</span><span class=n>record_count</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>mean_count</span><span class=p>,</span>
</span><span id=__span-65-12><a id=__codelineno-65-12 name=__codelineno-65-12 href=#__codelineno-65-12></a><span class=w>        </span><span class=n>STDDEV</span><span class=p>(</span><span class=n>record_count</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>stddev_count</span><span class=p>,</span>
</span><span id=__span-65-13><a id=__codelineno-65-13 name=__codelineno-65-13 href=#__codelineno-65-13></a><span class=w>        </span><span class=n>PERCENTILE_APPROX</span><span class=p>(</span><span class=n>record_count</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>75</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>q3</span><span class=p>,</span>
</span><span id=__span-65-14><a id=__codelineno-65-14 name=__codelineno-65-14 href=#__codelineno-65-14></a><span class=w>        </span><span class=n>PERCENTILE_APPROX</span><span class=p>(</span><span class=n>record_count</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>95</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>p95</span><span class=p>,</span>
</span><span id=__span-65-15><a id=__codelineno-65-15 name=__codelineno-65-15 href=#__codelineno-65-15></a><span class=w>        </span><span class=n>PERCENTILE_APPROX</span><span class=p>(</span><span class=n>record_count</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>99</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>p99</span>
</span><span id=__span-65-16><a id=__codelineno-65-16 name=__codelineno-65-16 href=#__codelineno-65-16></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>key_stats</span>
</span><span id=__span-65-17><a id=__codelineno-65-17 name=__codelineno-65-17 href=#__codelineno-65-17></a><span class=p>)</span>
</span><span id=__span-65-18><a id=__codelineno-65-18 name=__codelineno-65-18 href=#__codelineno-65-18></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-65-19><a id=__codelineno-65-19 name=__codelineno-65-19 href=#__codelineno-65-19></a><span class=w>    </span><span class=n>ks</span><span class=p>.</span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-65-20><a id=__codelineno-65-20 name=__codelineno-65-20 href=#__codelineno-65-20></a><span class=w>    </span><span class=n>ds</span><span class=p>.</span><span class=n>mean_count</span><span class=p>,</span>
</span><span id=__span-65-21><a id=__codelineno-65-21 name=__codelineno-65-21 href=#__codelineno-65-21></a><span class=w>    </span><span class=n>ds</span><span class=p>.</span><span class=n>stddev_count</span><span class=p>,</span>
</span><span id=__span-65-22><a id=__codelineno-65-22 name=__codelineno-65-22 href=#__codelineno-65-22></a><span class=w>    </span><span class=c1>-- Z-score calculation for outlier detection</span>
</span><span id=__span-65-23><a id=__codelineno-65-23 name=__codelineno-65-23 href=#__codelineno-65-23></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-65-24><a id=__codelineno-65-24 name=__codelineno-65-24 href=#__codelineno-65-24></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>stddev_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span>
</span><span id=__span-65-25><a id=__codelineno-65-25 name=__codelineno-65-25 href=#__codelineno-65-25></a><span class=w>        </span><span class=k>THEN</span><span class=w> </span><span class=p>(</span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>mean_count</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>stddev_count</span>
</span><span id=__span-65-26><a id=__codelineno-65-26 name=__codelineno-65-26 href=#__codelineno-65-26></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-65-27><a id=__codelineno-65-27 name=__codelineno-65-27 href=#__codelineno-65-27></a><span class=w>    </span><span class=k>END</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>z_score</span><span class=p>,</span>
</span><span id=__span-65-28><a id=__codelineno-65-28 name=__codelineno-65-28 href=#__codelineno-65-28></a><span class=w>    </span><span class=c1>-- Hot key classification</span>
</span><span id=__span-65-29><a id=__codelineno-65-29 name=__codelineno-65-29 href=#__codelineno-65-29></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-65-30><a id=__codelineno-65-30 name=__codelineno-65-30 href=#__codelineno-65-30></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>p99</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;EXTREME_HOT&#39;</span>
</span><span id=__span-65-31><a id=__codelineno-65-31 name=__codelineno-65-31 href=#__codelineno-65-31></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>p95</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;VERY_HOT&#39;</span>
</span><span id=__span-65-32><a id=__codelineno-65-32 name=__codelineno-65-32 href=#__codelineno-65-32></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>q3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>5</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;HOT&#39;</span>
</span><span id=__span-65-33><a id=__codelineno-65-33 name=__codelineno-65-33 href=#__codelineno-65-33></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=s1>&#39;NORMAL&#39;</span>
</span><span id=__span-65-34><a id=__codelineno-65-34 name=__codelineno-65-34 href=#__codelineno-65-34></a><span class=w>    </span><span class=k>END</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>hot_key_category</span>
</span><span id=__span-65-35><a id=__codelineno-65-35 name=__codelineno-65-35 href=#__codelineno-65-35></a><span class=k>FROM</span><span class=w> </span><span class=n>key_stats</span><span class=w> </span><span class=n>ks</span>
</span><span id=__span-65-36><a id=__codelineno-65-36 name=__codelineno-65-36 href=#__codelineno-65-36></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>distribution_stats</span><span class=w> </span><span class=n>ds</span>
</span><span id=__span-65-37><a id=__codelineno-65-37 name=__codelineno-65-37 href=#__codelineno-65-37></a><span class=k>WHERE</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>mean_count</span><span class=w> </span>
</span></code></pre></div></p> </details> <h3 id=confluent-flink-query-profiler>Confluent Flink Query Profiler<a class=headerlink href=#confluent-flink-query-profiler title="Permanent link">&para;</a></h3> <p>This is a specific, modern implementation of the Flink WebUI, used to monitor the performance of the query.</p> <p><img alt src=../../architecture/images/query-profiler.png></p> <ul> <li><a href=https://docs.confluent.io/cloud/current/flink/operate-and-deploy/query-profiler.html>Query Profiler Product documentation</a></li> <li><a href=../../techno/ccloud-flink/#query-profiler>See how to use QP to debug statement, in the techno chapter</a>.</li> </ul> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../flink-sql-1/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Create Table (SQL)"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Create Table (SQL) </div> </div> </a> <a href=../table-api/ class="md-footer__link md-footer__link--next" aria-label="Next: Table API"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Table API </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2018 - 2026 Jerome Boyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jbcodeforce target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/jeromeboyer target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["content.code.annotation", "content.code.copy", "content.tooltips", "content.tabs.link", "search.suggest", "search.highlight", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>