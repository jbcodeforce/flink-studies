<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://jeromeboyer.net/flink-studies/coding/flink-sql/ rel=canonical><link href=../../architecture/flink-sql/ rel=prev><link href=../firstapp/ rel=next><link rel=icon href=../../images/logo-blue.drawio.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.22"><title>Flink SQL coding - Apache and Confluent Flink Studies</title><link rel=stylesheet href=../../assets/stylesheets/main.84d31ad4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#flink-sql class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Apache and Confluent Flink Studies" class="md-header__button md-logo" aria-label="Apache and Confluent Flink Studies" data-md-component=logo> <img src=../../images/flink-header-logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Apache and Confluent Flink Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Flink SQL coding </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/flink-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../architecture/flink-sql/ class=md-tabs__link> Recipes </a> </li> <li class=md-tabs__item> <a href=../../methodology/data_as_a_product/ class=md-tabs__link> Methodology </a> </li> <li class=md-tabs__item> <a href=../../techno/ccloud-flink/ class=md-tabs__link> Related Technologies </a> </li> <li class=md-tabs__item> <a href=https://jbcodeforce.github.io/eda-studies class=md-tabs__link> EDA </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Apache and Confluent Flink Studies" class="md-nav__button md-logo" aria-label="Apache and Confluent Flink Studies" data-md-component=logo> <img src=../../images/flink-header-logo.svg alt=logo> </a> Apache and Confluent Flink Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/flink-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/ class=md-nav__link> <span class=md-ellipsis> Key Concepts </span> </a> </li> <li class=md-nav__item> <a href=../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/ class=md-nav__link> <span class=md-ellipsis> Flink Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/fitforpurpose/ class=md-nav__link> <span class=md-ellipsis> Fit for purpose </span> </a> </li> <li class=md-nav__item> <a href=../../labs/ class=md-nav__link> <span class=md-ellipsis> Labs-Demos </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/agentic_flink/ class=md-nav__link> <span class=md-ellipsis> Agentic applications </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Recipes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Recipes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/flink-sql/ class=md-nav__link> <span class=md-ellipsis> Flink SQL concepts </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Flink SQL coding </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Flink SQL coding </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#getting-started-with-a-sql-client class=md-nav__link> <span class=md-ellipsis> Getting started with a SQL client </span> </a> </li> <li class=md-nav__item> <a href=#basic-commands class=md-nav__link> <span class=md-ellipsis> Basic commands </span> </a> </li> <li class=md-nav__item> <a href=#ddl-statements class=md-nav__link> <span class=md-ellipsis> DDL statements </span> </a> <nav class=md-nav aria-label="DDL statements"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#table-creation-how-tos class=md-nav__link> <span class=md-ellipsis> Table creation how-tos </span> </a> </li> <li class=md-nav__item> <a href=#changelog-mode class=md-nav__link> <span class=md-ellipsis> Changelog mode </span> </a> </li> <li class=md-nav__item> <a href=#sinkupsertmaterializer class=md-nav__link> <span class=md-ellipsis> SinkUpsertMaterializer </span> </a> </li> <li class=md-nav__item> <a href=#confluent-cloud-flink-table-creation class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Flink table creation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dml-statements class=md-nav__link> <span class=md-ellipsis> DML statements </span> </a> <nav class=md-nav aria-label="DML statements"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#common-patterns class=md-nav__link> <span class=md-ellipsis> Common patterns </span> </a> </li> <li class=md-nav__item> <a href=#joins class=md-nav__link> <span class=md-ellipsis> Joins </span> </a> </li> <li class=md-nav__item> <a href=#windowing-table-value-functions class=md-nav__link> <span class=md-ellipsis> Windowing / Table Value Functions </span> </a> </li> <li class=md-nav__item> <a href=#row-pattern-recognition class=md-nav__link> <span class=md-ellipsis> Row pattern recognition </span> </a> </li> <li class=md-nav__item> <a href=#confluent-cloud-specific class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Specific </span> </a> </li> <li class=md-nav__item> <a href=#from-batch-to-real-time class=md-nav__link> <span class=md-ellipsis> From batch to real-time </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#user-defined-function class=md-nav__link> <span class=md-ellipsis> User Defined Function </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting-sql-statement-running-slow class=md-nav__link> <span class=md-ellipsis> Troubleshooting SQL statement running slow </span> </a> <nav class=md-nav aria-label="Troubleshooting SQL statement running slow"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#metric-to-consider class=md-nav__link> <span class=md-ellipsis> Metric to consider </span> </a> </li> <li class=md-nav__item> <a href=#explain-statement class=md-nav__link> <span class=md-ellipsis> Explain statement </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../firstapp/ class=md-nav__link> <span class=md-ellipsis> First Java Apps </span> </a> </li> <li class=md-nav__item> <a href=../udf_sql/ class=md-nav__link> <span class=md-ellipsis> UDFs for SQL </span> </a> </li> <li class=md-nav__item> <a href=../k8s-deploy/ class=md-nav__link> <span class=md-ellipsis> Kubernetes Deployment </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/shift_left_utils/ class=md-nav__link> <span class=md-ellipsis> Manage CC Flink projects </span> </a> </li> <li class=md-nav__item> <a href=../datastream/ class=md-nav__link> <span class=md-ellipsis> DataStreams </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/cookbook/ class=md-nav__link> <span class=md-ellipsis> Flink Cookbook </span> </a> </li> <li class=md-nav__item> <a href=../table-api/ class=md-nav__link> <span class=md-ellipsis> Table API </span> </a> </li> <li class=md-nav__item> <a href=../stateful-func/ class=md-nav__link> <span class=md-ellipsis> Stateful function </span> </a> </li> <li class=md-nav__item> <a href=../cep/ class=md-nav__link> <span class=md-ellipsis> Complex Event Processing </span> </a> </li> <li class=md-nav__item> <a href=../terraform/ class=md-nav__link> <span class=md-ellipsis> IaC wt Terraform </span> </a> </li> <li class=md-nav__item> <a href=../../techno/fk-k8s-monitor/ class=md-nav__link> <span class=md-ellipsis> Flink on k8s Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../../labs/ class=md-nav__link> <span class=md-ellipsis> Labs-Demos </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/data_as_a_product/ class=md-nav__link> <span class=md-ellipsis> Data as a product </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-studies/methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/shift_left_utils/ class=md-nav__link> <span class=md-ellipsis> Migrate to real-time processing tools </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/flink_project_demos/c360/spark_project/ class=md-nav__link> <span class=md-ellipsis> A C360 data product demo </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Related Technologies </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Related Technologies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../techno/ccloud-flink/ class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Flink </span> </a> </li> <li class=md-nav__item> <a href=../../techno/cp-flink/ class=md-nav__link> <span class=md-ellipsis> Confluent Platform for Flink </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/kafka/ class=md-nav__link> <span class=md-ellipsis> Kafka Integration </span> </a> </li> <li class=md-nav__item> <a href=../../techno/cc-tableflow/ class=md-nav__link> <span class=md-ellipsis> Confluent TableFlow </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/techno/data/#data-related-technologies class=md-nav__link> <span class=md-ellipsis> Apache Iceberg </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/kafka-studies class=md-nav__link> <span class=md-ellipsis> Kafka-studies </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-studies class=md-nav__link> <span class=md-ellipsis> EDA </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#getting-started-with-a-sql-client class=md-nav__link> <span class=md-ellipsis> Getting started with a SQL client </span> </a> </li> <li class=md-nav__item> <a href=#basic-commands class=md-nav__link> <span class=md-ellipsis> Basic commands </span> </a> </li> <li class=md-nav__item> <a href=#ddl-statements class=md-nav__link> <span class=md-ellipsis> DDL statements </span> </a> <nav class=md-nav aria-label="DDL statements"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#table-creation-how-tos class=md-nav__link> <span class=md-ellipsis> Table creation how-tos </span> </a> </li> <li class=md-nav__item> <a href=#changelog-mode class=md-nav__link> <span class=md-ellipsis> Changelog mode </span> </a> </li> <li class=md-nav__item> <a href=#sinkupsertmaterializer class=md-nav__link> <span class=md-ellipsis> SinkUpsertMaterializer </span> </a> </li> <li class=md-nav__item> <a href=#confluent-cloud-flink-table-creation class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Flink table creation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dml-statements class=md-nav__link> <span class=md-ellipsis> DML statements </span> </a> <nav class=md-nav aria-label="DML statements"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#common-patterns class=md-nav__link> <span class=md-ellipsis> Common patterns </span> </a> </li> <li class=md-nav__item> <a href=#joins class=md-nav__link> <span class=md-ellipsis> Joins </span> </a> </li> <li class=md-nav__item> <a href=#windowing-table-value-functions class=md-nav__link> <span class=md-ellipsis> Windowing / Table Value Functions </span> </a> </li> <li class=md-nav__item> <a href=#row-pattern-recognition class=md-nav__link> <span class=md-ellipsis> Row pattern recognition </span> </a> </li> <li class=md-nav__item> <a href=#confluent-cloud-specific class=md-nav__link> <span class=md-ellipsis> Confluent Cloud Specific </span> </a> </li> <li class=md-nav__item> <a href=#from-batch-to-real-time class=md-nav__link> <span class=md-ellipsis> From batch to real-time </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#user-defined-function class=md-nav__link> <span class=md-ellipsis> User Defined Function </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting-sql-statement-running-slow class=md-nav__link> <span class=md-ellipsis> Troubleshooting SQL statement running slow </span> </a> <nav class=md-nav aria-label="Troubleshooting SQL statement running slow"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#metric-to-consider class=md-nav__link> <span class=md-ellipsis> Metric to consider </span> </a> </li> <li class=md-nav__item> <a href=#explain-statement class=md-nav__link> <span class=md-ellipsis> Explain statement </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=flink-sql>Flink SQL<a class=headerlink href=#flink-sql title="Permanent link">&para;</a></h1> <details class=info open=open> <summary>Updates</summary> <p>Created 10/24, Updated 12/20/24 Revised 12/06/24</p> </details> <p>This chapter offers a compilation of best practices for implementing Flink SQL solutions, applicable to local Flink open-source, the Confluent Platform for Flink or the Confluent Cloud for Flink.</p> <h2 id=getting-started-with-a-sql-client>Getting started with a SQL client<a class=headerlink href=#getting-started-with-a-sql-client title="Permanent link">&para;</a></h2> <p>Confluent Cloud enables users to write Flink SQL statements through the web console or a CLI shell, while Flink Open Source features a <code>sql-client</code> shell that communicates with an existing job manager. Currently, the Flink Kubernetes operator does not support the SQL client for Session Clusters. When using Kubernetes deployment, any SQL script must be packaged with a Java program called SQL Runner and deployed as a Flink Application using a FlinkDeployment descriptor."</p> <p>Use one of the following approaches:</p> <ul> <li>Once Flink project is downloaded locally, and the cluster started, use <code>sql-client.sh</code> to connect to the cluster.</li> <li>When using Flink with docker compose: the SQL client in the docker container runs against local Flink cluster (see <a href=https://github.com/jbcodeforce/flink-studies/tree/master/deployment/custom-flink-image>deployment/custom-flink-image</a> folder to build a custom image using the dockerfile with the <code>sql-client</code> service and any specific connector jars).</li> <li>Use Confluent Cloud Flink console to write SQL Statements in a Workspace, and run them directly from there: statements may run on a compute pool and may run forever.</li> <li>Use Confluent cli connected to a compute pool defined in a <strong>Confluent Cloud</strong> environment. (To create a new environment using Terraform see <a href=../terraform/ >this note</a>)</li> </ul> <details class=tip open=open> <summary>Local SQL client</summary> <p>The SQL Client aims to provide an easy way to write, debug, and submit table programs to a Flink cluster without a single line of code in any programming language. To interact with Flink using the SQL client, open a bash in the running container, or in the flink bin folder:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># be sure to mount the folder with sql scripts into the container</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=c1># Using running job manager running within docker</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-ti<span class=w> </span>sql-client<span class=w> </span>bash
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=c1># in kubernetes pod</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-ti<span class=w> </span>pod_name<span class=w> </span>-n<span class=w> </span>namespace<span class=w> </span>--<span class=w> </span>bash
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=c1># in the shell /opt/flink/bin </span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>./sql-client.sh
</span></code></pre></div> </details> <details class=example open=open> <summary>SQL client with Confluent Cloud cli</summary> <p><a href=https://docs.confluent.io/cloud/current/flink/get-started/quick-start-shell.html>See quick start note</a> which is summarized as:</p> <ul> <li>Connect to Confluent Cloud with CLI, then get environment and compute pool identifiers</li> </ul> <div class="language-sh highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>confluent<span class=w> </span>login<span class=w> </span>--save
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=nb>export</span><span class=w> </span><span class=nv>ENV_ID</span><span class=o>=</span><span class=k>$(</span>confluent<span class=w> </span>environment<span class=w> </span>list<span class=w> </span>-o<span class=w> </span>json<span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>-r<span class=w> </span><span class=s1>&#39;.[] | select(.name == &quot;aws-west&quot;) | .id&#39;</span><span class=k>)</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=nb>export</span><span class=w> </span><span class=nv>COMPUTE_POOL_ID</span><span class=o>=</span><span class=k>$(</span>confluent<span class=w> </span>flink<span class=w> </span>compute-pool<span class=w> </span>list<span class=w> </span>-o<span class=w> </span>json<span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>-r<span class=w> </span><span class=s1>&#39;.[0].id&#39;</span><span class=k>)</span>
</span></code></pre></div> <ul> <li>Start local SQL client - using the <code>aws-west</code> environment.</li> </ul> <div class="language-sh highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>confluent<span class=w> </span>flink<span class=w> </span>shell<span class=w> </span>--compute-pool<span class=w> </span><span class=nv>$COMPUTE_POOL_ID</span><span class=w> </span>--environment<span class=w> </span><span class=nv>$ENV_ID</span>
</span></code></pre></div> <ul> <li>Write SQL statements, results are visible in the active session.</li> </ul> </details> <details class=info open=open> <summary>Run SQL in Kubernetes application</summary> <p>Write SQL statements and test them with Java SQL runner. The Class is in <a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-java/sql-runner>flink-studies/code/flink-java/sql-runner</a> folder. Then package the java app and sql script into a docker image then use a FlinkDeployment descriptor; (see <a href=https://github.com/apache/flink-kubernetes-operator/tree/main/examples/flink-sql-runner-example>this git doc</a>).</p> </details> <p><a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/dev/table/sqlclient/ >See the Flink SQL CLI commands documentation</a>.</p> <p>See <a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/00-basic-sql>the flink-sql/00-basic-sql folder</a> to get some getting started with Flink SQL examples.</p> <h2 id=basic-commands>Basic commands<a class=headerlink href=#basic-commands title="Permanent link">&para;</a></h2> <ul> <li> <p>Show catalogs, tables... By default there is a default catalog and database withour any table.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>SHOW</span><span class=w> </span><span class=n>CATALOGS</span><span class=p>;</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=n>USE</span><span class=w> </span><span class=k>CATALOG</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=k>SHOW</span><span class=w> </span><span class=n>DATABASES</span><span class=p>;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=n>USE</span><span class=w> </span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>;</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=k>SHOW</span><span class=w> </span><span class=n>TABLES</span><span class=p>;</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=k>SHOW</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;*_raw&#39;</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=k>SHOW</span><span class=w> </span><span class=n>JOBS</span><span class=p>;</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=k>DESCRIBE</span><span class=w> </span><span class=n>tablename</span><span class=p>;</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=k>DESCRIBE</span><span class=w> </span><span class=n>EXTENDED</span><span class=w> </span><span class=k>table_name</span><span class=p>;</span>
</span></code></pre></div> </li> </ul> <details class=info open=open> <summary>Understand a type of attribute or get table structure with metadata</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>show</span><span class=w> </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=s1>&#39;tablename&#39;</span><span class=p>;</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=c1>-- for a specific attribute</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=k>select</span><span class=w> </span><span class=n>typeof</span><span class=p>(</span><span class=k>column_name</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span></code></pre></div> <p>Flink SQL planner performs type checking. Assessing type of inferred table is helpful specially around timestamp. See <a href=https://docs.confluent.io/cloud/current/flink/reference/serialization.html>Data type mapping documentation.</a></p> </details> <details class=info open=open> <summary>Understand the physical execution plan for a SQL query</summary> <p>See the <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/explain/ >explain keyword</a> or <a href=https://docs.confluent.io/cloud/current/flink/reference/statements/explain.html>Confluent Flink documentation</a> for the output explanations.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>explain</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=p>...</span>
</span></code></pre></div> <p>Indentation indicates data flow, with each operator passing results to its parent. </p> <p>Review the state size, the changelog mode, the upsert key... Operators change changelog modes when different update patterns are needed, such as when moving from streaming reads to aggregations.</p> <p>Pay special attention to data skew when designing your queries. If a particular key value appears much more frequently than others, it can lead to uneven processing where a single parallel instance becomes overwhelmed handling that key’s data. Consider strategies like adding additional dimensions to your keys or pre-aggregating hot keys to distribute the workload more evenly. Whenever possible, configure the primary key to be identical to the upsert key.</p> </details> <h2 id=ddl-statements>DDL statements<a class=headerlink href=#ddl-statements title="Permanent link">&para;</a></h2> <p>Data Definition Language (DDL) are statements to define metadata in Flink SQL by creating, updating, or deleting tables. <a href=https://docs.confluent.io/cloud/current/flink/reference/sql-examples.html#flink-sql-examples-in-af-long>See the Flink SQL Examples in Confluent Cloud for Apache Flink documentation.</a></p> <p>A table registered with the CREATE TABLE statement can be used as a table source or a table sink.</p> <h3 id=table-creation-how-tos>Table creation how-tos<a class=headerlink href=#table-creation-how-tos title="Permanent link">&para;</a></h3> <details class=tip open=open> <summary>Primary key and partition by considerations</summary> <ul> <li>Primary key can have one or more columns, all of them should be not null, and only being <code>NOT ENFORCED</code></li> <li>The primary key declaration, partitions the table implicitly by the key column(s)</li> <li>Flink uses the primary key for state management and deduplication with upsert, if the sink connector supports it. While the partition key is what determines which Kafka partition a message will be written to. This is a Kafka-level concept.</li> <li>For upsert mode, the bucket key must be equal to primary key. While for append/retract mode, the bucket key can be a subset of the primary key.</li> <li>In Confluent Cloud, partition key will generate a key schema, except if using the option (<code>'key.format' = 'raw'</code>)</li> <li>If the destination topic doesn't define partitioning key, then CC Flink SQL will write the records in whatever partitioning that was used at the end of the query. if last operation in the query is <code>GROUP BY foo</code> or <code>JOIN ON A.foo = B.foo</code>, then output records would be partitioned on <code>foo</code> values, and they wouldn't be re-partitioned before writing them into Kafka. The <code>foo</code> partitioning is preserved. </li> <li>If you have parallel queries like without any data shuffling, like <code>INSERT INTO Table_A SELECT * FROM Table_B</code>, then any skew from Table_B would be repeated in Table_A. Otherwise, if partitioning key is defined (like <code>DISTRIBUTED BY HASH(metric)</code>), any writes into that topic would be shuffled by that new key.</li> <li>In case of key skew, add more fields in the distribution to partition not just in one key. That would allow Flink to read data in more parallel fashion, improving the problem with readings from Kafka's bottleneck of 18MBs/connection (partition)</li> <li>An interesting metric, 5 partitions feeds 1 CFU. </li> <li>The performance bottleneck will be actually records serialization and deserialisation, avro is slower than protobuf.</li> </ul> <div class="language-sql highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1>-- simplest table</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>humans</span><span class=w> </span><span class=p>(</span><span class=n>race</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w> </span><span class=n>origin</span><span class=w> </span><span class=n>STRING</span><span class=p>);</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=c1>-- with primary key </span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>manufactures</span><span class=w> </span><span class=p>(</span><span class=n>m_id</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>ENFORCED</span><span class=p>,</span><span class=w> </span><span class=n>site_name</span><span class=w> </span><span class=n>STRING</span><span class=p>);</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=c1>-- with hash distribution to 2 partitions that match the primary key</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>humans</span><span class=w> </span><span class=p>(</span><span class=n>hid</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>ENFORCED</span><span class=p>,</span><span class=w> </span><span class=n>race</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w> </span><span class=n>gender</span><span class=w> </span><span class=nb>INT</span><span class=p>)</span><span class=w> </span><span class=n>DISTRIBUTED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=n>hid</span><span class=p>)</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>BUCKETS</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=tip open=open> <summary>Create a table with csv file as persistence - Flink OSS</summary> <p>We need to use the file system connector.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>    </span><span class=s1>&#39;user_id&#39;</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>250</span><span class=p>),</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=s1>&#39;name&#39;</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=p>)</span><span class=w> </span><span class=n>partitioned</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;used-id&#39;</span><span class=p>)</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=k>WITH</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>    </span><span class=s1>&#39;format&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;json&#39;</span><span class=p>,</span><span class=w> </span><span class=c1>-- other format are: csv, parquet</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>    </span><span class=s1>&#39;connector&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;filesystem&#39;</span><span class=p>,</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>    </span><span class=s1>&#39;path&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;/tmp/users&#39;</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=p>);</span>
</span></code></pre></div> </details> <details class=info open=open> <summary>CREATE TABLE in Confluent Cloud for Flink</summary> <p>The table creation creates topic and -key, -value schemas in the Schema Registry in the same environment as the compute pool in which the query is run. The <code>connector</code> is automatically set to <code>confluent</code>. The non null and nullable columns are translate as the following avro fields: <div class="language-text highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>  &quot;fields&quot;: [
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>        {
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>        &quot;name&quot;: &quot;customer_id&quot;,
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        &quot;type&quot;: &quot;string&quot;
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>        },
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>        {
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        &quot;default&quot;: null,
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>        &quot;name&quot;: &quot;first_name&quot;,
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>        &quot;type&quot;: [
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>            &quot;null&quot;,
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>            &quot;string&quot;
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>        ]
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>        }
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>  ]
</span></code></pre></div></p> <p>DATE as:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>{
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>  &quot;default&quot;: null,
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>  &quot;name&quot;: &quot;registration_date&quot;,
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>  &quot;type&quot;: [
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    &quot;null&quot;,
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>    {
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>      &quot;logicalType&quot;: &quot;local-timestamp-millis&quot;,
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>      &quot;type&quot;: &quot;long&quot;
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>    }
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>  ]
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>}
</span></code></pre></div> </details> <details class=question open=open> <summary>How to consume from a Kafka topic to a SQL table? -- Flink OSS</summary> <p>On Confluent Cloud for flink, there are already tables created for each topic. For local Flink we need to create table with column definitions that maps to attributes of the record. The <code>From</code> right operand proposes the list of topic/table for the catalog and database selected. For Flink OSS or Confluent Platform for Flink the <code>WITH</code> statement helps to specify the source topic.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>select</span><span class=w> </span><span class=p>....</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>TableName</span><span class=w> </span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>WITH</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>    </span><span class=s1>&#39;connector&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;kafka&#39;</span><span class=p>,</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=s1>&#39;topic&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;flight_schedules&#39;</span><span class=p>,</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span><span class=s1>&#39;properties.bootstrap.servers&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;localhost:9092&#39;</span><span class=p>,</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=s1>&#39;properties.group.id&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;fs_grp&#39;</span><span class=p>,</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>    </span><span class=s1>&#39;scan.startup.mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;earliest-offset&#39;</span><span class=p>,</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=p>)</span>
</span></code></pre></div> <p>For Avro and schema registry with open source Flink. See the tool <a href=https://github.com/jbcodeforce/flink-studies/blob/master/tools/extract_sql_from_avro.py>extract_sql_from_avro.py</a> to query Confluent Schema Registry and build the matching SQL to create a table connected to the topic using this schema.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>shoe_customers</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>    </span><span class=n>first_name</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>    </span><span class=n>last_name</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>    </span><span class=n>email</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>    </span><span class=n>phone</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>    </span><span class=n>street_address</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>    </span><span class=k>state</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>    </span><span class=n>zip_code</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>    </span><span class=n>country</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span><span class=n>country_code</span><span class=w> </span><span class=n>STRING</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=p>)</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>    </span><span class=s1>&#39;connector&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;kafka&#39;</span><span class=p>,</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>    </span><span class=s1>&#39;topic&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;shoe_customers&#39;</span><span class=p>,</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=s1>&#39;properties.bootstrap.servers&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;broker:29092&#39;</span><span class=p>,</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>    </span><span class=s1>&#39;scan.startup.mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;earliest-offset&#39;</span><span class=p>,</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>    </span><span class=s1>&#39;key.format&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;raw&#39;</span><span class=p>,</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>    </span><span class=s1>&#39;key.fields&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;id&#39;</span><span class=p>,</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>    </span><span class=s1>&#39;value.format&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;avro-confluent&#39;</span><span class=p>,</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>    </span><span class=s1>&#39;properties.group.id&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;flink-sql-consumer&#39;</span><span class=p>,</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=w>    </span><span class=s1>&#39;value.fields-include&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;ALL&#39;</span><span class=p>,</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=w>    </span><span class=s1>&#39;value.avro-confluent.url&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;http://schema-registry:8081&#39;</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=p>);</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to load data from a csv file using filesystem connector using SQL - Flink OSS</summary> <p>Enter the following statement in a SQL client session:</p> <p><div class="language-sql highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>SET</span><span class=w> </span><span class=n>execution</span><span class=p>.</span><span class=n>runtime</span><span class=o>-</span><span class=k>mode</span><span class=o>=</span><span class=n>BATCH</span><span class=p>;</span>
</span></code></pre></div> Create a table from the content of the file, mounted inside the container or accessible on local file system:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>employee_info</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>    </span><span class=n>emp_id</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>    </span><span class=n>dept_id</span><span class=w> </span><span class=nb>INT</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=p>)</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=w> </span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>    </span><span class=s1>&#39;connector&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;filesystem&#39;</span><span class=p>,</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>    </span><span class=s1>&#39;path&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;/home/flink-sql-demos/00-basic-sql/data/employees.csv&#39;</span><span class=p>,</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>    </span><span class=s1>&#39;format&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;csv&#39;</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=p>);</span>
</span></code></pre></div> <p>Show tables and list some elements within the table.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>SHOW</span><span class=w> </span><span class=n>TABLES</span><span class=p>;</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>employee_info</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>dept_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>101</span><span class=p>;</span>
</span></code></pre></div> <p>Show how the table is created:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>show</span><span class=w> </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>orders</span><span class=p>;</span>
</span></code></pre></div> <p><a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/00-basic-sql>See complete example in the readme</a></p> </details> <details class=question open=open> <summary>How to add a metadata field in a table?</summary> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/statements/alter-table.html>Use ALTER TABLE</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>flight_schedules</span><span class=w> </span><span class=k>add</span><span class=p>(</span><span class=n>dt</span><span class=w> </span><span class=n>string</span><span class=w> </span><span class=n>metadata</span><span class=w> </span><span class=n>virtual</span><span class=p>);</span>
</span></code></pre></div> </details> <details class=tip open=open> <summary>Create a table as another table by inserting all records (CTAS create table as select)</summary> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#create-table-as-select-ctas>CREATE TABLE AS SELECT</a> is used to create table and insert values in the same statement. It derives the physical column data types and names (from aliased columns), the changelog.mode (from involved tables, operations, and upsert keys), and the primary key.</p> <p>By using a primary key:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>shoe_customer_keyed</span><span class=p>(</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=n>enforced</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=p>)</span><span class=w> </span><span class=n>distributed</span><span class=w> </span><span class=k>by</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>buckets</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=k>as</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>first_name</span><span class=p>,</span><span class=w> </span><span class=n>last_name</span><span class=p>,</span><span class=w> </span><span class=n>email</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>shoe_customers</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=example open=open> <summary>Combine deduplication with create table as select</summary> <p>Attention the '`' is important. Ordering with DESC means takes the earliest record</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>tenant_dedup</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=w>    </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>tenantId</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>ENFORCED</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=p>)</span><span class=w> </span><span class=n>DISTRIBUTED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>HASH</span><span class=p>(</span><span class=o>`</span><span class=n>tenantId</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>buckets</span><span class=w> </span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=w>    </span><span class=k>WITH</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=w>        </span><span class=s1>&#39;changelog.mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;upsert&#39;</span><span class=p>,</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=w>        </span><span class=s1>&#39;value.fields-include&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;all&#39;</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=w>    </span><span class=o>`</span><span class=n>tenantId</span><span class=o>`</span><span class=p>,</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=w>    </span><span class=o>`</span><span class=n>hostname</span><span class=o>`</span><span class=p>,</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=w>    </span><span class=o>`</span><span class=n>ts</span><span class=o>`</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=w>        </span><span class=k>SELECT</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=w>        </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=w>        </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=w>            </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=n>tenantId</span><span class=o>`</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=w>            </span><span class=k>ORDER</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=w>            </span><span class=k>BY</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=k>DESC</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>row_num</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>tenants</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>row_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span></code></pre></div> </details> <details class="- question"> <summary>How to generate data using Flink Faker? (Flink OSS)</summary> <p>Create at table with records generated with <a href=https://github.com/knaufk/flink-faker>Flink faker</a> connector using the <a href=https://github.com/datafaker-net/datafaker>DataFaker expressions.</a>. Valid only on OSS Flink or Confluent platform for Flink.</p> <p><div class="language-sql highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>bounded_pageviews</span><span class=o>`</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>  </span><span class=o>`</span><span class=n>url</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>  </span><span class=o>`</span><span class=n>user_id</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=w>  </span><span class=o>`</span><span class=n>browser</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=w>  </span><span class=o>`</span><span class=n>ts</span><span class=o>`</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=p>)</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=k>WITH</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=w>  </span><span class=s1>&#39;connector&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;faker&#39;</span><span class=p>,</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>  </span><span class=s1>&#39;number-of-rows&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;500&#39;</span><span class=p>,</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=w>  </span><span class=s1>&#39;rows-per-second&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;100&#39;</span><span class=p>,</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=w>  </span><span class=s1>&#39;fields.url.expression&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;/#{GreekPhilosopher.name}.html&#39;</span><span class=p>,</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=w>  </span><span class=s1>&#39;fields.user_id.expression&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;#{numerify &#39;&#39;user_##&#39;&#39;}&#39;</span><span class=p>,</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=w>  </span><span class=s1>&#39;fields.browser.expression&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;#{Options.option &#39;&#39;chrome&#39;&#39;, &#39;&#39;firefox&#39;&#39;, &#39;&#39;safari&#39;&#39;)}&#39;</span><span class=p>,</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=w>  </span><span class=s1>&#39;fields.ts.expression&#39;</span><span class=w> </span><span class=o>=</span><span class=w>  </span><span class=s1>&#39;#{date.past &#39;&#39;5&#39;&#39;,&#39;&#39;1&#39;&#39;,&#39;&#39;SECONDS&#39;&#39;}&#39;</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=p>);</span>
</span></code></pre></div> This will only work in customized Flink client with the jar from Flink faker.</p> </details> <details class=info open=open> <summary>Generate data with DataGen for Flink OSS</summary> <p><a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/connectors/table/datagen/ >Use DataGen to do in-memory data generation</a></p> </details> <details class=question open=open> <summary>How to generate test data to Confluent Cloud Flink?</summary> <p>Use Kafka Connector with DataGen. Those connector exists with a lot of different pre-defined model. Also it is possible to define custom Avro schema and then use predicates to generate data. There is a <a href=https://docs.confluent.io/cloud/current/connectors/cc-datagen-source.html>Produce sample data quick start tutorial from the Confluent Cloud home page</a>. See also <a href=https://github.com/jbcodeforce/flink-studies/tree/master/flink-sql/01-confluent-kafka-local-flink>this readme</a>.</p> </details> <details class=question open=open> <summary>How to transfer the source timestamp to another table</summary> <p>As $rowtime is the timestamp of the record in Kafka, it may be interesting to keep the source timestamp to the downstream topic.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>some_clicks</span><span class=o>`</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=w>      </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=w>      </span><span class=p>...</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=w>      </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=s1>&#39;timestamp&#39;</span><span class=p>)</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=n>distributed</span><span class=p>....</span><span class=w> </span>
</span></code></pre></div> <p>Then the statement to insert record to the new table:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=o>`</span><span class=n>some_clicks</span><span class=o>`</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=k>select</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=w>    </span><span class=n>order_id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=w>    </span><span class=n>user_id</span><span class=p>,</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=w>    </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>event_time</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=k>from</span><span class=w>  </span><span class=o>`</span><span class=n>src_table</span><span class=o>`</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>Dealing with late event</summary> <p>Any streams mapped to a table have records arriving more-or-less in order, according to the <code>$rowtime</code>, and the watermarks let the Flink SQL runtime know how much buffering of the incoming stream is needed to iron out any out-of-order-ness before emitting the sorted output stream.</p> <p>We need to specify the watermark strategy: for example within 30 second of the event time:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>new_table</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=w>    </span><span class=p>....</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>    </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=s1>&#39;timestamp&#39;</span><span class=p>,</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=w> </span><span class=n>watermark</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>event_time</span><span class=o>`</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30&#39;</span><span class=w> </span><span class=k>SECOND</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=p>);</span>
</span></code></pre></div> <p>On CCF the watermark is on the <code>$rowtime</code> by default.</p> </details> <details class=question open=open> <summary>How to change system watermark?</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=k>MODIFY</span><span class=w> </span><span class=n>WATERMARK</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>SECOND</span><span class=p>;</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=c1>-- in case we need to reverse back</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=n>WATERMARK</span><span class=p>;</span>
</span></code></pre></div> <p>This can be used when doing enrichment join on reference table. We do not want to wait for watermark arriving on the reference table, so set the watermark of this reference table to the max INT using <code>ALTER TABLE table_name SET</code>$rowtime<code>TO_TIMESTAMP(,0)</code></p> </details> <details class=question open=open> <summary>Create a table with topic as one day persistence</summary> <p>See the <a href=https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#with-options>WITH options</a>.</p> <p><div class="language-sql highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>small</span><span class=o>-</span><span class=n>orders</span><span class=o>`</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=w>    </span><span class=o>`</span><span class=n>order_id</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>    </span><span class=o>`</span><span class=n>customer_id</span><span class=o>`</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>    </span><span class=o>`</span><span class=n>product_id</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>    </span><span class=o>`</span><span class=n>price</span><span class=o>`</span><span class=w> </span><span class=n>DOUBLE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=p>)</span><span class=w> </span><span class=n>distributed</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>hash</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>buckets</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=k>with</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>    </span><span class=s1>&#39;kafka.retention.time&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;1 d&#39;</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=p>);</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=o>`</span><span class=n>small</span><span class=o>-</span><span class=n>orders</span><span class=o>`</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>20</span><span class=p>;</span>
</span></code></pre></div> <code>distributed by hash(order_id)</code> and <code>into 1 buckets</code> specify that the table is backed by a Kafka topic with 1 partitions, and the order_id field will be used as the partition key. </p> </details> <details class=tip open=open> <summary>Table with Kafka Topic metadata</summary> <p>The headers and timestamp are the only options not read-only, all are VIRTUAL. Virtual columns are by default excluded from a SELECT * similar to the system column like <code>$rowtime</code>. </p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>&lt;</span><span class=k>table_name</span><span class=o>&gt;</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=w>    </span><span class=o>`</span><span class=n>headers</span><span class=o>`</span><span class=w> </span><span class=k>MAP</span><span class=o>&lt;</span><span class=n>STRING</span><span class=p>,</span><span class=n>STRING</span><span class=o>&gt;</span><span class=w> </span><span class=n>METADATA</span><span class=p>,</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>    </span><span class=o>`</span><span class=n>leader</span><span class=o>-</span><span class=n>epoch</span><span class=o>`</span><span class=nb>INT</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=n>VIRTUAL</span><span class=p>,</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>    </span><span class=o>`</span><span class=k>offset</span><span class=o>`</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=n>VIRTUAL</span><span class=p>,</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>    </span><span class=o>`</span><span class=n>partition</span><span class=o>`</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=n>VIRTUAL</span><span class=p>,</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=w>    </span><span class=o>`</span><span class=k>timestamp</span><span class=o>`</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=n>METADATA</span><span class=p>,</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>    </span><span class=o>`</span><span class=k>timestamp</span><span class=o>-</span><span class=k>type</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=n>VIRTUAL</span><span class=p>,</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>    </span><span class=o>`</span><span class=n>topic</span><span class=o>`</span><span class=w> </span><span class=n>STRING</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=n>VIRTUAL</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=p>);</span>
</span></code></pre></div> <p>The headers can be updated within SQL statements, some values may be static or coming from the value of one of the selected field. The timestamp can also being updated and for example in most time window queries will be set to the <code>window_time</code>.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>clicks_per_seconds</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>    </span><span class=n>events_per_second</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>    </span><span class=n>window_time</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=s1>&#39;timestamp&#39;</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>clicks_per_seconds</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=k>SELECT</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>events_per_second</span><span class=p>,</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>    </span><span class=n>window_time</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span><span class=n>TUMBLE</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=n>clicks</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>SECOND</span><span class=p>))</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_time</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=n>window_start</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to support nested rows?</summary> <p>Avro, Protobuf or Json schemas are very often hierarchical per design. It is possible to use CAST to name a column within a sub-schema: <div class="language-sql highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=c1>-- DDL</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=w>    </span><span class=n>StatesTable</span><span class=w> </span><span class=k>ROW</span><span class=o>&lt;</span><span class=w> </span><span class=n>states</span><span class=w> </span><span class=nb>ARRAY</span><span class=o>&lt;</span><span class=k>ROW</span><span class=o>&lt;</span><span class=n>name</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w> </span><span class=n>city</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w> </span><span class=n>lg</span><span class=w> </span><span class=n>DOUBLE</span><span class=p>,</span><span class=w> </span><span class=n>lat</span><span class=w> </span><span class=n>DOUBLE</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=w>    </span><span class=n>creationDate</span><span class=w> </span><span class=n>STRING</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=p>)</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>StatesTable</span><span class=p>,</span><span class=n>creationDate</span><span class=p>)</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=k>values</span><span class=p>(</span><span class=w> </span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>    </span><span class=p>(</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=w>    </span><span class=nb>ARRAY</span><span class=p>[</span><span class=w>  </span><span class=k>row</span><span class=p>(</span><span class=s1>&#39;California&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;San Francisco&#39;</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=mi>122</span><span class=p>.</span><span class=mi>4194</span><span class=p>,</span><span class=w> </span><span class=mi>37</span><span class=p>.</span><span class=mi>7749</span><span class=p>),</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>        </span><span class=k>row</span><span class=p>(</span><span class=s1>&#39;New York&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;New York City&#39;</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=mi>74</span><span class=p>.</span><span class=mi>0060</span><span class=p>,</span><span class=w> </span><span class=mi>40</span><span class=p>.</span><span class=mi>7128</span><span class=p>),</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=w>        </span><span class=k>row</span><span class=p>(</span><span class=s1>&#39;Texas&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Austin&#39;</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=mi>97</span><span class=p>.</span><span class=mi>7431</span><span class=p>,</span><span class=w> </span><span class=mi>30</span><span class=p>.</span><span class=mi>2672</span><span class=p>)</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=w>    </span><span class=p>]</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>    </span><span class=p>),</span><span class=w> </span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=w>    </span><span class=s1>&#39;2020-10-10&#39;</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=p>)</span>
</span></code></pre></div></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1>-- example of defining attribute from the idx element of an array from a nested json schema:</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=w>  </span><span class=k>CAST</span><span class=p>(</span><span class=n>StatesTable</span><span class=p>.</span><span class=n>states</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>DECIMAL</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>longitude</span><span class=p>,</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=w>  </span><span class=k>CAST</span><span class=p>(</span><span class=n>StatesTable</span><span class=p>.</span><span class=n>states</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>DECIMAL</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>latitude</span><span class=p>,</span>
</span></code></pre></div> <p>See also the <a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/dev/table/sql/queries/joins/#array-expansion>CROSS JOIN UNNEST</a> keywords.</p> <p>See also running demo in <a href=https://github.com/jbcodeforce/flink-studies/tree/master/flink-sql/03-nested-row>flink-sql/03-nested-row</a></p> </details> <h3 id=changelog-mode>Changelog mode<a class=headerlink href=#changelog-mode title="Permanent link">&para;</a></h3> <p>In traditional DB, changelog, or transaction log, records all modification operations in the database. Flink SQL also generates changelog data: changelogs that contain only INSERT-type events is an <strong>append</strong> streams, with UPDATE events it is an <strong>update</strong> stream.</p> <p>Some operations (stateful ones) in Flink such as group aggregation and deduplication can produce update events. With retract mode, an update event is split into delete and insert events.</p> <p>The <strong>append mode</strong> is the simplest mode where records are only added to the result stream, never updated or retracted. Like a write-once data. With append mode, it is possible to create a table with a primary key, and inserting duplicate records with the same key, will be insert events. </p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=w>        </span><span class=n>order_id</span><span class=w> </span><span class=n>STRING</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=n>enforced</span><span class=p>,</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=w>        </span><span class=n>product_id</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=w>        </span><span class=n>quantity</span><span class=w> </span><span class=nb>INT</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=n>DISTRIBUTED</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=n>BUCKETS</span><span class=w> </span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=w>    </span><span class=k>with</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=w>        </span><span class=s1>&#39;changelog.mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;append&#39;</span><span class=p>,</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=w>        </span><span class=s1>&#39;value.fields-include&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;all&#39;</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=w>    </span><span class=p>);</span>
</span></code></pre></div> <p>The outcome includes records in topics that are insert records:</p> <figure> <img alt=1 src=../images/append-mode-table.png width=800> <figcaption>Changelog mode: insert events</figcaption> </figure> <p>while running the following statement, in a session job, returns the last records per key: (ORD_1, BANANA, 13), (ORD_2, APPLE, 23).</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>orders</span><span class=o>`</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span></code></pre></div> <p>For <strong>retract mode</strong>, Flink emits pairs of retraction and addition records. When updating a value, it first sends a retraction of the old record (negative record) followed by the addition of the new record (positive record). It means, a fact can be undone, and the combination of +X and -X are related and must be partitioned together. With retract mode a consumer outside of Flink need to interpret the header. </p> <p>Any stateful aggregation, group by, joins, over, match_recognize ... enforces using a key and so upsert or retract changelog mode.</p> <p><a href=https://github.com/jbcodeforce/flink-studies/tree/master/code/flink-sql/05-append-log>See this code examples</a> for the different changelog mode study.</p> <p>Also be sure to get the key as part of the values, using the <code>'value.fields-include' = 'all'</code> option, if not it will not be possible to group by the key.</p> <h4 id=applying-to-a-medallion-architecture>Applying to a Medallion Architecture<a class=headerlink href=#applying-to-a-medallion-architecture title="Permanent link">&para;</a></h4> <p>The current approach can be used for Flink pipeline processing:</p> <table> <thead> <tr> <th>Table type</th> <th>Goals</th> <th>Parameters</th> </tr> </thead> <tbody> <tr> <td>Raw table non debezium format</td> <td>Get the raw data from CDC or outbox pattern</td> <td>cleanup.policy = 'delete', changelog.mode = 'append', value.format = 'avro-registry'...</td> </tr> <tr> <td>Raw table debezium format</td> <td>Same goals</td> <td>cleanup.policy = 'delete', changelog.mode = 'retract' (retract is the default for Debezium connector), value.format = 'avro-debezium-registry'</td> </tr> <tr> <td>Sources</td> <td>Deduplicate and keep last record per key</td> <td>cleanup.policy = 'delete', changelog.mode = 'upsert'</td> </tr> <tr> <td>Intermediates</td> <td>Enrichment, transformation</td> <td>cleanup.policy = 'delete', changelog.mode = 'upsert'</td> </tr> <tr> <td>Sink tables: Facts, Dimensions, Views</td> <td>Create star schema elements</td> <td>cleanup.policy = 'compact', changelog.mode = 'retract' or 'upsert'</td> </tr> </tbody> </table> <h4 id=deeper-dive>Deeper dive<a class=headerlink href=#deeper-dive title="Permanent link">&para;</a></h4> <ul> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#changelog-mode>Confluent product document - changelog </a></li> <li><a href=https://www.ververica.com/blog/flink-sql-secrets-mastering-the-art-of-changelog-event-out-of-orderness>Flink SQL Secrets: Mastering the Art of Changelog Event Out-of-Orderness</a></li> <li><a href=https://docs.confluent.io/cloud/current/flink/how-to-guides/resolve-common-query-problems.html#primary-key-differs-from-derived-upsert-key>Resolving: Primary key differs from derived upsert key</a></li> </ul> <h3 id=sinkupsertmaterializer>SinkUpsertMaterializer<a class=headerlink href=#sinkupsertmaterializer title="Permanent link">&para;</a></h3> <p>When operating in upsert mode and processing two update events, a potential issue arises. If input operators for two tables in upsert mode are followed by a join and then a sink operator, update events might arrive at the sink out of order. If the downstream operator's implementation doesn't account for this out-of-order delivery, it can lead to incorrect results.</p> <p>Flink typically determines the ordering of update history based on the primary key (or upsert keys) through a global analysis in the Flink planner. However, a mismatch can occur between the upsert keys of the join output and the primary key of the sink table. The <code>SinkUpsertMaterializer</code> operator addresses this mapping discrepancy.</p> <p>This operator maintains a complete list of RowData in its state to correctly process any deletion events originating from the source table. However, this approach can lead to a significant state size, resulting in increased state access I/O overhead and reduced job throughput. Also the output value for each primary key is always the last (tail) element in the maintained list. It is generally advisable to avoid using <code>SinkUpsertMaterializer</code> whenever possible. </p> <p>Consider a scenario where 1 million records need to be processed across a small set of 1,000 keys. In this case, <code>SinkUpsertMaterializer</code> would need to store a potentially long list, averaging approximately 1,000 records per key. </p> <p>To mitigate the usage of <code>SinkUpsertMaterializer</code>:</p> <ul> <li>Ensure that the partition keys used for deduplication, group aggregation, etc., are identical to the sink table's primary keys.</li> <li><code>SinkUpsertMaterializer</code> is unnecessary if retractions are generated using the same key as the sink table's primary key. If a large number of records are processed but most are subsequently retracted, SinkUpsertMaterializer can significantly reduce its state size.</li> <li>Utilize Time-To-Live (TTL) to limit the state size based on time.</li> <li>A higher number of distinct values per primary key directly increases the state size of the SinkUpsertMaterializer.</li> </ul> <h3 id=confluent-cloud-flink-table-creation>Confluent Cloud Flink table creation<a class=headerlink href=#confluent-cloud-flink-table-creation title="Permanent link">&para;</a></h3> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#create-table-statement-in-af-long>See the product documentation</a> with some specificities, like source and sink tables are mapped to Kafka Topics. The <code>$rowtime</code> TIMESTAMP_LTZ(3) NOT NULL is provided as a system column.</p> <ul> <li> <p>For each topic there is an inferred table created. The catalog is the Confluent environment and the Kafka cluster is the database. We can use the ALTER TABLE statement to evolve schemas for those inferred tables.</p> </li> <li> <p>A table by default is mapped to a topic with 6 partitions, and the changelog being append. Primary key leads to an implicit DISTRIBUTED BY(k), and value and key schemas are created in Schema Registry. It is possible to create table with primary key and append mode, while by default it is a upsert mode. </p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>telemetries</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=w>    </span><span class=n>device_id</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>ENFORCED</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=w>    </span><span class=n>geolocation</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w> </span><span class=n>metric</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=w>    </span><span class=n>ts</span><span class=w> </span><span class=n>TIMESTAMP_LTZ</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=n>METADATA</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=s1>&#39;timestamp&#39;</span><span class=p>)</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=n>DISTRIBUTED</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>BUCKETS</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;changelog.mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;append&#39;</span><span class=p>);</span>
</span></code></pre></div> </li> </ul> <p>The statement above also creates a metadata column for writing a Kafka message timestamp. This timestamp will not be defined in the schema registry. Compared to <code>$rowtime</code> which is declared as a <code>METADATA VIRTUAL</code> column, <code>ts</code> is selected in a <code>SELECT *</code> and is writable.</p> <ul> <li> <p>When the primary key is specified, then it will not be part of the value schema, except if we specify (using <code>value.fields-include' = 'all'</code>) that the value contains the full table schema. The payload of k is stored twice in Kafka message:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>telemetries</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=n>STRING</span><span class=p>)</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=n>DISTRIBUTED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=p>)</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;value.fields-include&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;all&#39;</span><span class=p>);</span>
</span></code></pre></div> </li> <li> <p>If the key is a string, it may make sense to do not have a schema for the key in this case declare (the key columns are determined by the DISTRIBUTED BY clause): This does not work if the key name is not <code>key</code>.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>telemetries</span><span class=w> </span><span class=p>(</span><span class=n>device_id</span><span class=w> </span><span class=n>STRING</span><span class=p>,</span><span class=w> </span><span class=n>metric</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>)</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=n>DISTRIBUTED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=k>key</span><span class=p>)</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;key.format&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;raw&#39;</span><span class=p>);</span>
</span></code></pre></div> </li> <li> <p>To keep the record in the topic forever add this <code>kafka.retention.time' = '0'</code> as options in the WITH. The supported units are:</p> </li> </ul> <div class="language-sh highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=s2>&quot;d&quot;</span>,<span class=w> </span><span class=s2>&quot;day&quot;</span>,<span class=w> </span><span class=s2>&quot;h&quot;</span>,<span class=w> </span><span class=s2>&quot;hour&quot;</span>,<span class=w> </span><span class=s2>&quot;m&quot;</span>,<span class=w> </span><span class=s2>&quot;min&quot;</span>,<span class=w> </span><span class=s2>&quot;minute&quot;</span>,<span class=w> </span><span class=s2>&quot;ms&quot;</span>,<span class=w> </span><span class=s2>&quot;milli&quot;</span>,<span class=w> </span><span class=s2>&quot;millisecond&quot;</span>,
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=s2>&quot;micro&quot;</span>,<span class=w> </span><span class=s2>&quot;microsecond&quot;</span>,<span class=w> </span><span class=s2>&quot;ns&quot;</span>,<span class=w> </span><span class=s2>&quot;nano&quot;</span>,<span class=w> </span><span class=s2>&quot;nanosecond&quot;</span>
</span></code></pre></div> <h2 id=dml-statements>DML statements<a class=headerlink href=#dml-statements title="Permanent link">&para;</a></h2> <p>Data modification language, is used to define statements which modify the data and don’t change the metadata.</p> <h3 id=common-patterns>Common patterns<a class=headerlink href=#common-patterns title="Permanent link">&para;</a></h3> <p>This is important to recall that a select applies to a stream of record so the results will change at each new record. A query as below will show the last top 10 orders, and when a new record arrives this list is updated. </p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span></code></pre></div> <details class=question open=open> <summary>How to filter out records?</summary> <p>using the <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/select/ >WHERE clause</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>flight_events</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cancelled&#39;</span><span class=p>;</span>
</span></code></pre></div> <p>Count the number of events related to a cancelled flight (need to use one of the selected field as grouping key):</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=k>select</span><span class=w> </span><span class=n>fight_id</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cancelled_fl</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>FlightEvents</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;cancelled&#39;</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>flight_id</span><span class=p>;</span>
</span></code></pre></div> <p>Recall that this results produces a dynamic table.</p> </details> <details class=question open=open> <summary>How to combine records from multiple tables (UNION)?</summary> <p>When the two tables has the same number of columns of the same type, then we can combine them:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>T1</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>T2</span><span class=p>;</span>
</span></code></pre></div> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/set-logic.html#flink-sql-set-logic-union>See product documentation on Union</a>. Remember that UNION will apply distinct, and avoid duplicate, while UNION ALL will generate duplicates. </p> </details> <details class=info open=open> <summary>OVER aggregations</summary> <p><a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/dev/table/sql/queries/over-agg/ >OVER aggregations</a> compute an aggregated value for every input row over a range of ordered rows. It does not reduce the number of resulting rows, as GROUP BY does, but produces one result for every input row. This is helpful when we need to act on each input row, but consider some time interval. A classical example is to get the number of orders in the last 10 seconds:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=w>    </span><span class=n>order_id</span><span class=p>,</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=w>    </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>,</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_price_ten_secs</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_orders_ten_secs</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=n>WINDOW</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a><span class=w>    </span><span class=n>RANGE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>SECONDS</span><span class=w> </span><span class=n>PRECEDING</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>CURRENT</span><span class=w> </span><span class=k>ROW</span>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=p>)</span>
</span></code></pre></div> <p>To get the order exceeding some limits for the first time and then when the computed aggregates go below other limits. <a href>LAG</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=c1>-- compute the total price and # of orders for a period of 10s for each customer</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=k>WITH</span><span class=w> </span><span class=n>orders_ten_secs</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w> </span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=w>    </span><span class=n>order_id</span><span class=p>,</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=w>    </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>,</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_price_ten_secs</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_orders_ten_secs</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=n>WINDOW</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=w>    </span><span class=n>RANGE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>SECONDS</span><span class=w> </span><span class=n>PRECEDING</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>CURRENT</span><span class=w> </span><span class=k>ROW</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=p>),</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=c1>-- get previous orders and current order per customer</span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=n>orders_ten_secs_with_lag</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-40-18><a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-40-19><a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a><span class=w>    </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-40-20><a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a><span class=w>    </span><span class=n>LAG</span><span class=p>(</span><span class=n>total_price_ten_secs</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_price_ten_secs_lag</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-40-21><a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a><span class=w>    </span><span class=n>LAG</span><span class=p>(</span><span class=n>total_orders_ten_secs</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_orders_ten_secs_lag</span>
</span><span id=__span-40-22><a id=__codelineno-40-22 name=__codelineno-40-22 href=#__codelineno-40-22></a><span class=k>FROM</span><span class=w> </span><span class=n>orders_ten_secs</span>
</span><span id=__span-40-23><a id=__codelineno-40-23 name=__codelineno-40-23 href=#__codelineno-40-23></a><span class=n>WINDOW</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-40-24><a id=__codelineno-40-24 name=__codelineno-40-24 href=#__codelineno-40-24></a><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-40-25><a id=__codelineno-40-25 name=__codelineno-40-25 href=#__codelineno-40-25></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span>
</span><span id=__span-40-26><a id=__codelineno-40-26 name=__codelineno-40-26 href=#__codelineno-40-26></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-40-27><a id=__codelineno-40-27 name=__codelineno-40-27 href=#__codelineno-40-27></a><span class=c1>-- Filter orders when the order price and number of orders were above some limits for previous or current order aggregates</span>
</span><span id=__span-40-28><a id=__codelineno-40-28 name=__codelineno-40-28 href=#__codelineno-40-28></a><span class=p>)</span>
</span><span id=__span-40-29><a id=__codelineno-40-29 name=__codelineno-40-29 href=#__codelineno-40-29></a><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;BLOCK&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>action</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>updated_at</span><span class=w> </span>
</span><span id=__span-40-30><a id=__codelineno-40-30 name=__codelineno-40-30 href=#__codelineno-40-30></a><span class=k>FROM</span><span class=w> </span><span class=n>orders_ten_secs_with_lag</span><span class=w> </span>
</span><span id=__span-40-31><a id=__codelineno-40-31 name=__codelineno-40-31 href=#__codelineno-40-31></a><span class=k>WHERE</span><span class=w> </span>
</span><span id=__span-40-32><a id=__codelineno-40-32 name=__codelineno-40-32 href=#__codelineno-40-32></a><span class=w>    </span><span class=p>(</span><span class=n>total_price_ten_secs</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>300</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_price_ten_secs_lag</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>300</span><span class=p>)</span><span class=w> </span><span class=k>OR</span>
</span><span id=__span-40-33><a id=__codelineno-40-33 name=__codelineno-40-33 href=#__codelineno-40-33></a><span class=w>    </span><span class=p>(</span><span class=n>total_orders_ten_secs</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_orders_ten_secs_lag</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-40-34><a id=__codelineno-40-34 name=__codelineno-40-34 href=#__codelineno-40-34></a><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w> </span>
</span><span id=__span-40-35><a id=__codelineno-40-35 name=__codelineno-40-35 href=#__codelineno-40-35></a><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;UNBLOCK&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>action</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>updated_at</span><span class=w> </span>
</span><span id=__span-40-36><a id=__codelineno-40-36 name=__codelineno-40-36 href=#__codelineno-40-36></a><span class=k>FROM</span><span class=w> </span><span class=n>orders_ten_secs_with_lag</span><span class=w> </span>
</span><span id=__span-40-37><a id=__codelineno-40-37 name=__codelineno-40-37 href=#__codelineno-40-37></a><span class=k>WHERE</span><span class=w> </span>
</span><span id=__span-40-38><a id=__codelineno-40-38 name=__codelineno-40-38 href=#__codelineno-40-38></a><span class=w>    </span><span class=p>(</span><span class=n>total_price_ten_secs</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>300</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_price_ten_secs_lag</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>300</span><span class=p>)</span><span class=w> </span><span class=k>OR</span>
</span><span id=__span-40-39><a id=__codelineno-40-39 name=__codelineno-40-39 href=#__codelineno-40-39></a><span class=w>    </span><span class=p>(</span><span class=n>total_orders_ten_secs</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>total_orders_ten_secs_lag</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>5</span><span class=p>);</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to access element of an array of rows?</summary> <p>The table has a column that is an array of rows. <div class="language-sql highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=w> </span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>my_table</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=w>    </span><span class=n>key_col</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=w>    </span><span class=n>nested_data</span><span class=w> </span><span class=nb>ARRAY</span><span class=o>&lt;</span><span class=k>ROW</span><span class=o>&lt;</span><span class=n>id</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=n>STRING</span><span class=o>&gt;&gt;</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=p>)</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(...)</span>
</span></code></pre></div></p> <p>To create one record per row, so exploding the array, use CROSS JOIN UNNEST: <div class="language-sql highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=w> </span><span class=k>SELECT</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>key_col</span><span class=p>,</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=w>    </span><span class=n>unnested_row</span><span class=p>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=w>    </span><span class=n>unnested_row</span><span class=p>.</span><span class=n>name</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=k>FROM</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=w>    </span><span class=n>my_table</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>t</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>UNNEST</span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=n>nested_data</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>unnested_row</span><span class=p>;</span>
</span></code></pre></div> So each row in the nested_data arrary will be row in the output table with the matching key_col.</p> </details> <details class=question open=open> <summary>How to Aggregate a field into an ARRAY?</summary> <p>Let start by a simple array indexing (the index is between 1 to n_element). Below, the <code>values array</code> creates test data into a memory table aliased a <code>T</code> with a column named <code>array_field</code>:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>array_field</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>((</span><span class=k>VALUES</span><span class=w> </span><span class=nb>ARRAY</span><span class=p>[</span><span class=mi>5</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=p>]))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>T</span><span class=p>(</span><span class=n>array_field</span><span class=p>)</span>
</span></code></pre></div> <p>The following code, is creating a view with an <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/#aggregate-functions>array of aggregates</a>, which in this case, is concatenating the urls over a 1 minute tumble window.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>visited_pages_per_minute</span><span class=w> </span><span class=k>AS</span><span class=w> </span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=n>window_time</span><span class=p>,</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=n>user_id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=n>ARRAY_AGG</span><span class=p>(</span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>urls</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span><span class=n>TUMBLE</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=n>examples</span><span class=p>.</span><span class=n>marketplace</span><span class=p>.</span><span class=n>clicks</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>MINUTE</span><span class=p>))</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=n>window_time</span><span class=p>,</span><span class=w> </span><span class=n>user_id</span><span class=p>;</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=c1>-- once the view is created</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>visited_pages_per_minute</span><span class=p>;</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=c1>-- it is possible to expand an array into multiple rows</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=k>SELECT</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>window_time</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=n>u</span><span class=p>.</span><span class=n>url</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>visited_pages_per_minute</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>v</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>UNNEST</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>urls</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>u</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></code></pre></div> </details> <details class=info open=open> <summary>Navigate a hierarchical structure in a table</summary> <p>The unique table has node and ancestors representation. Suppose the graph represents a Procedure at the highest level, then an Operation, then a Phase and a Phase Step at the level 4. In the Procedures table we can have rows like:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>id, parent_ids, depth, information
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>&#39;id_1&#39;, [], 0 , &#39;procedure 1&#39;
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a>&#39;id_2&#39;, [&#39;id_1&#39;], 1 , &#39;operation 1&#39;
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a>&#39;id_3&#39;, [&#39;id_1&#39;,&#39;id_2&#39;], 2 , &#39;phase 1&#39;
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a>&#39;id_4&#39;, [&#39;id_1&#39;,&#39;id_2&#39;,&#39;id_3&#39;], 3 , &#39;phase_step 1&#39;
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a>&#39;id_5&#39;, [&#39;id_1&#39;,&#39;id_2&#39;,&#39;id_3&#39;], 3 , &#39;phase_step 2&#39;
</span></code></pre></div> <p>Suppose we want to extract the matching procedure_id, operation_id, phase_id, phase_step_id like <div class="language-text highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>id, procedure_id, operation_id, phase_id, phase_step_id, information
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a>&#39;id_1&#39;, &#39;id_1&#39;, NULL, NULL, NULL, &#39;procedure 1&#39;
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a>&#39;id_2&#39;, &#39;id_1&#39;, &#39;id_2&#39;, NULL, NULL, &#39;operation 1&#39;
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a>&#39;id_3&#39;, &#39;id_1&#39;, &#39;id_2&#39;, &#39;id_3&#39;, NULL, &#39;phase 1&#39;
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a>&#39;id_4&#39;, &#39;id_1&#39;, &#39;id_2&#39;, &#39;id_3&#39;, &#39;id_4&#39;, &#39;phase_step 1&#39;
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a>&#39;id_5&#39;, &#39;id_1&#39;, &#39;id_2&#39;, &#39;id_3&#39;, &#39;id_5&#39;, &#39;phase_step 2&#39;
</span></code></pre></div></p> <p>if the depth is 3, then the response should have all ids populated, if 0 only the top level is returned.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=k>with</span><span class=w> </span><span class=o>`</span><span class=n>procedures</span><span class=o>`</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=s1>&#39;procedure 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_2&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=s1>&#39;operation 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_3&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>,</span><span class=s1>&#39;id_2&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phase 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_4&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>,</span><span class=s1>&#39;id_2&#39;</span><span class=p>,</span><span class=s1>&#39;id_3&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phase_step 1&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;id_5&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=nb>array</span><span class=p>[</span><span class=s1>&#39;id_1&#39;</span><span class=p>,</span><span class=s1>&#39;id_2&#39;</span><span class=p>,</span><span class=s1>&#39;id_3&#39;</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>parentIds</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phase_step 2&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>info</span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=k>select</span><span class=w> </span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=w>    </span><span class=n>id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=w>    </span><span class=n>parent_id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>phase_step_id</span><span class=p>,</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>phase_id</span><span class=p>,</span>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>operation_id</span><span class=p>,</span>
</span><span id=__span-47-18><a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=o>`</span><span class=n>depth</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>procedure_id</span><span class=p>,</span>
</span><span id=__span-47-19><a id=__codelineno-47-19 name=__codelineno-47-19 href=#__codelineno-47-19></a><span class=w>    </span><span class=n>info</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=o>`</span><span class=n>procedures</span><span class=o>`</span><span class=w> </span><span class=k>cross</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=n>parentIds</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>ids</span><span class=p>(</span><span class=n>parent_id</span><span class=p>)</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to transform a field representing epoch to a timestamp?</summary> <p>epoch is a BIGINT.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=w> </span><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=n>FROM_UNIXTIME</span><span class=p>(</span><span class=n>click_ts_epoch</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>click_ts</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to change a date string to a timestamp?</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=s1>&#39;2024-11-20 12:34:568Z&#39;</span><span class=p>),</span>
</span></code></pre></div> <div class="language-sql highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=n>to_timestamp</span><span class=p>(</span><span class=n>transaction_date</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;yyyy-MM-dd HH:mm:ss&#39;</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>tx_date</span><span class=p>,</span><span class=w> </span><span class=c1>-- bigint</span>
</span></code></pre></div> <p>See all the <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/datetime-functions.html>date and time functions</a>.</p> </details> <details class=question open=open> <summary>How to compare a date field with current system time?</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=k>WHEN</span><span class=w> </span><span class=n>TIMESTAMPDIFF</span><span class=p>(</span><span class=k>day</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=n>event_launch_date</span><span class=p>,</span><span class=w> </span><span class=n>now</span><span class=p>())</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>120</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=p>...</span>
</span></code></pre></div> <p>The table used as target to this processing, if new records are added to it, then needs to be append log, as if it is upsert then the now() time is not determenistic for each row to process.</p> </details> <details class=question open=open> <summary>How to mask a field?</summary> <p>Create a new table from the existing one, and then use REGEXP_REPLACE to mask an existing attribute</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>users_msk</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=n>users</span><span class=p>;</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users_msk</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=p>...,</span><span class=w> </span><span class=n>REGEXP_REPLACE</span><span class=p>(</span><span class=n>credit_card</span><span class=p>,</span><span class=s1>&#39;(\w)&#39;</span><span class=p>,</span><span class=s1>&#39;*&#39;</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>credit_card</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to filter row that has column content not matching a regular expression?</summary> <p>Use <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/string-functions.html#flink-sql-regexp-function>REGEX</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=k>WITH</span><span class=w> </span><span class=n>filtered_data</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=n>REGEXP</span><span class=p>(</span><span class=n>user_agent</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;.*Opera/.*&#39;</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=w>        </span><span class=k>THEN</span><span class=w> </span><span class=k>TRUE</span><span class=w>  </span><span class=c1>-- Keep this row</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=k>FALSE</span><span class=w> </span><span class=c1>-- Filter out rows that match &quot;Opera/&quot;</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=w>    </span><span class=k>END</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>keep_row</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=k>FROM</span><span class=w> </span><span class=n>examples</span><span class=p>.</span><span class=n>marketplace</span><span class=p>.</span><span class=n>clicks</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=p>)</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=k>FROM</span><span class=w> </span><span class=n>filtered_data</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=k>WHERE</span><span class=w> </span><span class=n>keep_row</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>TRUE</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>What are the different SQL execution modes?</summary> <p>Using previous table it is possible to count the elements in the table using:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=k>select</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=o>`</span><span class=k>count</span><span class=o>`</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>pageviews</span><span class=p>;</span>
</span></code></pre></div> <p>and we get different behaviors depending of the execution mode:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;execution.runtime-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;batch&#39;</span><span class=p>;</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=o>#</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>one</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;execution.runtime-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;streaming&#39;</span><span class=p>;</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;sql-client.execution.result-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;table&#39;</span><span class=p>;</span>
</span></code></pre></div> <p>In changelog mode, the SQL Client doesn't just update the count in place, but instead displays each message in the stream of updates it's receiving from the Flink SQL runtime.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=k>set</span><span class=w> </span><span class=s1>&#39;sql-client.execution.result-mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;changelog&#39;</span><span class=p>;</span>
</span></code></pre></div> <p><img alt src=../images/changelog-exec-mode.png></p> </details> <details class=question open=open> <summary>How to access json data from a string column being a json object?</summary> <p>Use json_query function in the select.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=w> </span><span class=n>json_query</span><span class=p>(</span><span class=n>task</span><span class=p>.</span><span class=n>object_state</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$.dueDate&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>due_date</span><span class=p>,</span>
</span></code></pre></div> <p>Use json_value() instead if the column content is a dict or json {}.</p> </details> <details class=question open=open> <summary>How to transform a json array column (named data) into an array to then generate n rows?</summary> <p>Returning an array from a json string: <div class="language-sql highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=n>json_query</span><span class=p>(</span><span class=o>`</span><span class=k>data</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$&#39;</span><span class=w> </span><span class=n>RETURNING</span><span class=w> </span><span class=nb>ARRAY</span><span class=o>&lt;</span><span class=n>STRING</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>anewcolumn</span>
</span></code></pre></div></p> <p>To create as many rows as there are elements in the nested array: <div class="language-sql highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>existing_column</span><span class=p>,</span><span class=w> </span><span class=n>anewcolumn</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=k>table_name</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=k>cross</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=k>unnest</span><span class=w> </span><span class=p>(</span><span class=n>json_query</span><span class=p>(</span><span class=o>`</span><span class=k>data</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;$&#39;</span><span class=w> </span><span class=n>RETURNING</span><span class=w> </span><span class=nb>ARRAY</span><span class=o>&lt;</span><span class=n>STRING</span><span class=o>&gt;</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>anewcolumn</span><span class=p>)</span>
</span></code></pre></div></p> <p>UNNEST returns a new row for each element in the array <a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/queries/joins/#array-multiset-and-map-expansion>See multiset expansion doc</a></p> </details> <details class=question open=open> <summary>How to implement the equivalent of SQL explode?</summary> <p>SQL EXPLODE creates a row for each element in the array or map, and ignore null or empty values in array. <div class="language-sql highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>explode</span><span class=p>(</span><span class=n>col1</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=nb>array</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>20</span><span class=p>)),</span><span class=w> </span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></code></pre></div> SQL has also EXPLODE_OUTER, which returns all values in array including null or empty. To translate this to Flink SQL we can use MAP_ENTRIES and MAP_FROM_ARRAYS. MAP_ENTRIES returns an array of all entries in the given map. While MAP_FROM_ARRAYS returns a map created from an arrays of keys and values. <div class="language-sql highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=k>select</span><span class=w> </span><span class=n>map_entries</span><span class=p>(</span><span class=n>map_from_arrays</span><span class=p>())</span>
</span></code></pre></div></p> </details> <details class=question open=open> <summary>How to use conditional functions?</summary> <p><a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/systemfunctions/#conditional-functions>Flink has built-in conditional functions</a> (See also <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/conditional-functions.html>Confluent support</a>) and specially the CASE WHEN:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=w>    </span><span class=o>*</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>stocks</span><span class=o>`</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=w>    </span><span class=k>WHERE</span><span class=w>  </span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;high&#39;</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=o>&lt;=</span><span class=mi>200</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>150</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;medium&#39;</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=s1>&#39;low&#39;</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=w>    </span><span class=k>END</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>When and how to use custom watermark?</summary> <p>Developer should use their own <a href=https://docs.confluent.io/cloud/current/flink/reference/statements/create-table.html#watermark-clause>watermark strategy</a> when there are not a lot of records per topic/partition, there is a need for a large watermark delay, and need to use another timestamp. The default watermark strategy in SOUCE_WATERMARK(), a watermark defined by the source. The common strategy used is the <code>maximim-out-of-orderness</code> to allow messages arriving later to be part of the window, to ensure more accurate results, as a tradeoff of latency. It can be defined using:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>&lt;</span><span class=k>table_name</span><span class=o>&gt;</span><span class=w> </span><span class=k>MODIFY</span><span class=w> </span><span class=n>WATERMARK</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;20&#39;</span><span class=w> </span><span class=n>SECONDS</span>
</span></code></pre></div> <p>The minimum out-of-orderness is 50ms and can be set up to 7 days. See <a href=https://docs.confluent.io/cloud/current/flink/reference/functions/datetime-functions.html#flink-sql-source-watermark-function>Confluent documentation.</a> </p> </details> <details class=question open=open> <summary>Deduplication example</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ip_address</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=n>FROM_UNIXTIME</span><span class=p>(</span><span class=n>click_ts_raw</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>click_timestamp</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=w>    </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ip_address</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>TO_TIMESTAMP</span><span class=p>(</span><span class=n>FROM_UNIXTIME</span><span class=p>(</span><span class=n>click_ts_raw</span><span class=p>))</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>rownum</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>clicks</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a><span class=k>WHERE</span><span class=w> </span><span class=n>rownum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span></code></pre></div> <p><a href=https://docs.confluent.io/cloud/current/flink/how-to-guides/deduplicate-rows.html#flink-sql-deduplicate-topic-action>See this example</a>.</p> </details> <details class=question open=open> <summary>How to manage late message to be sent to a DLQ?</summary> <p>First create a DLQ table like late_orders based on the order table:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=w>    </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>late_orders</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=w>    </span><span class=k>with</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=w>        </span><span class=s1>&#39;connector&#39;</span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&#39;</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=w>    </span><span class=p>)</span><span class=w> </span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=w>    </span><span class=k>LIKE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>(</span><span class=k>EXCLUDING</span><span class=w> </span><span class=k>OPTIONS</span><span class=p>)</span>
</span></code></pre></div> <p>Groups the main stream processing and late arrival in a statement set:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=k>EXECUTE</span><span class=w> </span><span class=k>STATEMENT</span><span class=w> </span><span class=k>SET</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=k>BEGIN</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a><span class=w>    </span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>late_orders</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>CURRENT_WATERMARK</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>);</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=w>    </span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>order_counts</span><span class=w> </span><span class=c1>-- the sink table</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>window_time</span><span class=p>,</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span><span class=n>TUMBLE</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>MINUTE</span><span class=p>))</span>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=n>window_time</span>
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a><span class=k>END</span>
</span></code></pre></div> </details> <p><a href=https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/dev/table/functions/systemfunctions/ >The Flink built-in system functions.</a></p> <h3 id=joins>Joins<a class=headerlink href=#joins title="Permanent link">&para;</a></h3> <p>When doing a join, Flink needs to materialize both the right and left of the join tables fully in state, which can cost a lot of memory, because if a row in the left-hand table (LHT), also named the <strong>probe side</strong>, is updated, the operator needs to emit an updated match for all matching rows in the right-hand table (RHT) or <strong>build side</strong>. The cardinality of right side will be mostly bounded at a given point of time, but the left side may vary a lot. A join emits matching rows to downstream processing.</p> <p>Here is a list of important tutorials on Joins:</p> <ul> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/joins.html>Confluent Cloud: video on joins.</a></li> <li><a href=https://developer.confluent.io/tutorials/join-a-stream-to-a-stream/flinksql.html>Confluent -developer: How to join streams</a>. The matching content is in <a href=https://github.com/jbcodeforce/flink-studies/tree/master/flink-sql/04-joins>flink-sql/04-joins folder</a> for Confluent Cloud or Platform for Flink. This folder also includes more SQL exercises.</li> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/joins.html#temporal-joins>Confluent temporal join</a></li> <li><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/window-join.html>Window Join Queries in Confluent Cloud for Apache Flink</a></li> </ul> <details class=info open=open> <summary>Inner knowledge on temporal join</summary> <p>Event-time temporal joins are used to join two or more tables based on a <strong>common</strong> event time (in one of the record table or the kafka record: <code>$rowtime</code> system column). With an event-time attribute, the operator can retrieve the value of a key as it was at some point in the past. The right-side, versioned table, stores all versions, identified by time, since the last watermark.</p> <p>The temporal Flink sql looks like:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=k>SELECT</span><span class=w> </span><span class=p>[</span><span class=n>column_list</span><span class=p>]</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=k>FROM</span><span class=w> </span><span class=n>table1</span><span class=w> </span><span class=p>[</span><span class=k>AS</span><span class=w> </span><span class=o>&lt;</span><span class=n>alias1</span><span class=o>&gt;</span><span class=p>]</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=p>[</span><span class=k>LEFT</span><span class=p>]</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>table2</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=n>SYSTEM_TIME</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>OF</span><span class=w> </span><span class=n>table1</span><span class=p>.</span><span class=err>{</span><span class=w> </span><span class=n>rowtime</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=p>[</span><span class=k>AS</span><span class=w> </span><span class=o>&lt;</span><span class=n>alias2</span><span class=o>&gt;</span><span class=p>]</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=k>ON</span><span class=w> </span><span class=n>table1</span><span class=p>.</span><span class=k>column</span><span class=o>-</span><span class=n>name1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>table2</span><span class=p>.</span><span class=k>column</span><span class=o>-</span><span class=n>name1</span>
</span></code></pre></div> <p>When enriching a particular <code>table1</code>, an event-time temporal join waits until the watermark on the table2 stream reaches the timestamp of that <code>table1</code> row, because only then is it reasonable to be confident that the result of the join is being produced with complete knowledge of the relevant <code>table2</code> data. This table2 record can be old as the watermark on that table being late.</p> </details> <details class=info open=open> <summary>How to join two tables on a key within a time window using event column as timestamp and store results in a target table?</summary> <p>Full example:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=c1>-- use separate statements to create the tables</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>Transactions</span><span class=w> </span><span class=p>(</span><span class=n>ts</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span><span class=w> </span><span class=n>tid</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=nb>INT</span><span class=p>);</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>Payments</span><span class=w> </span><span class=p>(</span><span class=n>ts</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span><span class=w> </span><span class=n>tid</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>STRING</span><span class=p>);</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>Matched</span><span class=w> </span><span class=p>(</span><span class=n>tid</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>STRING</span><span class=p>);</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=k>execute</span><span class=w> </span><span class=k>statement</span><span class=w> </span><span class=k>set</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a><span class=k>begin</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>Transactions</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>now</span><span class=p>(),</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=mi>20</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>11</span><span class=p>,</span><span class=mi>25</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>12</span><span class=p>,</span><span class=mi>34</span><span class=p>);</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>Payments</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=n>now</span><span class=p>(),</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;debit&#39;</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>11</span><span class=p>,</span><span class=s1>&#39;debit&#39;</span><span class=p>),(</span><span class=n>now</span><span class=p>(),</span><span class=mi>12</span><span class=p>,</span><span class=s1>&#39;credit&#39;</span><span class=p>);</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>Matched</span><span class=w> </span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>tid</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>P</span><span class=p>.</span><span class=k>type</span>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>Transactions</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>Payments</span><span class=w> </span><span class=n>P</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>tid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>P</span><span class=p>.</span><span class=n>tid</span><span class=w> </span>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a><span class=w>    </span><span class=k>where</span><span class=w> </span><span class=n>P</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=k>between</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>ts</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=n>minutes</span><span class=p>;</span>
</span><span id=__span-68-14><a id=__codelineno-68-14 name=__codelineno-68-14 href=#__codelineno-68-14></a><span class=k>end</span>
</span></code></pre></div> </details> <details class=warning open=open> <summary>Join on 1x1 relationship</summary> <p>In current Flink SQL it is not possible to <em>efficiently</em> join elements from two tables when we know the relation is 1 to 1: one transaction to one account, one shipment to one order. As soon as there is a match, normally we want to emit the result and clear the state. This is possible to do so with the DataStream API, not SQL.</p> </details> <h3 id=windowing-table-value-functions>Windowing / Table Value Functions<a class=headerlink href=#windowing-table-value-functions title="Permanent link">&para;</a></h3> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/window-tvf.html>Windowing Table-Valued Functions</a> groups the Tumble, Hop, Cumulate, and Session Windows. Windows split the stream into “buckets” of finite size, over which we can implement logic. The return value adds three additional columns named “window_start”, “window_end”, “window_time” to indicate the assigned window.</p> <ul> <li>The TUMBLE function assigns each element to a window of specified window size. Tumbling windows have a fixed size and do not overlap.</li> </ul> <details class=question open=open> <summary>Count the number of different product type per 10 minutes (TUMBLE window)</summary> <p><a href=https://docs.confluent.io/cloud/current/flink/how-to-guides/aggregate-tumbling-window.html>Aggregate a Stream in a Tumbling Window documentation.</a>. The following query counts the number of different product types arriving from the event stream by interval of 10 minutes.</p> <p><div class="language-sql highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>product_type</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>product_type</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>num_ptype</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a><span class=w>        </span><span class=n>TUMBLE</span><span class=p>(</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=w>            </span><span class=k>TABLE</span><span class=w> </span><span class=n>events</span><span class=p>,</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a><span class=w>            </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a><span class=w>            </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>MINUTES</span>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=w>        </span><span class=p>)</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=p>;</span>
</span></code></pre></div> <em>DESCRIPTOR</em> indicates which time attributes column should be mapped to tumbling windows (here the kafka record ingestion timestamp). </p> <p>When the internal time has expired the results will be published. This puts an upper bound on how much state Flink needs to keep to handle a query, which in this case is related to the number of different product type. </p> <p>It is possible to use another timestamp from the input table. For example the <code>transaction_ts TIMESTAMP(3),</code> then we need to declare a watermark on this ts:</p> <p><code>WATERMARK FOR transaction_ts AS transaction_ts - INTERVAL '5' SECOND,</code> so it can be used in the descriptor function.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>app_orders</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=k>select</span><span class=w> </span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=w>    </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=w>    </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=k>sum</span><span class=p>(</span><span class=n>order_amount</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=k>from</span><span class=w> </span><span class=k>table</span><span class=p>(</span><span class=n>tumble</span><span class=p>(</span><span class=k>table</span><span class=w> </span><span class=o>`</span><span class=n>daily_spend</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=n>transaction_ts</span><span class=p>),</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;24&#39;</span><span class=w> </span><span class=n>hours</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=n>customer_id</span><span class=w> </span>
</span></code></pre></div> </details> <details class=question open=open> <summary>Aggregation over a window</summary> <p>Windows over approach is to end with the current row, and stretches backwards through the history of the stream for a specific interval, either measured in time, or by some number of rows. For example counting the umber of flight_schedule events of the same key over the last 100 events:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=k>select</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=w>    </span><span class=n>flight_id</span><span class=p>,</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=w>    </span><span class=n>evt_type</span><span class=p>,</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=w>    </span><span class=k>count</span><span class=p>(</span><span class=n>evt_type</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>number_evt</span><span class=p>,</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=k>from</span><span class=w> </span><span class=n>flight_events</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=n>window</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=k>as</span><span class=p>(</span><span class=w> </span><span class=n>partition</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>flight_id</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>between</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=n>preceding</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=k>current</span><span class=w> </span><span class=k>row</span><span class=p>);</span>
</span></code></pre></div> <p>The results are updated for every input row. The partition is by flight_id. Order by $rowtime is necessary.</p> </details> <details class=question open=open> <summary>Find the number of elements in x minutes intervals advanced by 5 minutes? (HOP)</summary> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/window-tvf.html>Confluent documentation on window integration.</a>. For <strong>HOP</strong> wuindow, there is the slide parameter to control how frequently a hopping window is started:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=w>        </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=w>        </span><span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span><span class=w> </span><span class=n>order_id</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>num_orders</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=w>        </span><span class=n>HOP</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=n>shoe_orders</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=o>`</span><span class=err>$</span><span class=n>rowtime</span><span class=o>`</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;5&#39;</span><span class=w> </span><span class=n>MINUTES</span><span class=p>,</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=n>MINUTES</span><span class=p>))</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to compute the accumulate price over time in a day (CUMULATE)</summary> <p>Needs to use the cumulate window, which adds up records to the window until max size, but emits results at each window steps. The is image summarizes well the behavior: <img alt src=https://docs.confluent.io/cloud/current/_images/flink-cumulating-windows.png></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>,</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=o>`</span><span class=k>sum</span><span class=o>`</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>TABLE</span><span class=p>(</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a><span class=w>        </span><span class=n>CUMULATE</span><span class=p>(</span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>examples</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>marketplace</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>orders</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=k>DESCRIPTOR</span><span class=p>(</span><span class=err>$</span><span class=n>rowtime</span><span class=p>),</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30&#39;</span><span class=w> </span><span class=n>SECONDES</span><span class=p>,</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w> </span><span class=n>MINUTES</span><span class=p>))</span>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>window_start</span><span class=p>,</span><span class=w> </span><span class=n>window_end</span><span class=p>;</span>
</span></code></pre></div> </details> <h3 id=row-pattern-recognition>Row pattern recognition<a class=headerlink href=#row-pattern-recognition title="Permanent link">&para;</a></h3> <details class=question open=open> <summary>Find the longest period of time for which the average price of a stock did not go below a value</summary> <p>Create a Datagen to publish StockTicker to a Kafka topic. <a href=https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/dev/table/sql/queries/match_recognize/ >See product documentation on CEP pattern with SQL</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>StockTicker</span><span class=p>(</span><span class=n>symbol</span><span class=w> </span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=n>tax</span><span class=w> </span><span class=nb>int</span><span class=p>)</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;connector&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;kafka&#39;</span><span class=p>,...)</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>From</span><span class=w> </span><span class=n>StockTicker</span><span class=w> </span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=n>MATCH_RECOGNIZE</span><span class=w> </span><span class=p>(</span><span class=w> </span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=w>    </span><span class=n>partition</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>symbol</span><span class=w> </span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=w>    </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>rowtime</span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=w>    </span><span class=n>measures</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=w>        </span><span class=k>FIRST</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>rowtime</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>start_tstamp</span><span class=p>,</span>
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a><span class=w>        </span><span class=k>LAST</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>rowtime</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>last_tstamp</span><span class=p>,</span>
</span><span id=__span-74-9><a id=__codelineno-74-9 name=__codelineno-74-9 href=#__codelineno-74-9></a><span class=w>        </span><span class=k>AVG</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avgPrice</span>
</span><span id=__span-74-10><a id=__codelineno-74-10 name=__codelineno-74-10 href=#__codelineno-74-10></a><span class=w>    </span><span class=n>ONE</span><span class=w> </span><span class=k>ROW</span><span class=w> </span><span class=n>PER</span><span class=w> </span><span class=k>MATCH</span>
</span><span id=__span-74-11><a id=__codelineno-74-11 name=__codelineno-74-11 href=#__codelineno-74-11></a><span class=w>    </span><span class=k>AFTER</span><span class=w> </span><span class=k>MATCH</span><span class=w> </span><span class=n>SKIP</span><span class=w> </span><span class=n>PAST</span><span class=w> </span><span class=k>LAST</span><span class=w> </span><span class=k>ROW</span>
</span><span id=__span-74-12><a id=__codelineno-74-12 name=__codelineno-74-12 href=#__codelineno-74-12></a><span class=w>    </span><span class=n>PATTERN</span><span class=w> </span><span class=p>(</span><span class=n>A</span><span class=o>+</span><span class=w> </span><span class=n>B</span><span class=p>)</span>
</span><span id=__span-74-13><a id=__codelineno-74-13 name=__codelineno-74-13 href=#__codelineno-74-13></a><span class=w>    </span><span class=n>DEFINE</span>
</span><span id=__span-74-14><a id=__codelineno-74-14 name=__codelineno-74-14 href=#__codelineno-74-14></a><span class=w>        </span><span class=n>A</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>15</span>
</span><span id=__span-74-15><a id=__codelineno-74-15 name=__codelineno-74-15 href=#__codelineno-74-15></a><span class=p>);</span>
</span></code></pre></div> <p>MATCH_RECOGNIZE helps to logically partition and order the data that is used with the PARTITION BY and ORDER BY clauses, then defines patterns of rows to seek using the PATTERN clause. The logical components of the row pattern variables are specified in the DEFINE clause. B is defined implicitly as not being A.</p> </details> <h3 id=confluent-cloud-specific>Confluent Cloud Specific<a class=headerlink href=#confluent-cloud-specific title="Permanent link">&para;</a></h3> <p><a href=https://docs.confluent.io/cloud/current/flink/reference/queries/overview.html>See Flink Confluent Cloud queries documentation.</a></p> <p>Each topic is automatically mapped to a table with some metadata fields added, like the watermark in the form of <code>$rowtime</code> field, which is mapped to the Kafka record timestamp. To see it, run <code>describe extended table_name;</code> With watermarking. arriving event records will be ingested roughly in order with respect to the <code>$rowtime</code> time attribute field.</p> <details class=question open=open> <summary>Mapping from Kafka record timestamp and table $rowtime</summary> <p>The Kafka record timestamp is automatically mapped to the <code>$rowtime</code> attribute, which is a read only field. Using this field we can order the record by arrival time:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=k>select</span><span class=w> </span><span class=s1>&#39;flight_id&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;aircraft_id&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;status&#39;</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a><span class=k>from</span><span class=w> </span><span class=n>Aircrafts</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>rowtime</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>How to run Confluent Cloud for Flink?</summary> <p>See <a href=../../techno/ccloud-flink/ >the note</a>, but can be summarized as: 1/ create a stream processing compute pool in the same environment and region as the Kafka cluster, 2/ use Console or CLI (flink shell) to interact with topics.</p> <p><img alt src=../../techno/diagrams/ccloud-flink.drawio.png></p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a>confluent<span class=w> </span>flink<span class=w> </span>quickstart<span class=w> </span>--name<span class=w> </span>my-flink-sql<span class=w> </span>--max-cfu<span class=w> </span><span class=m>10</span><span class=w> </span>--region<span class=w> </span>us-west-2<span class=w> </span>--cloud<span class=w> </span>aws
</span></code></pre></div> </details> <details class=question open=open> <summary>Running Confluent Cloud Kafka with local Flink</summary> <p>The goal is to demonstrate how to get a cluster created in an existing Confluent Cloud environment and then send message via FlinkFaker using local table to Kafka topic:</p> <p><img alt src=../diagrams/flaker-to-kafka.drawio.png></p> <p>The <a href=https://github.com/jbcodeforce/flink-studies/tree/master/flink-sql/01-confluent-kafka-local-flink>scripts and readme</a> .</p> </details> <details class=question open=open> <summary>Reading from a topic specific offsets</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=w>    </span><span class=s1>&#39;scan.startup.mode&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;specific-offsets&#39;</span><span class=p>,</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=w>    </span><span class=s1>&#39;scan.startup.specific-offsets&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;partition:0,offset:25; partition:1,offset:10&#39;</span>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a><span class=p>);</span>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a><span class=c1>-- Returns from offsets 26 and 11</span>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>table_name</span><span class=p>;</span>
</span></code></pre></div> </details> <details class=question open=open> <summary>create a long running SQL with cli</summary> <p>Get or create a service account.</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>confluent<span class=w> </span>iam<span class=w> </span>service-account<span class=w> </span>create<span class=w> </span>my-service-account<span class=w> </span>--description<span class=w> </span><span class=s2>&quot;new description&quot;</span>
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a>confluent<span class=w> </span>iam<span class=w> </span>service-account<span class=w> </span>list
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a>confluent<span class=w> </span>iam<span class=w> </span>service-account<span class=w> </span>describe<span class=w> </span>&lt;id_of_the_sa&gt;
</span></code></pre></div> <div class="language-sh highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a>confluent<span class=w> </span>flink<span class=w> </span>statement<span class=w> </span>create<span class=w> </span>my-statement<span class=w> </span>--sql<span class=w> </span><span class=s2>&quot;SELECT * FROM my-topic;&quot;</span><span class=w> </span>--compute-pool<span class=w> </span>&lt;compute_pool_id&gt;<span class=w> </span>--service-account<span class=w> </span>sa-123456<span class=w> </span>--database<span class=w> </span>my-cluster
</span></code></pre></div> </details> <details class=question open=open> <summary>Assess the current flink statement running in Confluent Cloud</summary> <p>To assess which jobs are still running, which jobs failed, and which stopped, we can use the user interface, go to the Flink console &gt; . Or the <code>confluent</code> CLI:</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a>confluent<span class=w> </span>environment<span class=w> </span>list
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a>confluent<span class=w> </span>flink<span class=w> </span>compute-pool<span class=w> </span>list
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a>confluent<span class=w> </span>flink<span class=w> </span>statement<span class=w> </span>list<span class=w> </span>--cloud<span class=w> </span>aws<span class=w> </span>--region<span class=w> </span>us-west-2<span class=w> </span>--environment<span class=w> </span>&lt;your<span class=w> </span>env-id&gt;<span class=w> </span>--compute-pool<span class=w> </span>&lt;your<span class=w> </span>pool<span class=w> </span>id&gt;
</span></code></pre></div> </details> <h3 id=from-batch-to-real-time>From batch to real-time<a class=headerlink href=#from-batch-to-real-time title="Permanent link">&para;</a></h3> <details class=info open=open> <summary>How to support Type 2 slowly changing dimension (SCD) table?</summary> <p>Type 2 SCDs are designed to maintain a complete history of all changes to dimension data. When a change occurs, a new row is inserted into the table, representing the updated record, while the original record remains untouched. Each record in the table is typically assigned a unique identifier (often a surrogate key) to distinguish between different versions of the same dimension member. </p> </details> <h2 id=user-defined-function>User Defined Function<a class=headerlink href=#user-defined-function title="Permanent link">&para;</a></h2> <p><a href=https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/functions/udfs/ >Flink User Defined Function</a> allows developers to upload custom logic, complex calculation, data manipulation (XML, custom AVRO), within a SQL or TableAPI queries. Developers can leverage existing libraries like Geospatial calculation, Math computation... At the deployment level it can be considered as FaaS. Not optimized for cold start, it could be P90 at 25s. </p> <p>For developer the steps are:</p> <ol> <li>Develop a functin to extends a <code>org.apache.flink.table.functions.ScalarFunction</code></li> <li>Build a uber jar</li> <li>Register the UDF as a Flink artifact. On Confluent Cloud, artifacts are environment scoped.</li> <li>Configure SQL to use this function using: `CREATE FUNCTION fct_name as 'fully.qualified.classname' USING JAR 'confluent-artifact://....'</li> </ol> <h2 id=troubleshooting-sql-statement-running-slow>Troubleshooting SQL statement running slow<a class=headerlink href=#troubleshooting-sql-statement-running-slow title="Permanent link">&para;</a></h2> <details class=info open=open> <summary>How to search for hot key?</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a><span class=w>    </span><span class=n>id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a><span class=w>    </span><span class=n>tenant_id</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a><span class=w>    </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>record_count</span><span class=p>,</span>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a><span class=k>FROM</span><span class=w> </span><span class=k>table_name</span><span class=w> </span>
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>tenant_id</span>
</span></code></pre></div> <p>A more advanced statistical query ( TO BE TESTED) <div class="language-sql highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=k>WITH</span><span class=w> </span><span class=n>key_stats</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a><span class=w>        </span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=w>        </span><span class=n>tenant_id</span><span class=p>,</span>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a><span class=w>        </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>record_count</span>
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>src_aqem_tag_tag</span><span class=w> </span>
</span><span id=__span-82-7><a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>tenant_id</span>
</span><span id=__span-82-8><a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a><span class=p>),</span>
</span><span id=__span-82-9><a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a><span class=n>distribution_stats</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-82-10><a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-82-11><a id=__codelineno-82-11 name=__codelineno-82-11 href=#__codelineno-82-11></a><span class=w>        </span><span class=k>AVG</span><span class=p>(</span><span class=n>record_count</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>mean_count</span><span class=p>,</span>
</span><span id=__span-82-12><a id=__codelineno-82-12 name=__codelineno-82-12 href=#__codelineno-82-12></a><span class=w>        </span><span class=n>STDDEV</span><span class=p>(</span><span class=n>record_count</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>stddev_count</span><span class=p>,</span>
</span><span id=__span-82-13><a id=__codelineno-82-13 name=__codelineno-82-13 href=#__codelineno-82-13></a><span class=w>        </span><span class=n>PERCENTILE_APPROX</span><span class=p>(</span><span class=n>record_count</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>75</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>q3</span><span class=p>,</span>
</span><span id=__span-82-14><a id=__codelineno-82-14 name=__codelineno-82-14 href=#__codelineno-82-14></a><span class=w>        </span><span class=n>PERCENTILE_APPROX</span><span class=p>(</span><span class=n>record_count</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>95</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>p95</span><span class=p>,</span>
</span><span id=__span-82-15><a id=__codelineno-82-15 name=__codelineno-82-15 href=#__codelineno-82-15></a><span class=w>        </span><span class=n>PERCENTILE_APPROX</span><span class=p>(</span><span class=n>record_count</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>99</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>p99</span>
</span><span id=__span-82-16><a id=__codelineno-82-16 name=__codelineno-82-16 href=#__codelineno-82-16></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>key_stats</span>
</span><span id=__span-82-17><a id=__codelineno-82-17 name=__codelineno-82-17 href=#__codelineno-82-17></a><span class=p>)</span>
</span><span id=__span-82-18><a id=__codelineno-82-18 name=__codelineno-82-18 href=#__codelineno-82-18></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-82-19><a id=__codelineno-82-19 name=__codelineno-82-19 href=#__codelineno-82-19></a><span class=w>    </span><span class=n>ks</span><span class=p>.</span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-82-20><a id=__codelineno-82-20 name=__codelineno-82-20 href=#__codelineno-82-20></a><span class=w>    </span><span class=n>ds</span><span class=p>.</span><span class=n>mean_count</span><span class=p>,</span>
</span><span id=__span-82-21><a id=__codelineno-82-21 name=__codelineno-82-21 href=#__codelineno-82-21></a><span class=w>    </span><span class=n>ds</span><span class=p>.</span><span class=n>stddev_count</span><span class=p>,</span>
</span><span id=__span-82-22><a id=__codelineno-82-22 name=__codelineno-82-22 href=#__codelineno-82-22></a><span class=w>    </span><span class=c1>-- Z-score calculation for outlier detection</span>
</span><span id=__span-82-23><a id=__codelineno-82-23 name=__codelineno-82-23 href=#__codelineno-82-23></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-82-24><a id=__codelineno-82-24 name=__codelineno-82-24 href=#__codelineno-82-24></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>stddev_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span>
</span><span id=__span-82-25><a id=__codelineno-82-25 name=__codelineno-82-25 href=#__codelineno-82-25></a><span class=w>        </span><span class=k>THEN</span><span class=w> </span><span class=p>(</span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>mean_count</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>stddev_count</span>
</span><span id=__span-82-26><a id=__codelineno-82-26 name=__codelineno-82-26 href=#__codelineno-82-26></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-82-27><a id=__codelineno-82-27 name=__codelineno-82-27 href=#__codelineno-82-27></a><span class=w>    </span><span class=k>END</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>z_score</span><span class=p>,</span>
</span><span id=__span-82-28><a id=__codelineno-82-28 name=__codelineno-82-28 href=#__codelineno-82-28></a><span class=w>    </span><span class=c1>-- Hot key classification</span>
</span><span id=__span-82-29><a id=__codelineno-82-29 name=__codelineno-82-29 href=#__codelineno-82-29></a><span class=w>    </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-82-30><a id=__codelineno-82-30 name=__codelineno-82-30 href=#__codelineno-82-30></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>p99</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;EXTREME_HOT&#39;</span>
</span><span id=__span-82-31><a id=__codelineno-82-31 name=__codelineno-82-31 href=#__codelineno-82-31></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>p95</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;VERY_HOT&#39;</span>
</span><span id=__span-82-32><a id=__codelineno-82-32 name=__codelineno-82-32 href=#__codelineno-82-32></a><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>q3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>5</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;HOT&#39;</span>
</span><span id=__span-82-33><a id=__codelineno-82-33 name=__codelineno-82-33 href=#__codelineno-82-33></a><span class=w>        </span><span class=k>ELSE</span><span class=w> </span><span class=s1>&#39;NORMAL&#39;</span>
</span><span id=__span-82-34><a id=__codelineno-82-34 name=__codelineno-82-34 href=#__codelineno-82-34></a><span class=w>    </span><span class=k>END</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>hot_key_category</span>
</span><span id=__span-82-35><a id=__codelineno-82-35 name=__codelineno-82-35 href=#__codelineno-82-35></a><span class=k>FROM</span><span class=w> </span><span class=n>key_stats</span><span class=w> </span><span class=n>ks</span>
</span><span id=__span-82-36><a id=__codelineno-82-36 name=__codelineno-82-36 href=#__codelineno-82-36></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>distribution_stats</span><span class=w> </span><span class=n>ds</span>
</span><span id=__span-82-37><a id=__codelineno-82-37 name=__codelineno-82-37 href=#__codelineno-82-37></a><span class=k>WHERE</span><span class=w> </span><span class=n>ks</span><span class=p>.</span><span class=n>record_count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=n>mean_count</span><span class=w> </span>
</span></code></pre></div></p> </details> <h3 id=metric-to-consider>Metric to consider<a class=headerlink href=#metric-to-consider title="Permanent link">&para;</a></h3> <h3 id=explain-statement>Explain statement<a class=headerlink href=#explain-statement title="Permanent link">&para;</a></h3> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../architecture/flink-sql/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Flink SQL concepts"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Flink SQL concepts </div> </div> </a> <a href=../firstapp/ class="md-footer__link md-footer__link--next" aria-label="Next: First Java Apps"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> First Java Apps </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2018 - 2025 Jerome Boyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jbcodeforce target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/jeromeboyer target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M536.4-26.3c9.8-3.5 20.6-1 28 6.3s9.8 18.2 6.3 28l-178 496.9c-5 13.9-18.1 23.1-32.8 23.1-14.2 0-27-8.6-32.3-21.7l-64.2-158c-4.5-11-2.5-23.6 5.2-32.6l94.5-112.4c5.1-6.1 4.7-15-.9-20.6s-14.6-6-20.6-.9l-112.4 94.3c-9.1 7.6-21.6 9.6-32.6 5.2L38.1 216.8c-13.1-5.3-21.7-18.1-21.7-32.3 0-14.7 9.2-27.8 23.1-32.8z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotation", "content.code.copy", "content.tooltips", "content.tabs.link", "search.suggest", "search.highlight", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.f55a23d4.min.js></script> </body> </html>