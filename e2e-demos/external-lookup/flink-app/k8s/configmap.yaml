apiVersion: v1
kind: ConfigMap
metadata:
  name: payment-claims-enrichment-config
  namespace: el-demo
  labels:
    app: payment-claims-enrichment
    component: config
data:
  # Kafka Configuration
  kafka.bootstrap.servers: "kafka.confluent:9071"
  kafka.payment.events.topic: "payment-events"
  kafka.enriched.payments.topic: "enriched-payments"
  kafka.failed.payments.topic: "failed-payments"
  
  # PostgreSQL Configuration
  postgres.url: "jdbc:postgresql://claims-db:5432/claims"
  postgres.driver: "org.postgresql.Driver"
  postgres.user: "${POSTGRES_USER}"
  postgres.password: "${POSTGRES_PASSWORD}"
  
  # Flink Configuration
  flink.parallelism: "2"
  flink.checkpoint.interval: "60s"
  flink.checkpoint.mode: "EXACTLY_ONCE"
  
  # Table API Configuration
  table.exec.source.idle-timeout: "30s"
  table.exec.async-lookup.buffer-capacity: "1000"
  table.exec.async-lookup.timeout: "5s"
  table.optimizer.join-reorder-enabled: "true"
  
  # Lookup Cache Configuration
  lookup.cache: "LRU"
  lookup.cache.max-rows: "10000"
  lookup.cache.ttl: "1min"
  lookup.async: "true"
  lookup.max-retries: "3"
  
  # Application Configuration
  app.name: "Payment Claims Enrichment"
  app.version: "1.0.0"
  log.level: "INFO"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-config
  namespace: flink
  labels:
    app: payment-claims-enrichment
    component: flink-config
data:
  flink-conf.yaml: |
    # Flink Configuration for Payment Claims Enrichment
    jobmanager.rpc.address: flink-jobmanager
    jobmanager.rpc.port: 6123
    jobmanager.memory.process.size: 1600m
    taskmanager.memory.process.size: 1728m
    taskmanager.numberOfTaskSlots: 2
    parallelism.default: 1
    
    # Checkpointing
    execution.checkpointing.interval: 60s
    execution.checkpointing.mode: EXACTLY_ONCE
    execution.checkpointing.timeout: 10min
    execution.checkpointing.max-concurrent-checkpoints: 1
    
    # State Backend
    state.backend: rocksdb
    state.checkpoints.dir: file:///opt/flink/checkpoints
    state.savepoints.dir: file:///opt/flink/savepoints
    
    # Restart Strategy
    restart-strategy: failure-rate
    restart-strategy.failure-rate.max-failures-per-interval: 3
    restart-strategy.failure-rate.failure-rate-interval: 5 min
    restart-strategy.failure-rate.delay: 10 s
    
    # Metrics
    metrics.reporters: prom
    metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
    metrics.reporter.prom.host: localhost
    metrics.reporter.prom.port: 9249
    
    # Network
    taskmanager.network.memory.fraction: 0.1
    taskmanager.network.memory.min: 64mb
    taskmanager.network.memory.max: 1gb

  log4j-console.properties: |
    # Flink Logging Configuration
    log4j.rootLogger=INFO, console
    log4j.logger.akka=INFO
    log4j.logger.org.apache.kafka=INFO
    log4j.logger.org.apache.hadoop=WARN
    log4j.logger.org.apache.zookeeper=WARN
    log4j.logger.com.example=INFO
    
    # Console Appender
    log4j.appender.console=org.apache.log4j.ConsoleAppender
    log4j.appender.console.layout=org.apache.log4j.PatternLayout
    log4j.appender.console.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
    
    # Suppress the irrelevant (wrong) warnings from the Netty channel handler
    log4j.logger.org.jboss.netty.channel.DefaultChannelPipeline=ERROR, console